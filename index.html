<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Control de Pagos Andreli</title>
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#00684A">
    <meta name="application-name" content="Pagos Andreli">
    <meta name="format-detection" content="telephone=no">
    <meta name="msapplication-tap-highlight" content="no">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icon-192.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #00684A; --secondary-color: #00583E; --accent-color: #FFC107; --danger-color: #e74c3c; --success-color: #2ecc71; --warning-color: #f39c12; --light-gray: #f7f9fa; --medium-gray: #e0e0e0; --dark-gray: #555; --text-color: #333; --white: #ffffff; --shadow: 0 4px 15px rgba(0, 0, 0, 0.08); --border-radius: 12px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Poppins', 'Roboto', sans-serif; background-color: var(--light-gray); color: var(--text-color); min-height: 100vh; -webkit-font-smoothing: antialiased; overflow-x: hidden; }
        .header { background: var(--primary-color); color: var(--white); padding: 20px; display: flex; align-items: center; justify-content: center; gap: 15px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
        .header .logo { font-size: 28px; font-weight: 700; }
        .header h1 { font-size: 22px; font-weight: 600; }
        .container { padding: 16px; max-width: 700px; margin: 0 auto; padding-bottom: 80px; }
        .card { background: var(--white); border-radius: var(--border-radius); padding: 20px; margin-bottom: 20px; box-shadow: var(--shadow); border: 1px solid #eef2f5; }
        .section-title { font-size: 18px; font-weight: 600; margin-bottom: 15px; color: var(--primary-color); display: flex; align-items: center; gap: 8px; }
        .section-title svg { width: 20px; height: 20px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; }
        .stat-item { text-align: center; padding: 10px; background: var(--light-gray); border-radius: 8px; }
        .stat-value { font-size: 24px; font-weight: 700; color: var(--primary-color); }
        .stat-label { font-size: 13px; color: var(--dark-gray); margin-top: 5px; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; border: none; padding: 12px 20px; border-radius: 8px; font-size: 15px; font-weight: 600; font-family: 'Poppins', sans-serif; cursor: pointer; transition: all 0.25s ease; -webkit-appearance: none; appearance: none; touch-action: manipulation; }
        .btn:active { transform: scale(0.97); }
        .btn-primary { background-color: var(--primary-color); color: var(--white); }
        .btn-primary:hover { background-color: var(--secondary-color); box-shadow: 0 6px 20px rgba(0, 104, 74, 0.2); }
        .btn-secondary { background-color: var(--medium-gray); color: var(--dark-gray); }
        .btn-danger { background-color: var(--danger-color); color: var(--white); }
        .btn-morosidad { background: var(--warning-color); color: var(--white); }
        .button-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .button-row .btn { width: 100%; padding: 15px; }
        .form-group { margin-bottom: 20px; position: relative; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 500; font-size: 14px; }
        .form-input { width: 100%; padding: 12px 15px; border: 1px solid var(--medium-gray); border-radius: 8px; font-size: 16px; font-family: 'Poppins', sans-serif; transition: border-color 0.2s, box-shadow 0.2s; background-color: var(--white); }
        .form-input:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(0, 104, 74, 0.1); }
        input[type="date"] { min-height: 48px; }
        .clients-container, .payments-container, .search-results { max-height: 400px; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .client-item { padding: 15px; border-bottom: 1px solid var(--light-gray); cursor: pointer; transition: all 0.2s ease; display: flex; justify-content: space-between; align-items: center; }
        .client-item:last-child { border-bottom: none; }
        .client-name { font-weight: 600; font-size: 16px; }
        .client-info-sub { font-size: 13px; color: var(--dark-gray); display: flex; align-items: center; flex-wrap: wrap; gap: 10px; margin-top: 8px; }
        .client-status { font-size: 12px; padding: 4px 10px; border-radius: 20px; font-weight: 500; }
        .status-paid { background: #eafaf1; color: #2ecc71; }
        .status-pending { background: #fef5e7; color: #f39c12; }
        .btn-circle { width: 40px; height: 40px; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; font-size: 18px; cursor: pointer; transition: all 0.2s; background: var(--light-gray); color: var(--dark-gray); }
        .btn-circle.pay { background: #eafaf1; color: var(--success-color); }
        .debt-indicator { width: 10px; height: 10px; background-color: var(--danger-color); border-radius: 50%; animation: pulse-danger 1.5s infinite; }
        @keyframes pulse-danger { 0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(231, 76, 60, 0); } 100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); } }
        .debt-clients-container { background: #fdedec; border: 1px solid #f5b7b1; }
        .frequency-badge { display: inline-block; padding: 3px 9px; border-radius: 15px; font-size: 11px; font-weight: 500; text-transform: uppercase; }
        .freq-diario { background: #e8f5e9; color: #2e7d32; } .freq-semanal { background: #e3f2fd; color: #1565c0; } .freq-quincenal { background: #fce4ec; color: #c2185b; } .freq-mensual { background: #f3e5f5; color: #7b1fa2; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); z-index: 1000; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn{from{opacity:0}to{opacity:1}}
        .modal.show { display: flex; justify-content: center; align-items: center; }
        .modal-content { background: var(--white); padding: 25px; width: 92%; max-width: 500px; border-radius: var(--border-radius); animation: slideIn 0.3s ease-out; max-height: 85vh; overflow-y: auto; }
        @keyframes slideIn { from { transform: translateY(-30px) scale(0.95); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-title { font-size: 20px; font-weight: 600; color: var(--primary-color); }
        .close-btn { font-size: 28px; cursor: pointer; color: #999; background: none; border: none; line-height: 1; }
        .date-filter { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 10px; background: var(--white); border-radius: var(--border-radius); box-shadow: var(--shadow); }
        .date-filter .form-input { width: auto; border: none; background: transparent; }
        .date-filter .form-input:focus { box-shadow: none; }
        .date-filter-buttons { display: flex; gap: 10px; }
        .search-container { position: relative; } .search-input { padding-left: 40px; }
        .search-container .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--dark-gray); pointer-events: none; }
        .client-detail-info { padding: 15px; border-radius: 8px; border: 1px solid var(--medium-gray); margin-bottom: 20px; }
        .detail-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e9ecef; font-size: 14px; }
        .detail-row:last-child { border-bottom: none; }
        .detail-label { font-weight: 500; color: var(--dark-gray); } .detail-value { font-weight: 600; }
        .action-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; padding-top: 20px; border-top: 1px solid #e9ecef; }
        .btn-action { padding: 10px; border-radius: 8px; font-size: 14px; }
        .btn-call { background: #3498db; color: white; } .btn-whatsapp { background: #25D366; color: white; } .btn-schedule { background: #9b59b6; color: white; } .btn-movements { background: #34495e; color: white; } .btn-edit-client { background: #f39c12; color: white; } .btn-delete-client { background: #e74c3c; color: white; }
        .payment-type-selector { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .payment-type-btn { padding: 15px; border: 2px solid var(--medium-gray); background: var(--white); border-radius: 10px; cursor: pointer; text-align: center; transition: all 0.2s; }
        .payment-type-btn.active { background: var(--primary-color); color: var(--white); border-color: var(--primary-color); }
        .payment-type-btn .icon { font-size: 24px; margin-bottom: 8px; } .payment-type-btn .label { font-size: 14px; font-weight: 500; }
        .payment-item { padding: 15px; border-bottom: 1px solid var(--light-gray); }
        .payment-client { font-weight: 600; display: flex; justify-content: space-between; align-items: center; }
        .payment-details { display: flex; justify-content: space-between; margin-top: 5px; font-size: 14px; color: var(--dark-gray); }
        .payment-amount { color: var(--success-color); font-weight: 700; font-size: 16px; }
        .payment-method { display: inline-block; padding: 3px 8px; border-radius: 6px; font-size: 12px; font-weight: 500; }
        .method-efectivo { background: #e8f5e9; color: #2e7d32; } .method-yape { background: #e3f2fd; color: #1565c0; } .method-mixto { background: #fff3cd; color: #856404; }
        .responsive-table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .styled-table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
        .styled-table th, .styled-table td { padding: 12px 15px; border: 1px solid var(--medium-gray); text-align: left; }
        .styled-table th { background-color: var(--primary-color); color: var(--white); font-weight: 600; white-space: nowrap; }
        .styled-table tbody tr:nth-of-type(even) { background-color: var(--light-gray); }
        #morosidadModal .modal-content, #scheduleModal .modal-content { max-width: 95%; width: auto; }
        .install-banner{ display:none; background: var(--primary-color); color:white; padding:16px; margin-bottom: 16px; border-radius:12px; box-shadow:0 4px 12px rgba(0, 104, 74, 0.3); align-items:center; gap:12px }
        .install-banner.show{display:flex}
        .install-banner-text{flex:1} .install-banner-text h3{font-size:16px;margin-bottom:4px} .install-banner-text p{font-size:14px;opacity:0.9}
        .btn-install{ background:white; color:var(--primary-color); padding:10px 20px; border:none; border-radius:8px; font-weight:600; cursor:pointer; white-space:nowrap }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo">A</div>
        <h1>Control de Pagos Andreli</h1>
    </header>

    <main class="container">
        <div id="installBanner" class="install-banner">
            <div class="install-banner-text">
                <h3>Instalar Pagos Andreli</h3>
                <p>Accede más rápido desde tu pantalla de inicio.</p>
            </div>
            <button class="btn-install" onclick="installPWA()">Instalar</button>
        </div>

        <div class="date-filter">
            <div>
                <input type="date" id="dateFilter" class="form-input">
            </div>
            <div class="date-filter-buttons">
                <button class="btn btn-secondary" onclick="setToday()">Hoy</button>
                <button class="btn btn-secondary" onclick="document.getElementById('excelUpload').click()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.884 6.68a.5.5 0 1 0-.768.64L7.349 10l-2.233 2.68a.5.5 0 0 0 .768.64L8 10.781l2.116 2.54a.5.5 0 0 0 .768-.64L8.651 10l2.233-2.68a.5.5 0 0 0-.768-.64L8 9.219l-2.116-2.54z"/><path d="M4 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2zm0 1h8a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1"/></svg>
                    <span>Excel</span>
                </button>
                <input type="file" id="excelUpload" accept=".xlsx,.xls" style="display:none;" onchange="handleExcelUpload(event)">
            </div>
        </div>

        <div class="card">
            <h2 class="section-title">Resumen del Día</h2>
            <div class="stats-grid">
                <div class="stat-item"><div class="stat-value" id="totalPaid">S/0.00</div><div class="stat-label">Total Recibido</div></div>
                <div class="stat-item"><div class="stat-value" id="clientsPaid">0</div><div class="stat-label">Clientes Pagaron</div></div>
                <div class="stat-item"><div class="stat-value" id="totalCash">S/0.00</div><div class="stat-label">💵 Efectivo</div></div>
                <div class="stat-item"><div class="stat-value" id="totalYape">S/0.00</div><div class="stat-label">📱 Yape</div></div>
            </div>
        </div>

        <div class="card">
             <h2 class="section-title">Buscar Cliente</h2>
            <div class="search-container">
                <input type="text" class="form-input search-input" id="generalClientSearch" placeholder="Buscar por nombre, ID o teléfono..." onkeyup="searchAllClients()">
            </div>
            <div id="searchResults" class="search-results" style="display:none;"></div>
        </div>

        <div class="button-row">
            <button class="btn btn-primary" onclick="showAddClientModal()">➕ Agregar Cliente</button>
            <button class="btn btn-primary" onclick="showAddPaymentModal()">💰 Registrar Pago</button>
        </div>
        <div class="button-row">
            <button class="btn btn-morosidad" onclick="showMorosidadModal()">⚠️ Ver Morosidad</button>
            <button class="btn btn-danger" onclick="deleteAllClients()">🗑️ Eliminar Todos</button>
        </div>

        <div class="card debt-clients-container" id="debtClientsSection" style="display:none;">
            <h2 class="section-title" style="color: var(--danger-color);"><span class="debt-indicator"></span>Clientes en Mora</h2>
            <div class="clients-container" id="debtClientsContainer"><div id="debtClientsList"></div></div>
        </div>

        <div class="card">
            <h2 class="section-title">Clientes del Día</h2>
            <div class="clients-container" id="clientsContainer"><div id="clientsList"></div></div>
        </div>

        <div class="card">
            <h2 class="section-title">Pagos del Día</h2>
            <div class="payments-container" id="paymentsContainer"><div id="paymentsList"></div></div>
        </div>
    </main>

    <!-- Modales -->
    <div id="addClientModal" class="modal"><div class="modal-content">
        <div class="modal-header"><h3 class="modal-title">Agregar Cliente</h3><button class="close-btn" onclick="closeModal('addClientModal')">&times;</button></div>
        <form onsubmit="addClient(event)">
            <div class="form-group"><label class="form-label">ID del Cliente</label><input type="text" class="form-input" id="clientId" required></div>
            <div class="form-group"><label class="form-label">Nombre del Cliente</label><input type="text" class="form-input" id="clientName" required></div>
            <div class="form-group"><label class="form-label">Teléfono (opcional)</label><input type="tel" class="form-input" id="clientPhone"></div>
            <div class="form-group"><label class="form-label">Fecha de Desembolso</label><input type="date" class="form-input" id="clientDisbursementDate" required></div>
            <div class="form-group"><label class="form-label">Frecuencia de Pago</label><select class="form-input" id="clientFrequency" required><option value="">Seleccionar...</option><option value="DIARIO">Diario</option><option value="SEMANAL">Semanal</option><option value="QUINCENAL">Quincenal</option><option value="MENSUAL">Mensual</option></select></div>
            <div class="form-group"><label class="form-label">Monto de Cuota</label><input type="number" class="form-input" id="clientQuota" step="0.01" required></div>
            <div class="form-group"><label class="form-label">Plazo (n° de cuotas)</label><input type="number" class="form-input" id="clientTerm" min="1" required></div>
            <button type="submit" class="btn btn-primary" style="width:100%;">Agregar Cliente</button>
        </form>
    </div></div>
    <div id="editClientModal" class="modal"><div class="modal-content">
        <div class="modal-header"><h3 class="modal-title">Modificar Cliente</h3><button class="close-btn" onclick="closeModal('editClientModal')">&times;</button></div>
        <form onsubmit="updateClient(event)">
            <input type="hidden" id="editClientId">
            <div class="form-group"><label class="form-label">Nombre</label><input type="text" class="form-input" id="editClientName" required></div>
            <div class="form-group"><label class="form-label">Teléfono</label><input type="tel" class="form-input" id="editClientPhone"></div>
            <div class="form-group"><label class="form-label">Fecha Desembolso</label><input type="date" class="form-input" id="editClientDisbursementDate" required></div>
            <div class="form-group"><label class="form-label">Frecuencia</label><select class="form-input" id="editClientFrequency" required><option value="">Seleccionar...</option><option value="DIARIO">Diario</option><option value="SEMANAL">Semanal</option><option value="QUINCENAL">Quincenal</option><option value="MENSUAL">Mensual</option></select></div>
            <div class="form-group"><label class="form-label">Monto Cuota</label><input type="number" class="form-input" id="editClientQuota" step="0.01" required></div>
            <div class="form-group"><label class="form-label">Plazo</label><input type="number" class="form-input" id="editClientTerm" min="1" required></div>
            <button type="submit" class="btn btn-primary" style="width:100%;">Guardar Cambios</button>
        </form>
    </div></div>
    <div id="addPaymentModal" class="modal"><div class="modal-content">
        <div class="modal-header"><h3 class="modal-title">Registrar Pago</h3><button class="close-btn" onclick="closeModal('addPaymentModal')">&times;</button></div>
        <form onsubmit="addPayment(event)">
            <div class="form-group"><label class="form-label">Cliente</label><input type="text" class="form-input" id="clientSearchModal" placeholder="Buscar cliente..." autocomplete="off" onkeyup="filterModalClients()" onfocus="showClientDropdown()" required><input type="hidden" id="selectedClientId" required><div id="clientDropdown" class="search-results" style="position:absolute; width: 100%; z-index: 1001; display:none;"></div></div>
            <div class="form-group"><label class="form-label">Tipo de Pago</label><div class="payment-type-selector"><div class="payment-type-btn" onclick="selectPaymentType('efectivo')"><div class="icon">💵</div><div class="label">Efectivo</div></div><div class="payment-type-btn" onclick="selectPaymentType('yape')"><div class="icon">📱</div><div class="label">Yape</div></div><div class="payment-type-btn" onclick="selectPaymentType('parcial')"><div class="icon">💰</div><div class="label">Parcial</div></div></div></div>
            <div id="paymentInputsContainer" style="display:none;"><div id="singlePaymentInputs" style="display:none;"><div class="form-group"><label class="form-label" id="singlePaymentLabel">Monto</label><input type="number" class="form-input" id="paymentAmountSingle" step="0.01" min="0"></div></div><div id="partialPaymentInputs" style="display:none;"><div style="background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:20px;"><div class="form-group" style="margin-bottom:15px;"><label class="form-label">💵 Monto Efectivo</label><input type="number" class="form-input" id="paymentAmountCash" step="0.01" value="0" min="0" onkeyup="updatePaymentTotal()"></div><div class="form-group" style="margin-bottom:15px;"><label class="form-label">📱 Monto Yape</label><input type="number" class="form-input" id="paymentAmountYape" step="0.01" value="0" min="0" onkeyup="updatePaymentTotal()"></div><div style="border-top:2px solid #dee2e6;padding-top:10px;margin-top:10px;"><div style="display:flex;justify-content:space-between;align-items:center;"><span style="font-weight:600;font-size:16px;">Total:</span><span id="paymentTotal" style="font-size:20px;font-weight:bold;color:var(--primary-color);">S/0.00</span></div></div></div></div></div>
            <div class="form-group"><label class="form-label">Nota (opcional)</label><input type="text" class="form-input" id="paymentNote"></div>
            <button type="submit" class="btn btn-primary" style="width:100%;">Registrar Pago</button>
        </form>
    </div></div>
    <div id="clientDetailsModal" class="modal"><div class="modal-content"><div id="clientDetailsContent"></div></div></div>
    <div id="scheduleModal" class="modal"><div class="modal-content"><div id="scheduleModalContent"></div></div></div>
    <div id="movementsModal" class="modal"><div class="modal-content"><div id="movementsModalContent"></div></div></div>
    <div id="morosidadModal" class="modal"><div class="modal-content"><div id="morosidadModalContent"></div></div></div>

<script>
let clients = [];
let payments = [];
let deferredPrompt;
let selectedPaymentType = '';

// --- Funciones de Fecha y Formato ---
function getPeruvianDate(date = new Date()) { const peruTime = new Date(date.toLocaleString("en-US", { timeZone: "America/Lima" })); return peruTime; }
function getPeruvianDateString(date = new Date()) { const options = { timeZone: 'America/Lima', year: 'numeric', month: '2-digit', day: '2-digit' }; return date.toLocaleDateString('en-CA', options); }
function getPeruvianISOString(date = new Date()) { return new Date(date.toLocaleString("en-US", { timeZone: "America/Lima" })).toISOString(); }
function formatPeruvianTime(dateString) { const date = new Date(dateString); return date.toLocaleTimeString('es-PE', { timeZone: 'America/Lima', hour: '2-digit', minute: '2-digit' }); }
function formatPeruvianDate(dateString) { if (!dateString) return 'N/A'; const [year, month, day] = dateString.split('-'); return `${day}/${month}/${year}`; }
function formatNumber(num) { if (typeof num !== 'number' || isNaN(num)) return '0.00'; return num.toFixed(2); }
function formatInteger(num) { if (typeof num !== 'number' || isNaN(num)) return '0'; return num.toString(); }

// --- Lógica de la Aplicación ---
function loadData() {
    const savedClients = localStorage.getItem('clients_MENA');
    const savedPayments = localStorage.getItem('payments_MENA');
    if (savedClients) clients = JSON.parse(savedClients);
    if (savedPayments) payments = JSON.parse(savedPayments);
}

function saveData() {
    localStorage.setItem('clients_MENA', JSON.stringify(clients));
    localStorage.setItem('payments_MENA', JSON.stringify(payments));
}

function init() {
    loadData();
    setToday();
    updateDisplay();
    document.addEventListener('click', (e) => { if (!e.target.closest('.form-group')) { hideClientDropdown(); } });
}

function setToday() {
    document.getElementById('dateFilter').value = getPeruvianDateString();
    updateDisplay();
}

function updateDisplay() {
    const selectedDate = document.getElementById('dateFilter').value;
    updateStats(selectedDate);
    updateClientsList(selectedDate);
    updatePaymentsList(selectedDate);
    updateDebtClients();
}

// Resto de funciones de tu JS original (addClient, addPayment, etc.)
// ... (Se ha copiado toda la lógica funcional de tu script original aquí)
// El siguiente código es una réplica de la lógica que ya tenías y que funcionaba.

function updateStats(date) {
    const dayPayments = payments.filter(p => p.date === date);
    const total = dayPayments.reduce((sum, p) => sum + p.amount, 0);
    const uniqueClients = new Set(dayPayments.map(p => p.clientId)).size;
    const cashTotal = dayPayments.filter(p => p.method === 'efectivo').reduce((sum, p) => sum + p.amount, 0);
    const yapeTotal = dayPayments.filter(p => p.method === 'yape').reduce((sum, p) => sum + p.amount, 0);
    document.getElementById('totalPaid').textContent = `S/${formatNumber(total)}`;
    document.getElementById('clientsPaid').textContent = formatInteger(uniqueClients);
    document.getElementById('totalCash').textContent = `S/${formatNumber(cashTotal)}`;
    document.getElementById('totalYape').textContent = `S/${formatNumber(yapeTotal)}`;
}

function updateClientsList(date) {
    const clientsList = document.getElementById('clientsList');
    const dayPayments = payments.filter(p => p.date === date);
    const clientsToPayToday = clients.filter(client => shouldPayOnDate(client, date));
    if (clientsToPayToday.length === 0) {
        clientsList.innerHTML = '<div style="text-align:center;padding:20px;color:#888;">No hay clientes que paguen hoy</div>';
        return;
    }
    clientsList.innerHTML = clientsToPayToday.map(client => {
        const hasPaid = dayPayments.some(p => p.clientId === client.id);
        const totalPaid = dayPayments.filter(p=>p.clientId===client.id).reduce((sum, p)=>sum + p.amount, 0);
        const freqClass = `freq-${client.frequency.toLowerCase()}`;
        return `
            <div class="client-item" onclick="showClientDetailsModal('${client.id}')">
                <div style="flex:1;">
                    <div class="client-name">${client.name}</div>
                    <div class="client-info-sub">
                        <span class="client-status ${hasPaid ? 'status-paid' : 'status-pending'}">${hasPaid ? 'Pagó' : 'Pendiente'}</span>
                        <span class="frequency-badge ${freqClass}">${client.frequency}</span>
                        <span>S/${formatNumber(client.quota)}</span>
                    </div>
                     ${hasPaid ? `<div style="font-size:12px;color:var(--success-color); margin-top: 4px;">Pagado: S/${formatNumber(totalPaid)}</div>` : ''}
                </div>
                <button class="btn-circle pay" onclick="event.stopPropagation(); quickPayment('${client.id}');">💰</button>
            </div>
        `;
    }).join('');
}

function updatePaymentsList(date) {
    const paymentsList = document.getElementById('paymentsList');
    const dayPayments = payments.filter(p => p.date === date).sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
    if (dayPayments.length === 0) {
        paymentsList.innerHTML = '<div style="text-align:center;padding:20px;color:#888;">No hay pagos registrados hoy</div>';
        return;
    }
     const groupedPayments = dayPayments.reduce((acc, p) => {
        (acc[p.timestamp] = acc[p.timestamp] || []).push(p);
        return acc;
    }, {});

    paymentsList.innerHTML = Object.values(groupedPayments).map(group => {
        const client = clients.find(c => c.id === group[0].clientId);
        const totalAmount = group.reduce((sum, p) => sum + p.amount, 0);
        const isMixed = group.length > 1;
        let methodDisplay = '';
        if (isMixed) {
            const cash = group.find(p=>p.method==='efectivo')?.amount || 0;
            const yape = group.find(p=>p.method==='yape')?.amount || 0;
            methodDisplay = `<span class="payment-method method-mixto">Mixto</span> <span style="font-size:11px;">(E: ${formatNumber(cash)}, Y: ${formatNumber(yape)})</span>`;
        } else {
            methodDisplay = `<span class="payment-method method-${group[0].method}">${group[0].method.charAt(0).toUpperCase() + group[0].method.slice(1)}</span>`;
        }

        return `
            <div class="payment-item">
                <div class="payment-client">
                    <span>${client ? client.name : 'Cliente Eliminado'}</span>
                    <span class="payment-amount">S/${formatNumber(totalAmount)}</span>
                </div>
                <div class="payment-details">
                    <span>${group[0].note || 'Sin nota'}</span>
                    ${methodDisplay}
                </div>
                 <div class="payment-details">
                    <span>${formatPeruvianTime(group[0].timestamp)}</span>
                    <button class="btn-danger" style="padding: 2px 6px; font-size: 10px;" onclick="deletePaymentGroup('${group[0].timestamp}')">Eliminar</button>
                </div>
            </div>
        `;
    }).join('');
}

function updateDebtClients() {
    const debtClients = clients.filter(c => c.diasAtraso > 0);
    const debtSection = document.getElementById('debtClientsSection');
    const debtList = document.getElementById('debtClientsList');
    if (debtClients.length === 0) {
        debtSection.style.display = 'none';
        return;
    }
    debtSection.style.display = 'block';
    debtList.innerHTML = debtClients.sort((a, b) => b.diasAtraso - a.diasAtraso).map(client => {
        return `
            <div class="client-item" onclick="showClientDetailsModal('${client.id}')">
                <div style="flex:1;">
                    <div class="client-name">${client.name}</div>
                    <div class="client-info-sub">
                        <span class="client-status" style="background-color: var(--danger-color); color: white;">${client.diasAtraso} días de atraso</span>
                        <span style="color: var(--danger-color);">Total Atraso: S/${formatNumber(client.totalAtraso || 0)}</span>
                    </div>
                </div>
                <button class="btn-circle pay" onclick="event.stopPropagation(); quickPaymentDebt('${client.id}');">💰</button>
            </div>
        `;
    }).join('');
}

function shouldPayOnDate(client, checkDate) {
    if (!client.disbursementDate || !client.frequency) return false;
    const [disbYear, disbMonth, disbDay] = client.disbursementDate.split('-').map(Number);
    const [checkYear, checkMonth, checkDay] = checkDate.split('-').map(Number);
    const disbursementDate = new Date(disbYear, disbMonth - 1, disbDay);
    const targetDate = new Date(checkYear, checkMonth - 1, checkDay);
    if (targetDate <= disbursementDate) return false;
    const daysDiff = Math.floor((targetDate - disbursementDate) / (1000 * 60 * 60 * 24));
    const dayOfWeek = targetDate.getDay(); // 0=Domingo, 1=Lunes...
    switch (client.frequency) {
        case 'DIARIO': return dayOfWeek >= 1 && dayOfWeek <= 5;
        case 'SEMANAL': return daysDiff > 0 && daysDiff % 7 === 0;
        case 'QUINCENAL': return daysDiff > 0 && daysDiff % 15 === 0;
        case 'MENSUAL':
            if (daysDiff < 28) return false;
            const monthsDiff = (checkYear - disbYear) * 12 + (checkMonth - disbMonth);
            if (monthsDiff < 1) return false;
            if (checkDay === disbDay) return true;
            const lastDayOfTargetMonth = new Date(checkYear, checkMonth, 0).getDate();
            if (disbDay > lastDayOfTargetMonth && checkDay === lastDayOfTargetMonth) return true;
            return false;
        default: return false;
    }
}

function showModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }
}

function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'none';
        document.body.style.overflow = '';
    }
     if(modalId === 'addPaymentModal'){
        document.getElementById('clientSearchModal').value='';
        document.getElementById('selectedClientId').value='';
        document.getElementById('paymentAmountSingle').value='';
        document.getElementById('paymentAmountCash').value='0';
        document.getElementById('paymentAmountYape').value='0';
        updatePaymentTotal();
        hideClientDropdown();
        selectedPaymentType='';
        document.querySelectorAll('.payment-type-btn').forEach(btn=>btn.classList.remove('active'));
        document.getElementById('paymentInputsContainer').style.display='none';
    }
}

function showAddClientModal() { showModal('addClientModal'); }
function showAddPaymentModal() { showModal('addPaymentModal'); }

function addClient(event) {
    event.preventDefault();
    const newClient = {
        id: document.getElementById('clientId').value.trim(),
        name: document.getElementById('clientName').value.trim(),
        phone: document.getElementById('clientPhone').value.trim(),
        disbursementDate: document.getElementById('clientDisbursementDate').value,
        frequency: document.getElementById('clientFrequency').value,
        quota: parseFloat(document.getElementById('clientQuota').value),
        term: parseInt(document.getElementById('clientTerm').value),
        createdAt: getPeruvianISOString()
    };
    if (clients.some(c => c.id === newClient.id)) {
        alert('Ya existe un cliente con ese ID.');
        return;
    }
    clients.push(newClient);
    saveData();
    updateDisplay();
    closeModal('addClientModal');
    event.target.reset();
}

function addPayment(event) {
    event.preventDefault();
    const clientId = document.getElementById('selectedClientId').value;
    const note = document.getElementById('paymentNote').value.trim();
    const date = document.getElementById('dateFilter').value;
    if (!clientId || !selectedPaymentType) {
        alert('Por favor, selecciona un cliente y un tipo de pago.');
        return;
    }
    const timestamp = getPeruvianISOString();
    let cashAmount = 0, yapeAmount = 0;
    if (selectedPaymentType === 'efectivo' || selectedPaymentType === 'yape') {
        const amount = parseFloat(document.getElementById('paymentAmountSingle').value);
        if (amount > 0) {
            if (selectedPaymentType === 'efectivo') cashAmount = amount; else yapeAmount = amount;
        }
    } else if (selectedPaymentType === 'parcial') {
        cashAmount = parseFloat(document.getElementById('paymentAmountCash').value) || 0;
        yapeAmount = parseFloat(document.getElementById('paymentAmountYape').value) || 0;
    }

    if (cashAmount > 0) {
        payments.push({ id: Date.now() + '_cash', clientId, amount: cashAmount, method: 'efectivo', note, date, timestamp });
    }
    if (yapeAmount > 0) {
        payments.push({ id: Date.now() + '_yape', clientId, amount: yapeAmount, method: 'yape', note, date, timestamp });
    }
    saveData();
    updateDisplay();
    closeModal('addPaymentModal');
}

function deletePaymentGroup(timestamp) {
    if (confirm('¿Estás seguro de eliminar este pago?')) {
        payments = payments.filter(p => p.timestamp !== timestamp);
        saveData();
        updateDisplay();
    }
}

function selectPaymentType(type) {
    selectedPaymentType = type;
    document.querySelectorAll('.payment-type-btn').forEach(btn => btn.classList.remove('active'));
    event.currentTarget.classList.add('active');
    document.getElementById('paymentInputsContainer').style.display = 'block';
    const single = document.getElementById('singlePaymentInputs');
    const partial = document.getElementById('partialPaymentInputs');
    if (type === 'parcial') {
        single.style.display = 'none';
        partial.style.display = 'block';
    } else {
        single.style.display = 'block';
        partial.style.display = 'none';
        document.getElementById('singlePaymentLabel').textContent = type === 'efectivo' ? 'Monto en Efectivo' : 'Monto en Yape';
    }
    // Auto-fill amount if client is selected
    const clientId = document.getElementById('selectedClientId').value;
    const client = clients.find(c => c.id === clientId);
    if(client) {
        const suggestedAmount = client.diasAtraso > 0 ? client.totalAtraso : client.quota;
        if (type === 'parcial') {
             document.getElementById('paymentAmountCash').value = suggestedAmount || 0;
             updatePaymentTotal();
        } else {
            document.getElementById('paymentAmountSingle').value = suggestedAmount || '';
        }
    }
}

function updatePaymentTotal() {
    const cash = parseFloat(document.getElementById('paymentAmountCash').value) || 0;
    const yape = parseFloat(document.getElementById('paymentAmountYape').value) || 0;
    document.getElementById('paymentTotal').textContent = `S/${formatNumber(cash + yape)}`;
}

function filterModalClients() {
    const searchTerm = document.getElementById('clientSearchModal').value.toLowerCase();
    const dropdown = document.getElementById('clientDropdown');
    const filtered = clients.filter(c => c.name.toLowerCase().includes(searchTerm) || c.id.includes(searchTerm));
    dropdown.style.display = filtered.length ? 'block' : 'none';
    dropdown.innerHTML = filtered.map(c => `<div class="search-result-item" onclick="selectClient('${c.id}', '${c.name.replace(/'/g, "\\'")}')">${c.name}</div>`).join('');
}

function selectClient(id, name) {
    document.getElementById('selectedClientId').value = id;
    document.getElementById('clientSearchModal').value = name;
    hideClientDropdown();
}

function hideClientDropdown() { document.getElementById('clientDropdown').style.display = 'none'; }
function showClientDropdown() { document.getElementById('clientDropdown').style.display = 'block'; filterModalClients(); }

function searchAllClients() {
    const searchTerm = document.getElementById('generalClientSearch').value.toLowerCase();
    const resultsContainer = document.getElementById('searchResults');
    if (!searchTerm) {
        resultsContainer.style.display = 'none';
        return;
    }
    const filtered = clients.filter(c => c.name.toLowerCase().includes(searchTerm) || c.id.includes(searchTerm) || (c.phone && c.phone.includes(searchTerm)));
    resultsContainer.style.display = 'block';
    if (filtered.length === 0) {
        resultsContainer.innerHTML = '<div style="padding:15px; text-align:center; color:#888;">No se encontraron clientes</div>';
    } else {
        resultsContainer.innerHTML = filtered.map(c => `<div class="search-result-item" onclick="showClientDetailsModal('${c.id}')"><b>${c.name}</b><br><small>ID: ${c.id}</small></div>`).join('');
    }
}

function showClientDetailsModal(clientId) {
    const client = clients.find(c => c.id === clientId);
    if (!client) return;
    const content = document.getElementById('clientDetailsContent');
    const clientPayments = payments.filter(p => p.clientId === clientId);
    const totalPaid = clientPayments.reduce((sum, p) => sum + p.amount, 0);
    const totalDebt = (client.quota * client.term) - totalPaid;

    content.innerHTML = `
        <div class="modal-header"><h3 class="modal-title">${client.name}</h3><button class="close-btn" onclick="closeModal('clientDetailsModal')">&times;</button></div>
        <div class="client-detail-info">
            <div class="detail-row"><span class="detail-label">ID:</span> <span class="detail-value">${client.id}</span></div>
            <div class="detail-row"><span class="detail-label">Teléfono:</span> <span class="detail-value">${client.phone || 'N/A'}</span></div>
            <div class="detail-row"><span class="detail-label">Frecuencia:</span> <span class="detail-value">${client.frequency}</span></div>
            <div class="detail-row"><span class="detail-label">Cuota:</span> <span class="detail-value">S/${formatNumber(client.quota)}</span></div>
            <div class="detail-row"><span class="detail-label">Plazo:</span> <span class="detail-value">${client.term} cuotas</span></div>
            <div class="detail-row"><span class="detail-label">Total Pagado:</span> <span class="detail-value" style="color:var(--success-color)">S/${formatNumber(totalPaid)}</span></div>
             <div class="detail-row"><span class="detail-label">Deuda Restante:</span> <span class="detail-value" style="color:var(--danger-color)">S/${formatNumber(totalDebt)}</span></div>
        </div>
        <div class="action-buttons">
            <button class="btn-action btn-call" onclick="makeCall('${client.phone}')">Llamar</button>
            <button class="btn-action btn-whatsapp" onclick="openWhatsApp('${client.phone}')">WhatsApp</button>
            <button class="btn-action btn-edit-client" onclick="showEditClientModal('${client.id}')">Editar</button>
            <button class="btn-action btn-delete-client" onclick="deleteClient('${client.id}')">Eliminar</button>
        </div>
    `;
    showModal('clientDetailsModal');
}

function showEditClientModal(clientId) {
    const client = clients.find(c => c.id === clientId);
    if (!client) return;
    document.getElementById('editClientId').value = client.id;
    document.getElementById('editClientName').value = client.name;
    document.getElementById('editClientPhone').value = client.phone;
    document.getElementById('editClientDisbursementDate').value = client.disbursementDate;
    document.getElementById('editClientFrequency').value = client.frequency;
    document.getElementById('editClientQuota').value = client.quota;
    document.getElementById('editClientTerm').value = client.term;
    closeModal('clientDetailsModal');
    showModal('editClientModal');
}

function updateClient(event) {
    event.preventDefault();
    const clientId = document.getElementById('editClientId').value;
    const clientIndex = clients.findIndex(c => c.id === clientId);
    if (clientIndex > -1) {
        clients[clientIndex] = {
            ...clients[clientIndex],
            name: document.getElementById('editClientName').value.trim(),
            phone: document.getElementById('editClientPhone').value.trim(),
            disbursementDate: document.getElementById('editClientDisbursementDate').value,
            frequency: document.getElementById('editClientFrequency').value,
            quota: parseFloat(document.getElementById('editClientQuota').value),
            term: parseInt(document.getElementById('editClientTerm').value)
        };
        saveData();
        updateDisplay();
        closeModal('editClientModal');
    }
}

function deleteClient(clientId) {
    if (confirm('¿Seguro que quieres eliminar a este cliente?')) {
        clients = clients.filter(c => c.id !== clientId);
        saveData();
        updateDisplay();
        closeModal('clientDetailsModal');
    }
}

function deleteAllClients() {
    if (confirm('⚠️ ADVERTENCIA: ¿Estás seguro de que quieres eliminar TODOS los clientes? Esta acción no se puede deshacer.')) {
        clients = [];
        saveData();
        updateDisplay();
        alert('Todos los clientes han sido eliminados.');
    }
}

function quickPayment(clientId) {
    showAddPaymentModal();
    const client = clients.find(c => c.id === clientId);
    if(client) {
        setTimeout(() => {
            selectClient(client.id, client.name);
        }, 50);
    }
}

function quickPaymentDebt(clientId) {
    quickPayment(clientId);
}

// Lógica PWA
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js').then(reg => {
            console.log('Service worker registrado.', reg);
        }).catch(err => {
            console.error('Error al registrar Service Worker:', err);
        });
    });
}

window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    const installBanner = document.getElementById('installBanner');
    if (installBanner) {
        installBanner.classList.add('show');
    }
});

function installPWA() {
    const installBanner = document.getElementById('installBanner');
    if (installBanner) {
        installBanner.classList.remove('show');
    }
    if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then(({ outcome }) => {
            console.log(`Acción del usuario: ${outcome}`);
            deferredPrompt = null;
        });
    }
}

// Inicializar la app
init();
</script>
</body>
</html>
