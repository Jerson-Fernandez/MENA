<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Sistema de Pagos Andreli</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Pagos Andreli">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#00684A">
    <meta name="format-detection" content="telephone=no">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* --- RESET Y CONFIGURACI√ìN GENERAL --- */
        :root {
            --primary-color: #00684A; /* Verde corporativo */
            --secondary-color: #00583E;
            --accent-color: #FFC107; /* Dorado/Amarillo para acentos */
            --danger-color: #e74c3c;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --light-gray: #f7f9fa;
            --medium-gray: #e0e0e0;
            --dark-gray: #555;
            --text-color: #333;
            --white: #ffffff;
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            --border-radius: 12px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background-color: var(--light-gray);
            color: var(--text-color);
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden;
        }
        
        /* --- ENCABEZADO --- */
        .header {
            background: var(--primary-color);
            color: var(--white);
            padding: 20px;
            padding-top: calc(20px + env(safe-area-inset-top));
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            position: sticky;
            top: 0;
            z-index: 100;
            width: 100%;
        }
        .header .logo {
            font-size: 28px;
            font-weight: 700;
        }
        .header h1 {
            font-size: 22px;
            font-weight: 600;
        }

        /* --- CONTENEDOR PRINCIPAL --- */
        .container {
            padding: 20px;
            max-width: 700px;
            margin: 0 auto;
            padding-bottom: calc(20px + env(safe-area-inset-bottom));
        }

        /* --- TARJETAS Y SECCIONES --- */
        .card {
            background: var(--white);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            border: 1px solid #eef2f5;
        }
        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .section-title svg {
            width: 20px;
            height: 20px;
        }
        
        /* --- ESTAD√çSTICAS --- */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
        }
        .stat-item {
            text-align: center;
            padding: 10px;
            background: var(--light-gray);
            border-radius: 8px;
        }
        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-color);
        }
        .stat-label {
            font-size: 13px;
            color: var(--dark-gray);
            margin-top: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        /* --- BOTONES --- */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            font-family: 'Poppins', sans-serif;
            cursor: pointer;
            transition: all 0.25s ease;
            -webkit-appearance: none;
            appearance: none;
            touch-action: manipulation;
        }
        .btn:active {
            transform: scale(0.97);
        }
        .btn-primary {
            background-color: var(--primary-color);
            color: var(--white);
        }
        .btn-primary:hover {
            background-color: var(--secondary-color);
            box-shadow: 0 6px 20px rgba(0, 104, 74, 0.2);
        }
        .btn-secondary {
            background-color: var(--medium-gray);
            color: var(--dark-gray);
        }
        .btn-secondary:hover {
            background-color: #d0d0d0;
        }
        .btn-danger {
            background-color: var(--danger-color);
            color: var(--white);
        }
        .btn-danger:hover {
            background-color: #c0392b;
        }
        .btn-morosidad {
            background: var(--warning-color);
            color: var(--white);
        }
        .btn-morosidad:hover {
            background: #d48c0a;
        }
        .button-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        .button-row .btn {
            width: 100%;
            padding: 15px;
        }

        /* --- FORMULARIOS --- */
        .form-group {
            margin-bottom: 20px;
            position: relative;
        }
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-color);
            font-size: 14px;
        }
        .form-input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--medium-gray);
            border-radius: 8px;
            font-size: 16px;
            font-family: 'Poppins', sans-serif;
            transition: border-color 0.2s, box-shadow 0.2s;
            background-color: var(--white);
        }
        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 104, 74, 0.1);
        }
        input[type="date"] {
            min-height: 48px;
        }

        /* --- LISTA DE CLIENTES --- */
        .clients-container, .payments-container, .search-results {
            max-height: 400px;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
        }
        .client-item {
            padding: 15px;
            border-bottom: 1px solid var(--light-gray);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .client-item:last-child {
            border-bottom: none;
        }
        .client-item:hover {
            background-color: #fcfcfd;
            transform: translateX(5px);
        }
        .client-name {
            font-weight: 600;
            color: var(--text-color);
            font-size: 16px;
        }
        .client-info-sub {
            font-size: 13px;
            color: var(--dark-gray);
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 8px;
        }
        .client-status {
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 20px;
            font-weight: 500;
        }
        .status-paid {
            background: #eafaf1;
            color: #2ecc71;
        }
        .status-pending {
            background: #fef5e7;
            color: #f39c12;
        }
        .client-actions {
            display: flex;
            gap: 10px;
        }
        .btn-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--light-gray);
            color: var(--dark-gray);
        }
        .btn-circle:hover {
            background: var(--medium-gray);
        }
        .btn-circle.pay {
            background: #eafaf1;
            color: var(--success-color);
        }
        .btn-circle.pay:hover {
            background: #d5f5e3;
        }
        .debt-indicator {
            width: 10px;
            height: 10px;
            background-color: var(--danger-color);
            border-radius: 50%;
            animation: pulse-danger 1.5s infinite;
        }
        @keyframes pulse-danger {
            0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(231, 76, 60, 0); }
            100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); }
        }
        .debt-clients-container {
            background: #fdedec;
            border: 1px solid #f5b7b1;
        }
        
        /* --- ETIQUETAS DE FRECUENCIA --- */
        .frequency-badge {
            display: inline-block;
            padding: 3px 9px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
        }
        .freq-diario { background: #e8f5e9; color: #2e7d32; }
        .freq-semanal { background: #e3f2fd; color: #1565c0; }
        .freq-quincenal { background: #fce4ec; color: #c2185b; }
        .freq-mensual { background: #f3e5f5; color: #7b1fa2; }

        /* --- MODALES --- */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            overflow-y: auto;
        }
        .modal.show {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 5vh 0;
        }
        .modal-content {
            background: var(--white);
            padding: 25px;
            width: calc(100% - 40px);
            max-width: 500px;
            border-radius: var(--border-radius);
            animation: slideIn 0.3s ease-out;
            margin: auto;
            max-height: 90vh;
            overflow-y: auto;
        }
        @keyframes slideIn {
            from { transform: translateY(-30px) scale(0.95); opacity: 0; }
            to { transform: translateY(0) scale(1); opacity: 1; }
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--primary-color);
        }
        .close-btn {
            font-size: 28px;
            cursor: pointer;
            color: #999;
            background: none;
            border: none;
            line-height: 1;
        }

        /* --- FILTRO DE FECHA --- */
        .date-filter {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 10px;
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }
        .date-filter .form-input {
            width: auto;
            border: none;
            background: transparent;
        }
        .date-filter .form-input:focus {
            box-shadow: none;
        }
        .date-filter-buttons {
            display: flex;
            gap: 10px;
        }

        /* --- B√öSQUEDA --- */
        .search-container {
            position: relative;
        }
        .search-input {
            padding-left: 40px;
        }
        .search-container .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--dark-gray);
            pointer-events: none;
        }
        .search-results {
            margin-top: 5px;
            max-height: 300px;
            background: var(--white);
            border: 1px solid var(--medium-gray);
            border-radius: 8px;
        }
        .search-result-item {
            padding: 15px;
            border-bottom: 1px solid var(--light-gray);
            cursor: pointer;
        }

        /* --- DETALLES DE CLIENTE MODAL --- */
        #clientDetailsModal .modal-content {
            max-height: 90vh;
            overflow-y: auto;
        }
        .client-detail-info {
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--medium-gray);
            margin-bottom: 20px;
            background-color: var(--white);
        }
        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
            font-size: 14px;
        }
        .detail-row:last-child {
            border-bottom: none;
        }
        .detail-label {
            font-weight: 500;
            color: var(--dark-gray);
        }
        .detail-value {
            color: var(--text-color);
            font-weight: 600;
        }
        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
            padding-bottom: 10px;
        }
        .btn-action {
            padding: 10px;
            border-radius: 8px;
            font-size: 14px;
        }
        .btn-call { background: #3498db; color: white; }
        .btn-whatsapp { background: #25D366; color: white; }
        .btn-schedule { background: #9b59b6; color: white; }
        .btn-movements { background: #34495e; color: white; }
        .btn-edit-client { background: #f39c12; color: white; }
        .btn-delete-client { background: #e74c3c; color: white; }

        /* --- SELECTOR DE TIPO DE PAGO --- */
        .payment-type-selector {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }
        .payment-type-btn {
            padding: 15px;
            border: 2px solid var(--medium-gray);
            background: var(--white);
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }
        .payment-type-btn:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow);
        }
        .payment-type-btn.active {
            background: var(--primary-color);
            color: var(--white);
            border-color: var(--primary-color);
            box-shadow: 0 6px 20px rgba(0, 104, 74, 0.2);
        }
        .payment-type-btn .icon {
            font-size: 24px;
            margin-bottom: 8px;
        }
        .payment-type-btn .label {
            font-size: 14px;
            font-weight: 500;
        }
        .payment-type-btn.active .icon, .payment-type-btn.active .label {
            color: var(--white);
        }

        /* --- LISTA DE PAGOS --- */
        .payment-item {
            padding: 15px;
            border-bottom: 1px solid var(--light-gray);
        }
        .payment-item:last-child {
            border-bottom: none;
        }
        .payment-client {
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .payment-details {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
            font-size: 14px;
            color: var(--dark-gray);
        }
        .payment-amount {
            color: var(--success-color);
            font-weight: 700;
            font-size: 16px;
        }
        .payment-method {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
        }
        .method-efectivo { background: #e8f5e9; color: #2e7d32; }
        .method-yape { background: #e3f2fd; color: #1565c0; }
        .method-mixto { background: #fff3cd; color: #856404; }

        /* --- TABLA DE MOROSIDAD Y CRONOGRAMA --- */
        .responsive-table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        .styled-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 14px;
        }
        .styled-table th, .styled-table td {
            padding: 12px 15px;
            border: 1px solid var(--medium-gray);
            text-align: left;
        }
        .styled-table th {
            background-color: var(--primary-color);
            color: var(--white);
            font-weight: 600;
            white-space: nowrap;
        }
        .styled-table tbody tr {
            border-bottom: 1px solid var(--medium-gray);
        }
        .styled-table tbody tr:nth-of-type(even) {
            background-color: var(--light-gray);
        }
        .styled-table tbody tr:hover {
            background-color: #f1f1f1;
        }
        #morosidadModal .modal-content, #scheduleModal .modal-content {
            max-width: 95%;
            width: auto;
        }
        #morosidadModal .styled-table .morosidad-client-name {
            font-size: 13px;
            white-space: normal;
            word-break: break-word;
            min-width: 150px;
        }

        /* --- PWA INSTALL BANNER --- */
        .install-banner {
            display: none;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 16px;
            margin: 0 20px 20px 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 104, 74, 0.3);
            align-items: center;
            gap: 12px;
        }
        .install-banner.show {
            display: flex;
        }
        .install-banner-text {
            flex: 1;
        }
        .install-banner-text h3 {
            font-size: 16px;
            margin-bottom: 4px;
        }
        .install-banner-text p {
            font-size: 14px;
            opacity: 0.9;
        }
        .btn-install {
            background: white;
            color: var(--primary-color);
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
        }
        .btn-install:active {
            transform: scale(0.95);
        }
        
    </style>
</head>
<body>
    <!-- Encabezado -->
    <header class="header">
        <div class="logo">A</div>
        <h1>Control de Pagos Andreli</h1>
    </header>

    <!-- Contenido Principal -->
    <main class="container">
        <!-- Banner de instalaci√≥n PWA -->
        <div id="installBanner" class="install-banner">
            <div class="install-banner-text">
                <h3>Instalar Control de Pagos</h3>
                <p>Accede r√°pido desde tu pantalla de inicio</p>
            </div>
            <button class="btn-install" onclick="installPWA()">Instalar</button>
        </div>

        <!-- Filtro de Fecha -->
        <div class="date-filter">
            <div>
                <input type="date" id="dateFilter" class="form-input">
            </div>
            <div class="date-filter-buttons">
                <button class="btn btn-secondary" onclick="setToday()">Hoy</button>
                <button class="btn btn-secondary" onclick="document.getElementById('excelUpload').click()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.884 6.68a.5.5 0 1 0-.768.64L7.349 10l-2.233 2.68a.5.5 0 0 0 .768.64L8 10.781l2.116 2.54a.5.5 0 0 0 .768-.64L8.651 10l2.233-2.68a.5.5 0 0 0-.768-.64L8 9.219l-2.116-2.54z"/><path d="M4 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2zm0 1h8a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1"/></svg>
                    <span>Excel</span>
                </button>
                <input type="file" id="excelUpload" accept=".xlsx,.xls" style="display:none;" onchange="handleExcelUpload(event)">
            </div>
        </div>

        <!-- Tarjeta de Resumen -->
        <div class="card">
            <h2 class="section-title">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20V10"/><path d="M18 20V4"/><path d="M6 20V16"/></svg>
                Resumen del D√≠a
            </h2>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value" id="totalPaid">S/0.00</div>
                    <div class="stat-label">Total Recibido</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="clientsPaid">0</div>
                    <div class="stat-label">Clientes Pagaron</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalCash">S/0.00</div>
                    <div class="stat-label">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M1 3a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1zm7 8a2 2 0 1 0 0-4 2 2 0 0 0 0 4"/><path d="M0 5a1 1 0 0 1 1-1h14a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1H1a1 1 0 0 1-1-1z"/></svg>
                        Efectivo
                    </div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalYape">S/0.00</div>
                    <div class="stat-label">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2zM11 15a1 1 0 0 1-1 1H6a1 1 0 0 1-1-1V3a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1zM8 12a1 1 0 1 0 0-2 1 1 0 0 0 0 2"/></svg>
                        Yape
                    </div>
                </div>
            </div>
        </div>

        <!-- B√∫squeda General -->
        <div class="card">
             <h2 class="section-title">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 17l5 5"/><path d="M11 19a8 8 0 1 0 0-16 8 8 0 0 0 0 16z"/></svg>
                Buscar Cliente
            </h2>
            <div class="search-container">
                <span class="search-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 17l5 5"/><path d="M11 19a8 8 0 1 0 0-16 8 8 0 0 0 0 16z"/></svg>
                </span>
                <input type="text" class="form-input search-input" id="generalClientSearch" placeholder="Buscar por nombre, ID o tel√©fono..." onkeyup="searchAllClients()">
            </div>
            <div id="searchResults" class="search-results" style="display:none;"></div>
        </div>

        <!-- Botones de Acci√≥n -->
        <div class="button-row">
            <button class="btn btn-primary" onclick="showAddClientModal()">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16"><path d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6m2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0m4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4m-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10s-3.516.68-4.168 1.332c-.678.678-.83 1.418-.832 1.664z"/><path fill-rule="evenodd" d="M13.5 5a.5.5 0 0 1 .5.5V7h1.5a.5.5 0 0 1 0 1H14v1.5a.5.5 0 0 1-1 0V8h-1.5a.5.5 0 0 1 0-1H13V5.5a.5.5 0 0 1 .5-.5"/></svg>
                <span>Agregar Cliente</span>
            </button>
            <button class="btn btn-primary" onclick="showAddPaymentModal()">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16"><path d="M1 3a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1zm7 8a2 2 0 1 0 0-4 2 2 0 0 0 0 4"/><path d="M0 5a1 1 0 0 1 1-1h14a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1H1a1 1 0 0 1-1-1z"/></svg>
                <span>Registrar Pago</span>
            </button>
        </div>
        <div class="button-row">
            <button class="btn btn-morosidad" onclick="showMorosidadModal()">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16"><path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5m.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2"/></svg>
                <span>Ver Morosidad</span>
            </button>
            <button class="btn btn-danger" onclick="deleteAllClients()">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/><path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/></svg>
                <span>Eliminar Todos</span>
            </button>
        </div>

        <!-- Lista de Clientes en Mora -->
        <div class="card debt-clients-container" id="debtClientsSection" style="display:none;">
            <h2 class="section-title" style="color: var(--danger-color);">
                <span class="debt-indicator"></span>Clientes en Mora
            </h2>
            <div class="clients-container" id="debtClientsContainer">
                <div id="debtClientsList">
                    <div class="empty-state">No hay clientes en mora</div>
                </div>
            </div>
        </div>

        <!-- Lista de Clientes del D√≠a -->
        <div class="card">
            <h2 class="section-title">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                Clientes del D√≠a
            </h2>
            <div class="clients-container" id="clientsContainer">
                <div id="clientsList">
                    <div class="empty-state">No hay clientes registrados</div>
                </div>
            </div>
        </div>

        <!-- Historial de Pagos -->
        <div class="card">
            <h2 class="section-title">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
                Pagos del D√≠a
            </h2>
            <div class="payments-container" id="paymentsContainer">
                <div id="paymentsList">
                    <div class="empty-state">No hay pagos registrados</div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modales -->
    <div id="addClientModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Agregar Cliente</h3>
                <button class="close-btn" onclick="closeModal('addClientModal')">&times;</button>
            </div>
            <form onsubmit="addClient(event)">
                <div class="form-group"><label class="form-label">ID del Cliente</label><input type="text" class="form-input" id="clientId" required></div>
                <div class="form-group"><label class="form-label">Nombre del Cliente</label><input type="text" class="form-input" id="clientName" required></div>
                <div class="form-group"><label class="form-label">Tel√©fono (opcional)</label><input type="tel" class="form-input" id="clientPhone"></div>
                <div class="form-group"><label class="form-label">Fecha de Desembolso</label><input type="date" class="form-input" id="clientDisbursementDate" required></div>
                <div class="form-group"><label class="form-label">Frecuencia de Pago</label><select class="form-input" id="clientFrequency" required><option value="">Seleccionar frecuencia...</option><option value="DIARIO">Diario</option><option value="SEMANAL">Semanal</option><option value="QUINCENAL">Quincenal</option><option value="MENSUAL">Mensual</option></select></div>
                <div class="form-group"><label class="form-label">Monto de Cuota</label><input type="number" class="form-input" id="clientQuota" step="0.01" required></div>
                <div class="form-group"><label class="form-label">Plazo (n√∫mero de cuotas)</label><input type="number" class="form-input" id="clientTerm" min="1" required></div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Agregar Cliente</button>
            </form>
        </div>
    </div>

    <div id="editClientModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3 class="modal-title">Modificar Cliente</h3><button class="close-btn" onclick="closeModal('editClientModal')">&times;</button></div>
            <form onsubmit="updateClient(event)">
                <input type="hidden" id="editClientId">
                <div class="form-group"><label class="form-label">Nombre del Cliente</label><input type="text" class="form-input" id="editClientName" required></div>
                <div class="form-group"><label class="form-label">Tel√©fono (opcional)</label><input type="tel" class="form-input" id="editClientPhone"></div>
                <div class="form-group"><label class="form-label">Fecha de Desembolso</label><input type="date" class="form-input" id="editClientDisbursementDate" required></div>
                <div class="form-group"><label class="form-label">Frecuencia de Pago</label><select class="form-input" id="editClientFrequency" required><option value="">Seleccionar frecuencia...</option><option value="DIARIO">Diario</option><option value="SEMANAL">Semanal</option><option value="QUINCENAL">Quincenal</option><option value="MENSUAL">Mensual</option></select></div>
                <div class="form-group"><label class="form-label">Monto de Cuota</label><input type="number" class="form-input" id="editClientQuota" step="0.01" required></div>
                <div class="form-group"><label class="form-label">Plazo (n√∫mero de cuotas)</label><input type="number" class="form-input" id="editClientTerm" min="1" required></div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Guardar Cambios</button>
            </form>
        </div>
    </div>

    <div id="addPaymentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3 class="modal-title">Registrar Pago</h3><button class="close-btn" onclick="closeModal('addPaymentModal')">&times;</button></div>
            <form onsubmit="addPayment(event)">
                <div class="form-group">
                    <label class="form-label">Cliente</label>
                    <input type="text" class="form-input" id="clientSearchModal" placeholder="Buscar y seleccionar cliente..." autocomplete="off" onkeyup="filterModalClients()" onfocus="showClientDropdown()" required>
                    <input type="hidden" id="selectedClientId" required>
                    <div id="clientDropdown" class="client-dropdown" style="display:none;position:absolute;background:white;border:1px solid #e0e0e0;border-top:none;border-radius:0 0 8px 8px;max-height:200px;overflow-y:auto;z-index:1001;width:100%;box-shadow:0 4px 10px rgba(0,0,0,0.1);"></div>
                </div>
                <div class="form-group">
                    <label class="form-label">Tipo de Pago</label>
                    <div class="payment-type-selector">
                        <div class="payment-type-btn" onclick="selectPaymentType('efectivo')"><div class="icon">üíµ</div><div class="label">Efectivo</div></div>
                        <div class="payment-type-btn" onclick="selectPaymentType('yape')"><div class="icon">üì±</div><div class="label">Yape</div></div>
                        <div class="payment-type-btn" onclick="selectPaymentType('parcial')"><div class="icon">üí∞</div><div class="label">Parcial</div></div>
                    </div>
                </div>
                <div id="paymentInputsContainer" style="display:none;">
                    <div class="payment-inputs" id="singlePaymentInputs" style="display:none;">
                        <div class="form-group"><label class="form-label" id="singlePaymentLabel">Monto</label><input type="number" class="form-input" id="paymentAmountSingle" step="0.01" min="0"></div>
                    </div>
                    <div class="payment-inputs" id="partialPaymentInputs" style="display:none;">
                        <div style="background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:20px;">
                            <div class="form-group" style="margin-bottom:15px;"><label class="form-label">üíµ Monto en Efectivo</label><input type="number" class="form-input" id="paymentAmountCash" step="0.01" value="0" min="0" onkeyup="updatePaymentTotal()" onchange="updatePaymentTotal()"></div>
                            <div class="form-group" style="margin-bottom:15px;"><label class="form-label">üì± Monto en Yape</label><input type="number" class="form-input" id="paymentAmountYape" step="0.01" value="0" min="0" onkeyup="updatePaymentTotal()" onchange="updatePaymentTotal()"></div>
                            <div style="border-top:2px solid #dee2e6;padding-top:10px;margin-top:10px;">
                                <div style="display:flex;justify-content:space-between;align-items:center;">
                                    <span style="font-weight:600;font-size:16px;">Total:</span>
                                    <span id="paymentTotal" style="font-size:20px;font-weight:bold;color:var(--primary-color);">S/0.00</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-group"><label class="form-label">Nota (opcional)</label><input type="text" class="form-input" id="paymentNote"></div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Registrar Pago</button>
            </form>
        </div>
    </div>

    <div id="clientDetailsModal" class="modal"><div class="modal-content"><div class="modal-header"><h3 class="modal-title">Detalles del Cliente</h3><button class="close-btn" onclick="closeModal('clientDetailsModal')">&times;</button></div><div id="clientDetailsContent"></div></div></div>
    <div id="scheduleModal" class="modal"><div class="modal-content"><div class="modal-header"><h3 class="modal-title">Cronograma de Pagos</h3><button class="close-btn" onclick="closeModal('scheduleModal')">&times;</button></div><div id="scheduleModalContent" class="responsive-table-container"></div></div></div>
    <div id="movementsModal" class="modal"><div class="modal-content"><div class="modal-header"><h3 class="modal-title">Movimientos del Cliente</h3><button class="close-btn" onclick="closeModal('movementsModal')">&times;</button></div><div id="movementsModalContent"></div></div></div>
    <div id="morosidadModal" class="modal"><div class="modal-content"><div class="modal-header"><h3 class="modal-title">Reporte de Morosidad</h3><button class="close-btn" onclick="closeModal('morosidadModal')">&times;</button></div><div id="morosidadModalContent" class="responsive-table-container"></div></div></div>

<script>
// --- INICIO DEL C√ìDIGO JAVASCRIPT ---
let clients=[];let payments=[];let scrollPosition=0;let selectedPaymentType='';let deferredPrompt;
function getPeruvianDate(date=new Date()){const peruTime=new Date(date.toLocaleString("en-US",{timeZone:"America/Lima"}));return peruTime;}
function getPeruvianDateString(date=new Date()){const options={timeZone:'America/Lima',year:'numeric',month:'2-digit',day:'2-digit'};const peruDateStr=date.toLocaleDateString('en-CA',options);return peruDateStr;}
function getPeruvianISOString(date=new Date()){return new Date(date.toLocaleString("en-US",{timeZone:"America/Lima"})).toISOString();}
function formatPeruvianTime(dateString){const date=new Date(dateString);return date.toLocaleTimeString('es-PE',{timeZone:'America/Lima',hour:'2-digit',minute:'2-digit',second:'2-digit'});}
function formatPeruvianDate(dateString){if(!dateString) return 'N/A'; const[year,month,day]=dateString.split('-');return`${day}/${month}/${year}`;}
function formatNumber(num){if(typeof num!=='number'||isNaN(num))return'0.00';return num.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,',');}
function formatInteger(num){if(typeof num!=='number'||isNaN(num))return'0';return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g,',');}
function openWhatsApp(phone){if(!phone||phone.trim()===''){alert('Este cliente no tiene n√∫mero de tel√©fono registrado');return;}let cleanPhone=phone.replace(/\s+/g,'').replace(/[-()]/g,'');if(!cleanPhone.startsWith('+51')&&!cleanPhone.startsWith('51')){cleanPhone='+51'+cleanPhone;}else if(cleanPhone.startsWith('51')&&!cleanPhone.startsWith('+51')){cleanPhone='+'+cleanPhone;}const whatsappUrl=`https://wa.me/${cleanPhone.replace('+','')}`;window.open(whatsappUrl,'_blank');}
function makeCall(phone){if(!phone||phone.trim()===''){alert('Este cliente no tiene n√∫mero de tel√©fono registrado');return;}let cleanPhone=phone.replace(/\s+/g,'').replace(/[-()]/g,'');if(!cleanPhone.startsWith('+51')&&!cleanPhone.startsWith('51')){cleanPhone='+51'+cleanPhone;}else if(cleanPhone.startsWith('51')&&!cleanPhone.startsWith('+51')){cleanPhone='+'+cleanPhone;}const callUrl=`tel:${cleanPhone}`;window.location.href=callUrl;}
function formatExcelDate(excelDate){if(!excelDate)return'';if(excelDate instanceof Date){const year=excelDate.getFullYear();const month=(excelDate.getMonth()+1).toString().padStart(2,'0');const day=excelDate.getDate().toString().padStart(2,'0');return`${year}-${month}-${day}`;}if(typeof excelDate==='string'&&/^\d{4}-\d{2}-\d{2}$/.test(excelDate)){return excelDate;}if(typeof excelDate==='string'){excelDate=excelDate.trim();if(excelDate.includes('/')||excelDate.includes('-')){const parts=excelDate.split(/[/-]/);if(parts.length===3){let day,month,year;if(parts[0].length===4){year=parts[0];month=parts[1].padStart(2,'0');day=parts[2].padStart(2,'0');}else{day=parts[0].padStart(2,'0');month=parts[1].padStart(2,'0');if(parts[2].length===2){const currentYear=new Date().getFullYear();const century=Math.floor(currentYear/100)*100;const yearNum=parseInt(parts[2]);if(yearNum<=currentYear%100){year=century+yearNum;}else{year=(century-100)+yearNum;}}else{year=parts[2];}}const dateObj=new Date(parseInt(year),parseInt(month)-1,parseInt(day));if(!isNaN(dateObj.getTime())){return`${year}-${month}-${day}`;}}}}else if(typeof excelDate==='number'){const utcDays=Math.floor(excelDate-25569);const utcValue=utcDays*86400;const dateInfo=new Date(utcValue*1000);const year=dateInfo.getUTCFullYear();if(year<2020||year>2030){console.warn('Fecha fuera de rango:',year);return'';}const month=(dateInfo.getUTCMonth()+1).toString().padStart(2,'0');const day=dateInfo.getUTCDate().toString().padStart(2,'0');return`${year}-${month}-${day}`;}return'';}
function parseExcelNumber(value){if(typeof value==='number')return value;if(typeof value==='string'){value=value.trim();value=value.replace(/,/g,'');value=value.replace(/\s/g,'');value=value.replace('S/.','');value=value.replace('S/','');const num=parseFloat(value);return isNaN(num)?0:num;}return 0;}
function cleanText(text){if(!text)return text;return text.replace(/ÔøΩ/g,'√±').replace(/√ë/g,'√ë').replace(/√±/g,'√±').replace(/√É¬±/g,'√±').replace(/√É'/g,'√ë').replace(/√É¬°/g,'√°').replace(/√É¬©/g,'√©').replace(/√É¬≠/g,'√≠').replace(/√É¬≥/g,'√≥').replace(/√É¬∫/g,'√∫').replace(/√É/g,'√Å').replace(/√É‚Ä∞/g,'√â').replace(/√É/g,'√ç').replace(/√É"/g,'√ì').replace(/√É≈°/g,'√ö').replace(/√°/g,'√°').replace(/√©/g,'√©').replace(/√≠/g,'√≠').replace(/√≥/g,'√≥').replace(/√∫/g,'√∫').replace(/√É¬º/g,'√º').replace(/√É¬§/g,'√§').replace(/√É¬∂/g,'√∂').replace(/√Ç¬ø/g,'¬ø').replace(/√Ç¬°/g,'¬°').replace(/√¢‚Ç¨≈ì/g,'"').replace(/√¢‚Ç¨/g,'"').replace(/√¢‚Ç¨‚Ñ¢/g,"'").replace(/√¢‚Ç¨Àú/g,"'").replace(/√¢‚Ç¨"/g,'‚Äì').replace(/√¢‚Ç¨"/g,'‚Äî').replace(/\u00f1/g,'√±').replace(/\u00d1/g,'√ë').replace(/\u00e1/g,'√°').replace(/\u00e9/g,'√©').replace(/\u00ed/g,'√≠').replace(/\u00f3/g,'√≥').replace(/\u00fa/g,'√∫').replace(/\u00c1/g,'√Å').replace(/\u00c9/g,'√â').replace(/\u00cd/g,'√ç').replace(/\u00d3/g,'√ì').replace(/\u00da/g,'√ö');}
function mapFrequency(freq){if(!freq)return'';const upperFreq=freq.toString().toUpperCase().trim();const mappings={'DIAR':'DIARIO','SEMA':'SEMANAL','QUIN':'QUINCENAL','MENS':'MENSUAL','DIARIO':'DIARIO','DIARIA':'DIARIO','SEMANAL':'SEMANAL','QUINCENAL':'QUINCENAL','MENSUAL':'MENSUAL','D':'DIARIO','S':'SEMANAL','Q':'QUINCENAL','M':'MENSUAL'};if(mappings[upperFreq]){return mappings[upperFreq];}if(upperFreq.includes('DIAR'))return'DIARIO';if(upperFreq.includes('SEMA'))return'SEMANAL';if(upperFreq.includes('QUIN'))return'QUINCENAL';if(upperFreq.includes('MENS'))return'MENSUAL';console.warn('Frecuencia no reconocida:',freq);return'';}
function handleExcelUpload(event){const file=event.target.files[0];if(!file)return;const reader=new FileReader();reader.onload=function(e){try{let fileContent=e.target.result;let data=[];let columnMap={};let isHtmlContent=false;if(file.name.toLowerCase().endsWith('.xls')){try{const decoder=new TextDecoder('windows-1252');fileContent=decoder.decode(new Uint8Array(fileContent));isHtmlContent=fileContent.includes('<table')||fileContent.includes('<TABLE')||fileContent.includes('<tr')||fileContent.includes('<TR');}catch(err){console.error('Error decodificando:',err);}}else{isHtmlContent=typeof fileContent==='string'&&(fileContent.includes('<table')||fileContent.includes('<TABLE')||fileContent.includes('<tr')||fileContent.includes('<TR'));}if(isHtmlContent){const htmlContent=fileContent;const rowMatches=htmlContent.match(/<tr[^>]*>[\s\S]*?<\/tr>/gi)||[];function extractCellContent(rowHtml){const cellMatches=rowHtml.match(/<t[hd][^>]*>([^<]*)<\/t[hd]>/gi)||[];return cellMatches.map(cell=>{const content=cell.replace(/<[^>]+>/g,'').trim();return cleanText(content);});}let headerRowIndex=-1;let headers=[];for(let i=0;i<rowMatches.length;i++){const cells=extractCellContent(rowMatches[i]);if(cells.some(cell=>cell==='Id'||cell==='Nombre')){headerRowIndex=i;headers=cells;break;}}if(headerRowIndex===-1){alert('No se encontraron las columnas esperadas en el archivo');return;}columnMap={id:headers.indexOf('Id'),nombre:headers.indexOf('Nombre'),telefono:headers.findIndex(h=>h.includes('Tel')),fechaDesem:headers.findIndex(h=>h.includes('Fecha Desem')),monto:headers.indexOf('Monto'),plz:headers.indexOf('Plz'),frecPago:headers.findIndex(h=>h.includes('Frec Pago')),montoCuota:headers.findIndex(h=>h.includes('Monto Cuota')),mora:headers.indexOf('Mora'),totalAtraso:headers.findIndex(h=>h.includes('Total Atraso')),diaAtr:headers.findIndex(h=>h.includes('Dia Atr')),totalDeuda:headers.findIndex(h=>h.includes('Total Deuda'))};console.log('Mapeo de columnas:',columnMap);console.log('Headers encontrados:',headers);for(let i=headerRowIndex+1;i<rowMatches.length;i++){const cells=extractCellContent(rowMatches[i]);if(cells.length>columnMap.id&&cells[columnMap.id]){data.push(cells);}}}else{const workbook=XLSX.read(new Uint8Array(fileContent),{type:'array',cellDates:false,raw:true});const firstSheet=workbook.Sheets[workbook.SheetNames[0]];const jsonData=XLSX.utils.sheet_to_json(firstSheet,{header:1,raw:true});if(jsonData.length<2){alert('El archivo Excel est√° vac√≠o o no tiene el formato correcto');return;}const headers=jsonData[0];console.log('Headers encontrados:',headers);columnMap={id:headers.indexOf('Id'),nombre:headers.indexOf('Nombre'),telefono:headers.findIndex(h=>h&&h.toString().includes('Tel')),fechaDesem:headers.findIndex(h=>h&&h.toString().includes('Fecha Desem')),monto:headers.indexOf('Monto'),plz:headers.indexOf('Plz'),frecPago:headers.findIndex(h=>h&&h.toString().includes('Frec Pago')),montoCuota:headers.findIndex(h=>h&&h.toString().includes('Monto Cuota')),mora:headers.indexOf('Mora'),totalAtraso:headers.findIndex(h=>h&&h.toString().includes('Total Atraso')),diaAtr:headers.findIndex(h=>h&&h.toString().includes('Dia Atr')),totalDeuda:headers.findIndex(h=>h&&h.toString().includes('Total Deuda'))};data=jsonData.slice(1);}let updatedCount=0;let addedCount=0;let errorCount=0;const errors=[];for(let i=0;i<data.length;i++){const row=data[i];if(!row[columnMap.id]||!row[columnMap.nombre])continue;try{const id=row[columnMap.id].toString().trim();const name=cleanText(row[columnMap.nombre].toString().trim());const phone=columnMap.telefono>=0&&row[columnMap.telefono]?row[columnMap.telefono].toString().trim():'';const disbursementDate=columnMap.fechaDesem>=0&&row[columnMap.fechaDesem]?formatExcelDate(row[columnMap.fechaDesem]):'';const monto=columnMap.monto>=0&&row[columnMap.monto]?parseExcelNumber(row[columnMap.monto]):0;const term=columnMap.plz>=0&&row[columnMap.plz]?parseInt(row[columnMap.plz]):0;const frequency=columnMap.frecPago>=0&&row[columnMap.frecPago]?mapFrequency(row[columnMap.frecPago].toString().trim()):'';const quota=columnMap.montoCuota>=0&&row[columnMap.montoCuota]?parseExcelNumber(row[columnMap.montoCuota]):0;const mora=columnMap.mora>=0&&row[columnMap.mora]?parseExcelNumber(row[columnMap.mora]):0;const totalAtraso=columnMap.totalAtraso>=0&&row[columnMap.totalAtraso]?parseExcelNumber(row[columnMap.totalAtraso]):0;const diasAtraso=columnMap.diaAtr>=0&&row[columnMap.diaAtr]?parseInt(row[columnMap.diaAtr]):0;
const totalDeuda=columnMap.totalDeuda>=0&&row[columnMap.totalDeuda]?parseExcelNumber(row[columnMap.totalDeuda]):0;if(!disbursementDate){errors.push(`Fila ${i+1}: Fecha de desembolso inv√°lida para ${name}`);errorCount++;continue;}if(!term||term<=0){errors.push(`Fila ${i+1}: Plazo inv√°lido para ${name}`);errorCount++;continue;}if(!frequency){errors.push(`Fila ${i+1}: Frecuencia inv√°lida para ${name} (valor original: "${columnMap.frecPago>=0&&row[columnMap.frecPago]?row[columnMap.frecPago]:'vac√≠o'}")`);errorCount++;continue;}if(!quota||quota<=0){errors.push(`Fila ${i+1}: Monto de cuota inv√°lido para ${name}`);errorCount++;continue;}const existingClient=clients.find(c=>c.id===id);if(existingClient){existingClient.name=name;existingClient.phone=phone;existingClient.disbursementDate=disbursementDate;existingClient.term=term;existingClient.frequency=frequency;existingClient.quota=quota;existingClient.monto=monto;existingClient.mora=mora;existingClient.totalAtraso=totalAtraso;existingClient.diasAtraso=diasAtraso;existingClient.totalDeuda=totalDeuda;updatedCount++;console.log('Cliente actualizado:',existingClient);}else{const newClient={id:id,name:name,phone:phone,disbursementDate:disbursementDate,frequency:frequency,quota:quota,term:term,monto:monto,mora:mora,totalAtraso:totalAtraso,diasAtraso:diasAtraso,totalDeuda:totalDeuda,createdAt:getPeruvianISOString()};clients.push(newClient);addedCount++;console.log('Cliente agregado:',newClient);}}catch(err){errors.push(`Fila ${i+1}: Error al procesar - ${err.message}`);errorCount++;}}saveData();updateDisplay();let message=`Archivo procesado:\n- Clientes nuevos: ${addedCount}\n- Clientes actualizados: ${updatedCount}`;const morosidadCount=clients.filter(c=>c.diasAtraso>0).length;message+=`\n- Clientes en mora: ${morosidadCount}`;if(errorCount>0){message+=`\n- Errores: ${errorCount}\n\nDetalles de errores:\n${errors.slice(0,5).join('\n')}`;if(errors.length>5){message+=`\n... y ${errors.length-5} errores m√°s`;}}alert(message);event.target.value='';}catch(error){alert('Error al procesar el archivo. Aseg√∫rate de que sea un archivo Excel v√°lido.\n\nError: '+error.message);console.error('Error completo:',error);event.target.value='';}};if(file.name.toLowerCase().endsWith('.xls')){reader.readAsArrayBuffer(file);}else{reader.readAsArrayBuffer(file);}}
const excelClients=[];
function init(){loadData();importExcelClients();setToday();updateDisplay();document.addEventListener('click',function(e){if(!e.target.closest('.form-group')){hideClientDropdown();}});}
function importExcelClients(){localStorage.removeItem('excelClientsImported');localStorage.removeItem('excelClientsImported_v2');localStorage.removeItem('excelClientsImported_v3');localStorage.removeItem('excelClientsImported_v4');localStorage.removeItem('excelClientsImported_v5');localStorage.removeItem('excelClientsImported_v6');localStorage.removeItem('excelClientsImported_v7');localStorage.removeItem('excelClientsImported_v8');localStorage.removeItem('excelClientsImported_v9');localStorage.removeItem('excelClientsImported_v10');const savedImport=localStorage.getItem('excelClientsImported_v11');if(!savedImport){excelClients.forEach(excelClient=>{const existingClient=clients.find(c=>c.id===excelClient.id);if(existingClient){existingClient.quota=excelClient.quota;existingClient.term=excelClient.term;existingClient.disbursementDate=excelClient.disbursementDate;existingClient.frequency=excelClient.frequency;existingClient.phone=excelClient.phone;existingClient.name=excelClient.name;}else{clients.push({id:excelClient.id,name:excelClient.name,phone:excelClient.phone,disbursementDate:excelClient.disbursementDate,frequency:excelClient.frequency,quota:excelClient.quota,term:excelClient.term,createdAt:getPeruvianISOString()});}});localStorage.setItem('excelClientsImported_v11','true');saveData();}}
function searchAllClients(){const searchTerm=document.getElementById('generalClientSearch').value.toLowerCase();const resultsContainer=document.getElementById('searchResults');if(searchTerm===''){resultsContainer.style.display='none';return;}const filteredClients=clients.filter(client=>client.name.toLowerCase().includes(searchTerm)||client.id.includes(searchTerm)||(client.phone&&client.phone.includes(searchTerm)));resultsContainer.style.display='block';if(filteredClients.length===0){resultsContainer.innerHTML='<div class="no-results" style="padding: 15px; text-align: center; color: #888;">No se encontraron clientes</div>';}else{resultsContainer.innerHTML=filteredClients.map(client=>`<div class="search-result-item" onclick="showClientDetailsModal('${client.id}')"><div style="font-size:11px;color:#999;">ID:${client.id}</div><div style="font-weight:600;">${client.name}</div>${client.phone?`<div style="font-size:13px;color:#666;">${client.phone}</div>`:''}</div>`).join('');}}
function showClientDetailsModal(clientId){const client=clients.find(c=>c.id===clientId);if(!client)return;const today=getPeruvianDate();const nextPaymentInfo=getNextPaymentDate(client);const clientPayments=payments.filter(p=>p.clientId===clientId);const totalPaid=clientPayments.reduce((sum,p)=>sum+p.amount,0);const totalDeuda=client.totalDeuda||(client.quota?(client.quota*client.term)-totalPaid:0);const content=document.getElementById('clientDetailsContent');content.innerHTML=`<div class="client-detail-info"><div class="detail-row"><span class="detail-label">ID:</span><span class="detail-value">${client.id}</span></div><div class="detail-row"><span class="detail-label">Nombre:</span><span class="detail-value">${client.name}</span></div><div class="detail-row"><span class="detail-label">Tel√©fono:</span><span class="detail-value">${client.phone||'No registrado'}</span></div><div class="detail-row"><span class="detail-label">Fecha de desembolso:</span><span class="detail-value">${client.disbursementDate?formatPeruvianDate(client.disbursementDate):'N/A'}</span></div><div class="detail-row"><span class="detail-label">Frecuencia:</span><span class="detail-value">${client.frequency||'N/A'}</span></div><div class="detail-row"><span class="detail-label">Cuota:</span><span class="detail-value" style="color:var(--primary-color);">S/${client.quota?formatNumber(client.quota):'0.00'}</span></div><div class="detail-row"><span class="detail-label">Plazo:</span><span class="detail-value">${client.term?formatInteger(client.term):'N/A'} cuotas</span></div>${client.diasAtraso>0?`<div class="detail-row"><span class="detail-label">D√≠as de atraso:</span><span class="detail-value" style="color:var(--danger-color);">${client.diasAtraso} d√≠as</span></div><div class="detail-row"><span class="detail-label">Mora:</span><span class="detail-value" style="color:var(--danger-color);">S/${formatNumber(client.mora||0)}</span></div><div class="detail-row"><span class="detail-label">Total atraso:</span><span class="detail-value" style="color:var(--danger-color);">S/${formatNumber(client.totalAtraso||0)}</span></div>`:''}<div class="detail-row"><span class="detail-label">Pr√≥ximo pago:</span><span class="detail-value">${nextPaymentInfo}</span></div><div class="detail-row"><span class="detail-label">Total pagado:</span><span class="detail-value" style="color:var(--success-color);">S/${formatNumber(totalPaid)}</span></div><div class="detail-row"><span class="detail-label">Total deuda:</span><span class="detail-value" style="color:var(--danger-color);">S/${formatNumber(totalDeuda)}</span></div><div class="detail-row"><span class="detail-label">N√∫mero de pagos:</span><span class="detail-value">${formatInteger(clientPayments.length)}</span></div><div class="action-buttons"><button class="btn btn-action btn-schedule" onclick="showPaymentSchedule('${client.id}')">Crono</button><button class="btn btn-action btn-movements" onclick="showClientMovements('${client.id}')">Movim.</button>${client.phone?`<button class="btn btn-action btn-call" onclick="makeCall('${client.phone}')">Llamar</button><button class="btn btn-action btn-whatsapp" onclick="openWhatsApp('${client.phone}')">WhatsApp</button>`:''}<button class="btn btn-action btn-edit-client" onclick="showEditClientModal('${client.id}')">Modificar</button><button class="btn btn-action btn-delete-client" onclick="deleteClientFromDetails('${client.id}')">Eliminar</button></div></div>`;showModal('clientDetailsModal');}
function showClientMovements(clientId){const client=clients.find(c=>c.id===clientId);if(!client)return;const clientPayments=payments.filter(p=>p.clientId===clientId).sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp));let movementsHTML=`<div style="margin-bottom:20px;"><h4 style="margin:0;">${client.name}</h4><p style="margin:5px 0;color:#666;">ID: ${client.id}</p></div>`;if(clientPayments.length===0){movementsHTML+=`<div class="empty-state">No hay movimientos registrados para este cliente</div>`;}else{movementsHTML+=`<div class="movements-list" style="max-height: 400px; overflow-y: auto;">`;clientPayments.forEach(payment=>{const methodIcon=payment.method==='yape'?'üì±':'üíµ';const methodText=payment.method==='yape'?'Yape':'Efectivo';movementsHTML+=`<div class="payment-item"><div style="font-weight:600;">${formatPeruvianDate(payment.date)}</div><div class="payment-details"><div><span class="payment-method method-${payment.method}">${methodIcon} ${methodText}</span>${payment.note?`<div style="font-size:12px;color:#999;margin-top:3px;">${payment.note}</div>`:''}</div><div class="payment-amount">S/${formatNumber(payment.amount)}</div></div><div style="font-size:11px;color:#999;margin-top:5px; text-align: right;">${formatPeruvianTime(payment.timestamp)}</div></div>`;});movementsHTML+=`</div>`;const totalPaid=clientPayments.reduce((sum,p)=>sum+p.amount,0);movementsHTML+=`<div style="margin-top:20px;padding:15px;background:#f8f9fa;border-radius:8px;"><div style="display:flex;justify-content:space-between;"><strong>Total de movimientos:</strong><span style="color:var(--success-color);font-weight:bold;">S/${formatNumber(totalPaid)}</span></div></div>`;}document.getElementById('movementsModalContent').innerHTML=movementsHTML;showModal('movementsModal');}
function deleteClientFromDetails(clientId){if(confirm('¬øEst√°s seguro de eliminar este cliente? Se mantendr√°n los pagos hist√≥ricos.')){clients=clients.filter(c=>c.id!==clientId);saveData();updateDisplay();closeModal('clientDetailsModal');}}
function getNextPaymentDate(client){if(!client.disbursementDate){return'N/A';}const today=getPeruvianDateString();const todayParts=today.split('-');const todayDate=new Date(parseInt(todayParts[0]),parseInt(todayParts[1])-1,parseInt(todayParts[2]));for(let i=1;i<=60;i++){const checkDate=new Date(todayDate);checkDate.setDate(checkDate.getDate()+i);const checkDateStr=`${checkDate.getFullYear()}-${String(checkDate.getMonth()+1).padStart(2,'0')}-${String(checkDate.getDate()).padStart(2,'0')}`;if(shouldPayOnDate(client,checkDateStr)){return`${String(checkDate.getDate()).padStart(2,'0')}/${String(checkDate.getMonth()+1).padStart(2,'0')}/${checkDate.getFullYear()}`;}}return'N/A';}
function shouldPayOnDate(client,checkDate){if(!client.disbursementDate||!client.frequency){return false;}const[disbYear,disbMonth,disbDay]=client.disbursementDate.split('-').map(n=>parseInt(n));const[checkYear,checkMonth,checkDay]=checkDate.split('-').map(n=>parseInt(n));if(isNaN(disbYear)||isNaN(disbMonth)||isNaN(disbDay)||isNaN(checkYear)||isNaN(checkMonth)||isNaN(checkDay)){console.warn('Fecha inv√°lida en shouldPayOnDate:',client.disbursementDate,checkDate);return false;}const disbursementDate=new Date(disbYear,disbMonth-1,disbDay);const targetDate=new Date(checkYear,checkMonth-1,checkDay);if(targetDate<=disbursementDate){return false;}const daysDiff=Math.floor((targetDate-disbursementDate)/(1000*60*60*24));const dayOfWeek=targetDate.getDay();switch(client.frequency){case'DIARIO':return dayOfWeek>=1&&dayOfWeek<=5&&daysDiff>=1;case'SEMANAL':return daysDiff>0&&daysDiff%7===0;case'QUINCENAL':return daysDiff>0&&daysDiff%15===0;case'MENSUAL':if(daysDiff<28)return false;const monthsDiff=(checkYear-disbYear)*12+(checkMonth-disbMonth);if(monthsDiff<1)return false;if(checkDay===disbDay){return true;}const lastDayOfTargetMonth=new Date(checkYear,checkMonth,0).getDate();if(checkDay===lastDayOfTargetMonth&&disbDay>lastDayOfTargetMonth){return true;}if(disbDay>28&&checkDay===lastDayOfTargetMonth){return true;}return false;default:console.warn('Frecuencia no reconocida:',client.frequency);return false;}}
function loadData(){const savedClients=localStorage.getItem('clients');const savedPayments=localStorage.getItem('payments');if(savedClients)clients=JSON.parse(savedClients);if(savedPayments)payments=JSON.parse(savedPayments);}
function saveData(){localStorage.setItem('clients',JSON.stringify(clients));localStorage.setItem('payments',JSON.stringify(payments));}
function setToday(){const today=getPeruvianDateString();document.getElementById('dateFilter').value=today;updateDisplay();}
function updateDisplay(){const selectedDate=document.getElementById('dateFilter').value;updateStats(selectedDate);updateDebtClients();updateClientsList(selectedDate);updatePaymentsList(selectedDate);}
function updateDebtClients(){const debtClients=clients.filter(c=>c.diasAtraso>0);const debtSection=document.getElementById('debtClientsSection');const debtList=document.getElementById('debtClientsList');if(debtClients.length===0){debtSection.style.display='none';return;}debtSection.style.display='block';debtList.innerHTML=debtClients.sort((a,b)=>b.diasAtraso-a.diasAtraso).map(client=>{return`<div class="client-item" onclick="showClientDetailsModal('${client.id}')"><div style="flex:1;"><div class="client-name">${client.name}</div><div class="client-info-sub"><span class="client-status status-pending" style="background: #fdedec; color: #e74c3c;">${client.diasAtraso} d√≠as atraso</span><span style="color: #e74c3c;">Total: S/${formatNumber(client.totalAtraso||0)}</span></div></div><button class="btn-circle pay" onclick="event.stopPropagation();quickPaymentDebt('${client.id}');" title="Pago r√°pido"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M1 3a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1zm7 8a2 2 0 1 0 0-4 2 2 0 0 0 0 4"/><path d="M0 5a1 1 0 0 1 1-1h14a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1H1a1 1 0 0 1-1-1z"/></svg></button></div>`;}).join('');}
function updateStats(date){const dayPayments=payments.filter(p=>p.date===date);const total=dayPayments.reduce((sum,p)=>sum+p.amount,0);const uniqueClients=new Set(dayPayments.map(p=>p.clientId)).size;const cashTotal=dayPayments.filter(p=>p.method==='efectivo').reduce((sum,p)=>sum+p.amount,0);const yapeTotal=dayPayments.filter(p=>p.method==='yape').reduce((sum,p)=>sum+p.amount,0);document.getElementById('totalPaid').textContent=`S/${formatNumber(total)}`;document.getElementById('clientsPaid').textContent=formatInteger(uniqueClients);document.getElementById('totalCash').textContent=`S/${formatNumber(cashTotal)}`;document.getElementById('totalYape').textContent=`S/${formatNumber(yapeTotal)}`;}
function updateClientsList(date){const clientsList=document.getElementById('clientsList');const dayPayments=payments.filter(p=>p.date===date);const clientsToPayToday=clients.filter(client=>shouldPayOnDate(client,date));if(clientsToPayToday.length===0){clientsList.innerHTML='<div class="empty-state" style="padding: 40px; text-align: center; color: #888;">No hay clientes que deban pagar hoy</div>';return;}clientsList.innerHTML=clientsToPayToday.map(client=>{const clientPayments=dayPayments.filter(p=>p.clientId===client.id);const hasPaid=clientPayments.length>0;const totalPaid=clientPayments.reduce((sum,p)=>sum+p.amount,0);const displayQuota=client.diasAtraso>0?client.totalAtraso:client.quota;const freqClass={'DIARIO':'freq-diario','SEMANAL':'freq-semanal','QUINCENAL':'freq-quincenal','MENSUAL':'freq-mensual'}[client.frequency];return`<div class="client-item" onclick="showClientDetailsModal('${client.id}')"><div style="flex:1;"><div class="client-name">${client.name}</div><div class="client-info-sub"><span class="client-status ${hasPaid?'status-paid':'status-pending'}">${hasPaid?'Pag√≥':'Pendiente'}</span><span class="frequency-badge ${freqClass}">${client.frequency}</span><span style="font-weight: 600; color: var(--primary-color);">S/${formatNumber(displayQuota)}</span></div>${hasPaid?`<div style="font-size:12px;color:var(--success-color); margin-top: 4px;">Pag√≥: S/${formatNumber(totalPaid)}</div>`:''}</div><div class="client-actions"><button class="btn-circle pay" onclick="event.stopPropagation();quickPayment('${client.id}');" title="Pago r√°pido"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M1 3a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1zm7 8a2 2 0 1 0 0-4 2 2 0 0 0 0 4"/><path d="M0 5a1 1 0 0 1 1-1h14a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1H1a1 1 0 0 1-1-1z"/></svg></button></div></div>`;}).join('');}
function selectPaymentType(type){selectedPaymentType=type;const buttons=document.querySelectorAll('.payment-type-btn');buttons.forEach(btn=>btn.classList.remove('active'));event.target.closest('.payment-type-btn').classList.add('active');document.getElementById('paymentInputsContainer').style.display='block';const clientId=document.getElementById('selectedClientId').value;if(clientId){const client=clients.find(c=>c.id===clientId);if(client){const montoSugerido=client.diasAtraso>0?client.totalAtraso:client.quota;if(type==='parcial'){document.getElementById('singlePaymentInputs').style.display='none';document.getElementById('partialPaymentInputs').style.display='block';document.getElementById('paymentAmountCash').value=montoSugerido||'0';document.getElementById('paymentAmountYape').value='0';updatePaymentTotal();}else{document.getElementById('partialPaymentInputs').style.display='none';document.getElementById('singlePaymentInputs').style.display='block';const label=type==='efectivo'?'üíµ Monto en Efectivo':'üì± Monto en Yape';document.getElementById('singlePaymentLabel').textContent=label;document.getElementById('paymentAmountSingle').value=montoSugerido||'';}}}else{if(type==='parcial'){document.getElementById('singlePaymentInputs').style.display='none';document.getElementById('partialPaymentInputs').style.display='block';document.getElementById('paymentAmountCash').value='0';document.getElementById('paymentAmountYape').value='0';updatePaymentTotal();}else{document.getElementById('partialPaymentInputs').style.display='none';document.getElementById('singlePaymentInputs').style.display='block';const label=type==='efectivo'?'üíµ Monto en Efectivo':'üì± Monto en Yape';document.getElementById('singlePaymentLabel').textContent=label;document.getElementById('paymentAmountSingle').value='';}}}
function updatePaymentTotal(){const cashAmount=parseFloat(document.getElementById('paymentAmountCash').value)||0;const yapeAmount=parseFloat(document.getElementById('paymentAmountYape').value)||0;const total=cashAmount+yapeAmount;document.getElementById('paymentTotal').textContent=`S/${formatNumber(total)}`;}
function updatePaymentsList(date){const paymentsList=document.getElementById('paymentsList');const dayPayments=payments.filter(p=>p.date===date);if(dayPayments.length===0){paymentsList.innerHTML='<div class="empty-state" style="padding: 40px; text-align: center; color: #888;">No hay pagos registrados</div>';return;}const groupedPayments={};dayPayments.forEach(payment=>{if(!groupedPayments[payment.timestamp]){groupedPayments[payment.timestamp]=[];}groupedPayments[payment.timestamp].push(payment);});const sortedGroups=Object.entries(groupedPayments).sort((a,b)=>new Date(b[0])-new Date(a[0]));paymentsList.innerHTML=sortedGroups.map(([timestamp,paymentGroup])=>{const client=clients.find(c=>c.id===paymentGroup[0].clientId);const totalAmount=paymentGroup.reduce((sum,p)=>sum+p.amount,0);const hasCash=paymentGroup.some(p=>p.method==='efectivo');const hasYape=paymentGroup.some(p=>p.method==='yape');const isMixed=hasCash&&hasYape;let methodDisplay='';if(isMixed){const cashAmount=paymentGroup.filter(p=>p.method==='efectivo').reduce((sum,p)=>sum+p.amount,0);const yapeAmount=paymentGroup.filter(p=>p.method==='yape').reduce((sum,p)=>sum+p.amount,0);methodDisplay=`<span class="payment-method method-mixto">Mixto</span><div style="font-size:11px;color:#666;margin-top:3px;">Efectivo: S/${formatNumber(cashAmount)} | Yape: S/${formatNumber(yapeAmount)}</div>`;}else{const payment=paymentGroup[0];const methodClass=payment.method==='yape'?'method-yape':'method-efectivo';const methodText=payment.method==='yape'?'Yape':'Efectivo';methodDisplay=`<span class="payment-method ${methodClass}">${methodText}</span>`;}return`<div class="payment-item"><div style="font-size: 11px; color: #888; margin-bottom: 4px;">ID: ${client ? client.id : 'N/A'}</div><div class="payment-client"><span>${client?client.name:'Cliente eliminado'}</span><span class="payment-amount">S/${formatNumber(totalAmount)}</span></div><div class="payment-details"><span>${paymentGroup[0].note||'Sin nota'}</span>${methodDisplay}</div><div class="payment-details"><span>${formatPeruvianTime(paymentGroup[0].timestamp)}</span><button class="btn btn-danger" style="padding: 4px 8px; font-size: 12px;" onclick="deletePaymentGroup('${timestamp}')">Eliminar</button></div></div>`;}).join('');}
function showClientDropdown(){const dropdown=document.getElementById('clientDropdown');dropdown.style.display='block';filterModalClients();}
function hideClientDropdown(){const dropdown=document.getElementById('clientDropdown');dropdown.style.display='none';}
function filterModalClients(){const searchTerm=document.getElementById('clientSearchModal').value.toLowerCase();const dropdown=document.getElementById('clientDropdown');const filteredClients=clients.filter(client=>client.name.toLowerCase().includes(searchTerm)||(client.phone&&client.phone.includes(searchTerm)));if(filteredClients.length===0){dropdown.innerHTML='<div class="no-results" style="padding: 12px; text-align: center; color: #888;">No se encontraron clientes</div>';}else{dropdown.innerHTML=filteredClients.map(client=>{const displayQuota=client.diasAtraso>0?client.totalAtraso:client.quota;return`<div class="dropdown-item" style="padding: 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0;" onclick="selectClient('${client.id}','${client.name}',${displayQuota||0})"><div class="dropdown-item-name" style="font-weight: 500;">${client.name}${client.diasAtraso>0?'<span style="margin-left:8px;font-size:10px; background: #e74c3c; color: white; padding: 2px 6px; border-radius: 10px;">En mora</span>':''}</div>${client.phone?`<div class="dropdown-item-phone" style="font-size: 12px; color: #666;">${client.phone}</div>`:''}<div style="font-size:12px;color:var(--primary-color);margin-top:3px; font-weight: 600;">Sugerido: S/${formatNumber(displayQuota||0)}</div></div>`;}).join('');}}
function selectClient(clientId,clientName,quota){document.getElementById('selectedClientId').value=clientId;document.getElementById('clientSearchModal').value=clientName;hideClientDropdown();const client=clients.find(c=>c.id===clientId);if(!client)return;let montoSugerido=0;if(client.diasAtraso>0){montoSugerido=client.totalAtraso||0;}else{montoSugerido=client.quota||0;}if(selectedPaymentType){if(selectedPaymentType==='parcial'&&montoSugerido>0){document.getElementById('paymentAmountCash').value=montoSugerido;document.getElementById('paymentAmountYape').value='0';updatePaymentTotal();}else if(selectedPaymentType!=='parcial'&&montoSugerido>0){document.getElementById('paymentAmountSingle').value=montoSugerido;}}}
let modalZIndex = 1000;
function showModal(modalId){
    const modal = document.getElementById(modalId);
    if(!modal) return; 

    if (!document.querySelector('.modal.show')) {
        scrollPosition = window.pageYOffset || document.documentElement.scrollTop;
        document.body.style.overflow = 'hidden';
    }
    
    modalZIndex++;
    modal.style.zIndex = modalZIndex;
    modal.classList.add('show');
}
function closeModal(modalId){
    const modal = document.getElementById(modalId); 
    if(!modal) return; 
    
    modal.classList.remove('show');
    
    const anyModalOpen = document.querySelector('.modal.show');

    if (!anyModalOpen) {
        document.body.style.overflow = '';
        window.scrollTo(0, scrollPosition);
        modalZIndex = 1000;
    }

    if(modalId === 'addPaymentModal'){
        document.getElementById('clientSearchModal').value='';
        document.getElementById('selectedClientId').value='';
        document.getElementById('paymentAmountSingle').value='';
        document.getElementById('paymentAmountCash').value='0';
        document.getElementById('paymentAmountYape').value='0';
        updatePaymentTotal();
        hideClientDropdown();
        selectedPaymentType='';
        document.querySelectorAll('.payment-type-btn').forEach(btn=>btn.classList.remove('active'));
        document.getElementById('paymentInputsContainer').style.display='none';
    }
}
function showAddClientModal(){document.getElementById('clientId').value='';document.getElementById('clientName').value='';document.getElementById('clientPhone').value='';document.getElementById('clientDisbursementDate').value='';document.getElementById('clientFrequency').value='';document.getElementById('clientQuota').value='';document.getElementById('clientTerm').value='';showModal('addClientModal');}
function showAddPaymentModal(){if(clients.length===0){alert('Primero debes agregar al menos un cliente');return;}document.getElementById('clientSearchModal').value='';document.getElementById('selectedClientId').value='';document.getElementById('paymentAmountSingle').value='';document.getElementById('paymentAmountCash').value='0';document.getElementById('paymentAmountYape').value='0';document.getElementById('paymentNote').value='';updatePaymentTotal();selectedPaymentType='';document.querySelectorAll('.payment-type-btn').forEach(btn=>btn.classList.remove('active'));document.getElementById('paymentInputsContainer').style.display='none';showModal('addPaymentModal');}
function addClient(event){event.preventDefault();const id=document.getElementById('clientId').value.trim();const name=document.getElementById('clientName').value.trim();const phone=document.getElementById('clientPhone').value.trim();const disbursementDate=document.getElementById('clientDisbursementDate').value;const frequency=document.getElementById('clientFrequency').value;const quota=parseFloat(document.getElementById('clientQuota').value);const term=parseInt(document.getElementById('clientTerm').value);if(clients.find(c=>c.id===id)){alert('Ya existe un cliente con ese ID');return;}const newClient={id:id,name:name,phone:phone,disbursementDate:disbursementDate,frequency:frequency,quota:quota,term:term,createdAt:getPeruvianISOString()};clients.push(newClient);saveData();updateDisplay();closeModal('addClientModal');}
function addPayment(event){event.preventDefault();const clientId=document.getElementById('selectedClientId').value;const note=document.getElementById('paymentNote').value.trim();const date=document.getElementById('dateFilter').value;if(!clientId){alert('Por favor selecciona un cliente de la lista');return;}if(!selectedPaymentType){alert('Por favor selecciona un tipo de pago');return;}let cashAmount=0;let yapeAmount=0;if(selectedPaymentType==='efectivo'){const amount=parseFloat(document.getElementById('paymentAmountSingle').value)||0;if(amount<=0){alert('Por favor ingresa un monto v√°lido');return;}cashAmount=amount;}else if(selectedPaymentType==='yape'){const amount=parseFloat(document.getElementById('paymentAmountSingle').value)||0;if(amount<=0){alert('Por favor ingresa un monto v√°lido');return;}yapeAmount=amount;}else if(selectedPaymentType==='parcial'){cashAmount=parseFloat(document.getElementById('paymentAmountCash').value)||0;yapeAmount=parseFloat(document.getElementById('paymentAmountYape').value)||0;if(cashAmount===0&&yapeAmount===0){alert('Por favor ingresa al menos un monto');return;}}const timestamp=getPeruvianISOString();if(cashAmount>0){const cashPayment={id:Date.now().toString()+'_cash',clientId:clientId,amount:cashAmount,method:'efectivo',note:note+(yapeAmount>0?' (Pago parcial - Efectivo)':''),date:date,timestamp:timestamp};payments.push(cashPayment);}if(yapeAmount>0){const yapePayment={id:Date.now().toString()+'_yape',clientId:clientId,amount:yapeAmount,method:'yape',note:note+(cashAmount>0?' (Pago parcial - Yape)':''),date:date,timestamp:timestamp};payments.push(yapePayment);}saveData();updateDisplay();closeModal('addPaymentModal');}
function deleteClient(clientId,event){event.stopPropagation();if(confirm('¬øEst√°s seguro de eliminar este cliente? Se mantendr√°n los pagos hist√≥ricos.')){clients=clients.filter(c=>c.id!==clientId);saveData();updateDisplay();}}
function deletePaymentGroup(timestamp){if(confirm('¬øEst√°s seguro de eliminar este pago?')){payments=payments.filter(p=>p.timestamp!==timestamp);saveData();updateDisplay();}}
document.getElementById('dateFilter').addEventListener('change',updateDisplay);
window.onclick=function(event){if(event.target.classList.contains('modal')){const modalId=event.target.id;closeModal(modalId);}}
document.addEventListener('touchstart',function(e){if(e.touches.length>1){e.preventDefault();}});
if(window.navigator.standalone){document.addEventListener('click',function(e){if(e.target.tagName==='INPUT'||e.target.tagName==='TEXTAREA'||e.target.tagName==='SELECT'){e.target.focus();}});}
function showPaymentSchedule(clientId){const client=clients.find(c=>c.id===clientId);if(!client){alert('Cliente no encontrado');return;}if(!client.disbursementDate){alert('Este cliente no tiene fecha de desembolso registrada. Por favor, edita el cliente y agrega esta informaci√≥n.');return;}if(!client.term||client.term<=0){alert('Este cliente no tiene un plazo v√°lido registrado. Por favor, edita el cliente y agrega esta informaci√≥n.');return;}if(!client.frequency){alert('Este cliente no tiene frecuencia de pago registrada. Por favor, edita el cliente y agrega esta informaci√≥n.');return;}if(!client.quota||client.quota<=0){alert('Este cliente no tiene monto de cuota v√°lido. Por favor, edita el cliente y agrega esta informaci√≥n.');return;}console.log('Generando cronograma para:',client);const clientPayments=payments.filter(p=>p.clientId===clientId);const paymentDates=[];const[year,month,day]=client.disbursementDate.split('-').map(n=>parseInt(n));const startDate=new Date(year,month-1,day);if(isNaN(startDate.getTime())){alert('La fecha de desembolso del cliente no es v√°lida. Por favor, verifica los datos.');return;}let currentDate=new Date(startDate);let paymentCount=0;const maxDays=client.frequency==='MENSUAL'?client.term*31:365;while(paymentCount<client.term&&currentDate<=new Date(startDate.getTime()+(maxDays*24*60*60*1000))){const dateStr=`${currentDate.getFullYear()}-${String(currentDate.getMonth()+1).padStart(2,'0')}-${String(currentDate.getDate()).padStart(2,'0')}`;if(shouldPayOnDate(client,dateStr)){paymentDates.push(new Date(currentDate));paymentCount++;}currentDate.setDate(currentDate.getDate()+1);}if(paymentDates.length===0){alert('No se pudo generar el cronograma. Verifica que la frecuencia y fecha de desembolso sean correctas.');return;}let scheduleHTML=`<div style="margin-bottom:20px;"><h4 style="margin:0;">Cliente:${client.name}</h4><p style="margin:5px 0;color:#666;">ID:${client.id}</p><p style="margin:5px 0;color:#666;">Frecuencia:${client.frequency} | Plazo:${formatInteger(client.term)} cuotas | Cuota:S/${formatNumber(client.quota)}</p></div><table class="styled-table"><thead><tr><th>N¬∞</th><th>F. Pago</th><th>Monto</th><th>Estado</th></tr></thead><tbody>`;const today=getPeruvianDateString();const totalPagadoReal=clientPayments.reduce((sum,p)=>sum+p.amount,0);let saldoDisponible=totalPagadoReal;paymentDates.forEach((date,index)=>{const dateStr=date.toISOString().split('T')[0];const formattedDate=formatPeruvianDate(dateStr);let statusIcon='';let statusClass='';if(saldoDisponible>=client.quota){statusIcon='‚úì Pagado';statusClass='paid';saldoDisponible-=client.quota;}else if(saldoDisponible>0){const porcentaje=Math.round((saldoDisponible/client.quota)*100);statusIcon=`Parcial (${porcentaje}%)`;statusClass='partial';saldoDisponible=0;}else if(dateStr<today){statusIcon='‚úó Vencido';statusClass='pending';}else if(dateStr===today){statusIcon='‚è∞ Hoy';statusClass='pending';}else{statusIcon='- Futuro';statusClass='future';}scheduleHTML+=`<tr class="${statusClass}"><td>${index+1}</td><td>${formattedDate}</td><td>S/${formatNumber(client.quota)}</td><td>${statusIcon}</td></tr>`;});const totalEsperado=client.quota*client.term;const saldoPendiente=totalEsperado-totalPagadoReal;scheduleHTML+=`</tbody></table><div style="margin-top:20px;padding:15px;background:#f8f9fa;border-radius:8px;"><div style="display:flex;justify-content:space-between;margin-bottom:8px;"><strong>Total esperado:</strong><span>S/${formatNumber(totalEsperado)}</span></div><div style="display:flex;justify-content:space-between;margin-bottom:8px;"><strong>Total pagado:</strong><span style="color:var(--success-color);">S/${formatNumber(totalPagadoReal)}</span></div><div style="display:flex;justify-content:space-between;"><strong>Saldo pendiente:</strong><span style="color:var(--danger-color);">S/${formatNumber(saldoPendiente)}</span></div></div>`;document.getElementById('scheduleModalContent').innerHTML=scheduleHTML;showModal('scheduleModal');}
function showEditClientModal(clientId){
    const client=clients.find(c=>c.id===clientId);
    if(!client)return;
    document.getElementById('editClientId').value=client.id;
    document.getElementById('editClientName').value=client.name;
    document.getElementById('editClientPhone').value=client.phone||'';
    document.getElementById('editClientDisbursementDate').value=client.disbursementDate||'';
    document.getElementById('editClientFrequency').value=client.frequency||'';
    document.getElementById('editClientQuota').value=client.quota||'';
    document.getElementById('editClientTerm').value=client.term||'';
    showModal('editClientModal');
}
function updateClient(event){event.preventDefault();const clientId=document.getElementById('editClientId').value;const client=clients.find(c=>c.id===clientId);if(!client)return;client.name=document.getElementById('editClientName').value.trim();client.phone=document.getElementById('editClientPhone').value.trim();client.disbursementDate=document.getElementById('editClientDisbursementDate').value;client.frequency=document.getElementById('editClientFrequency').value;client.quota=parseFloat(document.getElementById('editClientQuota').value);client.term=parseInt(document.getElementById('editClientTerm').value);saveData();updateDisplay();closeModal('editClientModal');alert('Cliente actualizado exitosamente');}
function quickPayment(clientId){const client=clients.find(c=>c.id===clientId);if(!client)return;const displayQuota=client.diasAtraso>0?client.totalAtraso:client.quota;showAddPaymentModal();setTimeout(()=>{document.getElementById('clientSearchModal').value=client.name;document.getElementById('selectedClientId').value=client.id;document.getElementById('paymentNote').value='Pago r√°pido';},100);}
function quickPaymentDebt(clientId){const client=clients.find(c=>c.id===clientId);if(!client)return;showAddPaymentModal();setTimeout(()=>{document.getElementById('clientSearchModal').value=client.name;document.getElementById('selectedClientId').value=client.id;document.getElementById('paymentNote').value='Pago de mora';},100);}
function showMorosidadModal(){const debtClients=clients.filter(c=>c.diasAtraso>0);if(debtClients.length===0){alert('No hay clientes en mora actualmente');return;}const totalMora=debtClients.reduce((sum,c)=>sum+(c.mora||0),0);const totalAtraso=debtClients.reduce((sum,c)=>sum+(c.totalAtraso||0),0);let modalHTML=`<div class="morosidad-stats" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;"><div class="morosidad-stat" style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;"><div class="morosidad-stat-value" style="font-size: 24px; font-weight: bold; color: var(--danger-color);">${formatInteger(debtClients.length)}</div><div class="morosidad-stat-label" style="font-size: 14px; color: #666; margin-top: 5px;">Clientes en Mora</div></div><div class="morosidad-stat" style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;"><div class="morosidad-stat-value" style="font-size: 24px; font-weight: bold; color: var(--danger-color);">S/${formatNumber(totalAtraso)}</div><div class="morosidad-stat-label" style="font-size: 14px; color: #666; margin-top: 5px;">Total Atraso</div></div></div><table class="styled-table"><thead><tr><th>ID</th><th>Nombre</th><th>Monto</th><th>Plazo</th><th>Frec. Pago</th><th>Mora</th><th>Total Atraso</th><th>Total Deuda</th><th>Acciones</th></tr></thead><tbody>`;debtClients.sort((a,b)=>b.diasAtraso-a.diasAtraso).forEach(client=>{const clientPayments=payments.filter(p=>p.clientId===client.id);const totalPaid=clientPayments.reduce((sum,p)=>sum+p.amount,0);const totalDeuda=client.totalDeuda||(client.quota||0)*(client.term||0)-totalPaid;modalHTML+=`<tr style="cursor:pointer;"><td>${client.id}</td><td class="morosidad-client-name">${client.name}</td><td>S/${formatNumber(client.monto||0)}</td><td>${client.term||0}</td><td>${client.frequency||'N/A'}</td><td style="color:var(--danger-color);">S/${formatNumber(client.mora||0)}</td><td style="color:var(--danger-color);font-weight:bold;">S/${formatNumber(client.totalAtraso||0)}</td><td style="color:var(--danger-color);">S/${formatNumber(totalDeuda)}</td><td style="text-align: center; vertical-align: middle;"><div style="display: inline-flex; justify-content: center; align-items: center; gap: 5px;">${client.phone?`<button class="btn-circle" onclick="event.stopPropagation();makeCall('${client.phone}');" title="Llamar">üìû</button><button class="btn-circle" onclick="event.stopPropagation();openWhatsApp('${client.phone}');" title="WhatsApp">üì±</button>`:'Sin tel√©fono'}</div></td></tr>`;});modalHTML+=`</tbody></table>`;document.getElementById('morosidadModalContent').innerHTML=modalHTML;showModal('morosidadModal');}
function deleteAllClients(){if(clients.length === 0){alert('No hay clientes para eliminar');return;} const clientCount = clients.length; const paymentCount = payments.length; if(!confirm(`‚ö†Ô∏è ADVERTENCIA: Esta acci√≥n eliminar√° ${clientCount} clientes.\n\nSe mantendr√°n ${paymentCount} pagos en el historial.\n\n¬øEst√°s seguro de continuar?`)){return;} clients = []; saveData(); updateDisplay(); alert(`‚úÖ Se eliminaron ${clientCount} clientes exitosamente.\n\nSe mantuvieron ${paymentCount} pagos en el historial.`);}
function installPWA(){if(deferredPrompt){deferredPrompt.prompt();deferredPrompt.userChoice.then((choiceResult)=>{if(choiceResult.outcome==='accepted'){console.log('PWA instalada');}deferredPrompt=null;document.getElementById('installBanner').classList.remove('show');});}}
if('serviceWorker' in navigator){
    window.addEventListener('load',function(){
        navigator.serviceWorker.register('service-worker.js')
            .then(function(registration){
                console.log('ServiceWorker registrado con √©xito:',registration.scope);
            },function(err){
                console.log('ServiceWorker fall√≥ al registrar:',err);
            });
    });
}
window.addEventListener('beforeinstallprompt',(e)=>{e.preventDefault();deferredPrompt=e;setTimeout(()=>{if(!localStorage.getItem('pwaInstallPromptShown')){document.getElementById('installBanner').classList.add('show');localStorage.setItem('pwaInstallPromptShown','true');}},2000);});
init();
// --- FIN DEL C√ìDIGO JAVASCRIPT ---
</script>
</body>
</html>





