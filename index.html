<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Control de Pagos Diarios</title>
    
    <!-- PWA Meta Tags -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#667eea">
    <meta name="application-name" content="Control Pagos">
    
    <!-- PWA Manifest y iconos -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <!-- Android specific optimizations -->
    <meta name="format-detection" content="telephone=no">
    <meta name="msapplication-tap-highlight" content="no">
    
    <!-- Service Worker para funcionar offline -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('service-worker.js');
            });
        }
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            min-height: 100vh;
            overflow-x: hidden;
            /* Android scroll optimization */
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.12);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 500;
            letter-spacing: 0.5px;
        }

        .container {
            padding: 16px;
            max-width: 600px;
            margin: 0 auto;
            padding-bottom: 80px; /* Extra space for Android navigation */
        }

        .stats-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            elevation: 2; /* Android elevation */
        }

        .payment-method {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 500;
            margin-left: 8px;
        }

        .method-efectivo {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .method-yape {
            background: #e3f2fd;
            color: #1565c0;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-top: 12px;
        }

        .stat-item {
            text-align: center;
            padding: 8px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 600;
            color: #667eea;
            line-height: 1.2;
        }

        .stat-label {
            font-size: 14px;
            color: #666;
            margin-top: 6px;
            font-weight: 400;
        }

        .section-title {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 16px;
            color: #333;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 16px 24px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 500;
            width: 100%;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 12px;
            box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
            /* Android Material Design ripple effect */
            position: relative;
            overflow: hidden;
            text-transform: none;
            letter-spacing: 0.5px;
        }

        .btn-primary:active {
            transform: scale(0.98);
            box-shadow: 0 1px 2px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #333;
            border: 1px solid #e0e0e0;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .btn-secondary:active {
            background: #eeeeee;
            transform: scale(0.98);
        }

        .client-list {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .client-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 12px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.2s ease;
            border-radius: 8px;
            margin-bottom: 2px;
        }

        .client-item:active {
            background: #f8f9fa;
        }

        .client-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .client-name {
            font-weight: 500;
            color: #333;
            font-size: 15px;
            line-height: 1.3;
        }

        .client-status {
            font-size: 12px;
            padding: 6px 10px;
            border-radius: 16px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-paid {
            background: #d4edda;
            color: #155724;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 24px;
            width: 92%;
            max-width: 500px;
            border-radius: 16px;
            animation: slideIn 0.3s ease;
            max-height: 85vh;
            overflow-y: auto;
        }

        @keyframes slideIn {
            from { transform: translateY(-30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid #f0f0f0;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 500;
            color: #333;
        }

        .close-btn {
            font-size: 28px;
            cursor: pointer;
            color: #999;
            background: none;
            border: none;
            padding: 4px;
            line-height: 1;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:active {
            background: #f0f0f0;
        }

        .form-group {
            margin-bottom: 20px;
            position: relative;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border 0.2s ease;
            background: #fafafa;
            font-family: inherit;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .payment-history {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .payments-container {
            max-height: 320px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .payment-item {
            padding: 14px 12px;
            border-bottom: 1px solid #f0f0f0;
            border-radius: 8px;
            margin-bottom: 2px;
        }

        .payment-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .payment-client {
            font-weight: 500;
            color: #333;
            font-size: 15px;
            line-height: 1.3;
        }

        .payment-details {
            display: flex;
            justify-content: space-between;
            margin-top: 6px;
            font-size: 14px;
            color: #666;
        }

        .payment-amount {
            color: #28a745;
            font-weight: 600;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
            font-style: italic;
        }

        .search-container {
            margin-bottom: 16px;
        }

        .search-input {
            margin-bottom: 0;
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
        }

        .search-input:focus {
            background: white;
            border-color: #667eea;
        }

        .client-item.hidden {
            display: none;
        }

        .client-dropdown {
            position: absolute;
            background: white;
            border: 1px solid #e0e0e0;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1001;
            width: 100%;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .dropdown-item {
            padding: 14px 16px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.2s ease;
        }

        .dropdown-item:active {
            background: #f8f9fa;
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item-name {
            font-weight: 500;
            color: #333;
            font-size: 15px;
        }

        .dropdown-item-phone {
            font-size: 13px;
            color: #666;
            margin-top: 3px;
        }

        .clients-container {
            max-height: 320px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .no-results {
            text-align: center;
            padding: 24px;
            color: #999;
            font-style: italic;
        }

        .date-filter {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding: 16px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            margin-left: 8px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .btn-danger:active {
            background: #c82333;
            transform: scale(0.95);
        }

        .frequency-badge {
            display: inline-block;
            padding: 3px 6px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .freq-diario {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .freq-semanal {
            background: #e3f2fd;
            color: #1565c0;
        }

        .freq-quincenal {
            background: #fce4ec;
            color: #c2185b;
        }

        .freq-mensual {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        /* Android specific optimizations */
        input[type="number"] {
            -moz-appearance: textfield;
        }

        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
            padding-right: 40px;
        }

        /* Smooth scrolling for Android */
        .payments-container,
        .clients-container {
            scrollbar-width: thin;
            scrollbar-color: #ccc transparent;
        }

        .payments-container::-webkit-scrollbar,
        .clients-container::-webkit-scrollbar {
            width: 4px;
        }

        .payments-container::-webkit-scrollbar-track,
        .clients-container::-webkit-scrollbar-track {
            background: transparent;
        }

        .payments-container::-webkit-scrollbar-thumb,
        .clients-container::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 2px;
        }

        /* Responsive design for smaller Android screens */
        @media (max-width: 360px) {
            .container {
                padding: 12px;
            }
            
            .modal-content {
                margin: 3% auto;
                width: 95%;
                padding: 20px;
            }
            
            .stats-grid {
                gap: 12px;
            }
            
            .stat-value {
                font-size: 24px;
            }
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            .btn-primary {
                box-shadow: 0 0 0 2px currentColor;
            }
            
            .client-item {
                border: 1px solid #ccc;
            }
        }

        /* Forzar modo claro siempre */
        body {
            background-color: #f5f5f5 !important;
            color: #333 !important;
        }
        
        .stats-card,
        .client-list,
        .payment-history,
        .date-filter,
        .modal-content {
            background: white !important;
            color: #333 !important;
        }
        
        .form-input {
            background: #fafafa !important;
            border-color: #e0e0e0 !important;
            color: #333 !important;
        }
        
        .form-input:focus {
            background: white !important;
            border-color: #667eea !important;
            color: #333 !important;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Control de Pagos</h1>
    </div>

    <div class="container">
        <!-- Filtro de fecha -->
        <div class="date-filter">
            <div>
                <label for="dateFilter" class="form-label">Fecha:</label>
                <input type="date" id="dateFilter" class="form-input" style="width: auto;">
            </div>
            <button class="btn-secondary" onclick="setToday()">Hoy</button>
        </div>

        <!-- Estadísticas del día -->
        <div class="stats-card">
            <h2 class="section-title">Resumen del Día</h2>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value" id="totalPaid">S/0</div>
                    <div class="stat-label">Total Recibido</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="clientsPaid">0</div>
                    <div class="stat-label">Clientes que Pagaron</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalCash">S/0</div>
                    <div class="stat-label">💵 Efectivo</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalYape">S/0</div>
                    <div class="stat-label">📱 Yape</div>
                </div>
            </div>
        </div>

        <!-- Botones principales -->
        <button class="btn-primary" onclick="showAddClientModal()">➕ Agregar Cliente</button>
        <button class="btn-primary" onclick="showAddPaymentModal()">💰 Registrar Pago</button>

        <!-- Lista de clientes -->
        <div class="client-list">
            <h2 class="section-title">Clientes del Día</h2>
            <div class="clients-container" id="clientsContainer">
                <div id="clientsList">
                    <div class="empty-state">No hay clientes registrados</div>
                </div>
            </div>
        </div>

        <!-- Historial de pagos -->
        <div class="payment-history">
            <h2 class="section-title">Pagos del Día</h2>
            <div class="payments-container" id="paymentsContainer">
                <div id="paymentsList">
                    <div class="empty-state">No hay pagos registrados</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Agregar Cliente -->
    <div id="addClientModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Agregar Cliente</h3>
                <button class="close-btn" onclick="closeModal('addClientModal')">&times;</button>
            </div>
            <form onsubmit="addClient(event)">
                <div class="form-group">
                    <label class="form-label">Nombre del Cliente</label>
                    <input type="text" class="form-input" id="clientName" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Teléfono (opcional)</label>
                    <input type="tel" class="form-input" id="clientPhone">
                </div>
                <div class="form-group">
                    <label class="form-label">Fecha de Desembolso</label>
                    <input type="date" class="form-input" id="clientDisbursementDate" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Frecuencia de Pago</label>
                    <select class="form-input" id="clientFrequency" required>
                        <option value="">Seleccionar frecuencia...</option>
                        <option value="DIARIO">Diario</option>
                        <option value="SEMANAL">Semanal</option>
                        <option value="QUINCENAL">Quincenal</option>
                        <option value="MENSUAL">Mensual</option>
                    </select>
                </div>
                <button type="submit" class="btn-primary">Agregar Cliente</button>
            </form>
        </div>
    </div>

    <!-- Modal Registrar Pago -->
    <div id="addPaymentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Registrar Pago</h3>
                <button class="close-btn" onclick="closeModal('addPaymentModal')">&times;</button>
            </div>
            <form onsubmit="addPayment(event)">
                <div class="form-group">
                    <label class="form-label">Cliente</label>
                    <input type="text" 
                           class="form-input" 
                           id="clientSearchModal" 
                           placeholder="🔍 Buscar y seleccionar cliente..."
                           autocomplete="off"
                           onkeyup="filterModalClients()"
                           onfocus="showClientDropdown()"
                           required>
                    <input type="hidden" id="selectedClientId" required>
                    <div id="clientDropdown" class="client-dropdown" style="display: none;">
                        <!-- Aquí se mostrarán los clientes filtrados -->
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Monto</label>
                    <input type="number" class="form-input" id="paymentAmount" step="0.01" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Método de Pago</label>
                    <select class="form-input" id="paymentMethod" required>
                        <option value="">Seleccionar método...</option>
                        <option value="efectivo">💵 Efectivo</option>
                        <option value="yape">📱 Yape</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Nota (opcional)</label>
                    <input type="text" class="form-input" id="paymentNote">
                </div>
                <button type="submit" class="btn-primary">Registrar Pago</button>
            </form>
        </div>
    </div>

    <script>
        // Estado de la aplicación
        let clients = [];
        let payments = [];

        // Clientes del Excel MENA
        const excelClients = [
            {
                "id": "25398",
                "name": "TUCTO ESPINOZA, CARMEN OLIVIA",
                "phone": "938752424",
                "disbursementDate": "2025-06-25",
                "frequency": "DIARIO"
            },
            {
                "id": "25303",
                "name": "CAMASCCA ALIAGA, ELENA",
                "phone": "900233985",
                "disbursementDate": "2025-06-20",
                "frequency": "DIARIO"
            },
            {
                "id": "25107",
                "name": "CAMPOS OLORTEGUI, JOSUE JOEL",
                "phone": "930582986",
                "disbursementDate": "2025-06-18",
                "frequency": "SEMANAL"
            },
            {
                "id": "25058",
                "name": "CHAVEZ BALDOCEDA, EMILIA RUFINA",
                "phone": "993530298",
                "disbursementDate": "2025-07-01",
                "frequency": "SEMANAL"
            },
            {
                "id": "25035",
                "name": "VASQUEZ FLORES DE ALVARADO, LUCIOLA",
                "phone": "937451188",
                "disbursementDate": "2025-06-30",
                "frequency": "SEMANAL"
            },
            {
                "id": "25029",
                "name": "JUSTINIANO ACASIO, CELIA JUDITH",
                "phone": "974418205",
                "disbursementDate": "2025-06-26",
                "frequency": "SEMANAL"
            },
            {
                "id": "25026",
                "name": "TAFUR ROBLES, MARITZA MARTHA",
                "phone": "931079187",
                "disbursementDate": "2025-06-11",
                "frequency": "MENSUAL"
            },
            {
                "id": "24761",
                "name": "CHOCSE ROBLES, EMPERATRIZ ISABEL",
                "phone": "964584852",
                "disbursementDate": "2025-06-12",
                "frequency": "SEMANAL"
            },
            {
                "id": "24736",
                "name": "BAUTISTA CARDOZA, ELMER",
                "phone": "967113190",
                "disbursementDate": "2025-06-30",
                "frequency": "DIARIO"
            },
            {
                "id": "24717",
                "name": "ESPINOZA RODRIGUEZ, RONALD JAIRO",
                "phone": "918942359",
                "disbursementDate": "2025-06-12",
                "frequency": "DIARIO"
            },
            {
                "id": "24682",
                "name": "LESCANO EGUSQUIZA, FERNANDO SEGUNDO",
                "phone": "962996866",
                "disbursementDate": "2025-06-30",
                "frequency": "SEMANAL"
            },
            {
                "id": "24273",
                "name": "MEJIA DELGADILLO, MOISES CHRISTIAM",
                "phone": "952934566",
                "disbursementDate": "2025-05-30",
                "frequency": "SEMANAL"
            },
            {
                "id": "24241",
                "name": "CORPORACION TABERNA E.I.R.L.",
                "phone": "944240156",
                "disbursementDate": "2025-06-19",
                "frequency": "SEMANAL"
            },
            {
                "id": "23988",
                "name": "OYOLA RIVERA, CESAR AUGUSTO",
                "phone": "997917602",
                "disbursementDate": "2025-06-30",
                "frequency": "DIARIO"
            },
            {
                "id": "23202",
                "name": "ATACHAGUA FRETEL, ANNY DALIS",
                "phone": "940772732",
                "disbursementDate": "2025-06-30",
                "frequency": "SEMANAL"
            },
            {
                "id": "22295",
                "name": "LIVIAPOMA COLLACHAGUA, JACQUELINE JESSICA",
                "phone": "989200585",
                "disbursementDate": "2025-06-19",
                "frequency": "SEMANAL"
            },
            {
                "id": "20633",
                "name": "GARCIA TOSCANO, NORMA",
                "phone": "929023145",
                "disbursementDate": "2025-06-23",
                "frequency": "SEMANAL"
            },
            {
                "id": "19899",
                "name": "ILLATOPA GALLARDO, MARIA",
                "phone": "907226424",
                "disbursementDate": "2024-10-31",
                "frequency": "MENSUAL"
            },
            {
                "id": "18861",
                "name": "ORIZANO SIMON, MARIA ELENA",
                "phone": "966200489",
                "disbursementDate": "2025-06-17",
                "frequency": "DIARIO"
            },
            {
                "id": "15570",
                "name": "COPYMAX PLUS E.I.R.L",
                "phone": "952847664",
                "disbursementDate": "2025-05-21",
                "frequency": "DIARIO"
            },
            {
                "id": "15570b",
                "name": "COPYMAX PLUS E.I.R.L",
                "phone": "952847664",
                "disbursementDate": "2025-06-13",
                "frequency": "DIARIO"
            },
            {
                "id": "15027",
                "name": "PONCE AYRA, DINA",
                "phone": "925460243",
                "disbursementDate": "2024-11-29",
                "frequency": "MENSUAL"
            },
            {
                "id": "8582",
                "name": "ILLATOPA REYES, CINTHIA KARINA",
                "phone": "918266071",
                "disbursementDate": "2025-06-27",
                "frequency": "DIARIO"
            },
            {
                "id": "8235",
                "name": "SERVICIOS GENERALES MOTOKAR Y BAJAJ E.I.R.L",
                "phone": "976193292",
                "disbursementDate": "2025-06-30",
                "frequency": "DIARIO"
            },
            {
                "id": "8166",
                "name": "DAVILA DAVIRAN, YOSBET",
                "phone": "929024811",
                "disbursementDate": "2025-06-27",
                "frequency": "DIARIO"
            },
            {
                "id": "7350",
                "name": "QUESHYAC TAMARA, FABIAN ALFONSIN",
                "phone": "983360447",
                "disbursementDate": "2025-06-30",
                "frequency": "DIARIO"
            },
            {
                "id": "3599",
                "name": "RUIZ RODRIGUEZ, OLGA",
                "phone": "954981005",
                "disbursementDate": "2025-06-12",
                "frequency": "SEMANAL"
            }
        ];

        // Inicializar la app
        function init() {
            loadData();
            importExcelClients();
            setToday();
            updateDisplay();
            
            // Agregar evento para cerrar dropdown al hacer clic fuera
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.form-group')) {
                    hideClientDropdown();
                }
            });

            // Android optimizations
            document.addEventListener('touchstart', function() {}, {passive: true});
            document.addEventListener('touchmove', function() {}, {passive: true});
        }

        // Importar clientes del Excel si no existen
        function importExcelClients() {
            const savedImport = localStorage.getItem('excelClientsImported_MENA');
            
            if (!savedImport) {
                excelClients.forEach(excelClient => {
                    // Verificar si el cliente ya existe
                    if (!clients.find(c => c.id === excelClient.id)) {
                        clients.push({
                            id: excelClient.id,
                            name: excelClient.name,
                            phone: excelClient.phone,
                            disbursementDate: excelClient.disbursementDate,
                            frequency: excelClient.frequency,
                            createdAt: new Date().toISOString()
                        });
                    }
                });
                
                localStorage.setItem('excelClientsImported_MENA', 'true');
                saveData();
            }
        }

        // Verificar si un cliente debe pagar en una fecha específica
        function shouldPayOnDate(client, checkDate) {
            if (!client.disbursementDate) {
                return false;
            }
            
            const disbursementDate = new Date(client.disbursementDate + 'T00:00:00');
            const targetDate = new Date(checkDate + 'T00:00:00');
            
            // Si la fecha de verificación es anterior al desembolso, no debe pagar
            if (targetDate < disbursementDate) {
                return false;
            }
            
            const daysDiff = Math.floor((targetDate - disbursementDate) / (1000 * 60 * 60 * 24));
            const dayOfWeek = targetDate.getDay(); // 0 = Domingo, 6 = Sábado
            
            switch(client.frequency) {
                case 'DIARIO':
                    // Solo de lunes a viernes
                    return dayOfWeek >= 1 && dayOfWeek <= 5;
                    
                case 'SEMANAL':
                    // Cada 7 días desde el desembolso
                    return daysDiff % 7 === 0;
                    
                case 'QUINCENAL':
                    // Cada 15 días desde el desembolso
                    return daysDiff % 15 === 0;
                    
                case 'MENSUAL':
                    // El mismo día de cada mes
                    const disbursementDay = disbursementDate.getDate();
                    const targetDay = targetDate.getDate();
                    
                    // Si el día del mes coincide
                    if (disbursementDay === targetDay) {
                        return true;
                    }
                    
                    // Si es fin de mes y el día de desembolso es mayor que los días del mes actual
                    const lastDayOfMonth = new Date(targetDate.getFullYear(), targetDate.getMonth() + 1, 0).getDate();
                    if (targetDay === lastDayOfMonth && disbursementDay > lastDayOfMonth) {
                        return true;
                    }
                    
                    return false;
                    
                default:
                    return false;
            }
        }

        // Cargar datos del localStorage
        function loadData() {
            const savedClients = localStorage.getItem('clients_MENA');
            const savedPayments = localStorage.getItem('payments_MENA');
            
            if (savedClients) clients = JSON.parse(savedClients);
            if (savedPayments) payments = JSON.parse(savedPayments);
        }

        // Guardar datos en localStorage
        function saveData() {
            localStorage.setItem('clients_MENA', JSON.stringify(clients));
            localStorage.setItem('payments_MENA', JSON.stringify(payments));
        }

        // Establecer fecha de hoy (hora de Perú)
        function setToday() {
            // Obtener la fecha actual en zona horaria de Perú
            const peruDate = new Date().toLocaleDateString('en-CA', {timeZone: 'America/Lima'});
            document.getElementById('dateFilter').value = peruDate;
            updateDisplay();
        }

        // Actualizar la visualización
        function updateDisplay() {
            const selectedDate = document.getElementById('dateFilter').value;
            updateStats(selectedDate);
            updateClientsList(selectedDate);
            updatePaymentsList(selectedDate);
        }

        // Actualizar estadísticas
        function updateStats(date) {
            const dayPayments = payments.filter(p => p.date === date);
            const total = dayPayments.reduce((sum, p) => sum + p.amount, 0);
            const uniqueClients = new Set(dayPayments.map(p => p.clientId)).size;
            
            // Calcular totales por método de pago
            const cashTotal = dayPayments
                .filter(p => p.method === 'efectivo')
                .reduce((sum, p) => sum + p.amount, 0);
            
            const yapeTotal = dayPayments
                .filter(p => p.method === 'yape')
                .reduce((sum, p) => sum + p.amount, 0);

            document.getElementById('totalPaid').textContent = `S/${total.toFixed(2)}`;
            document.getElementById('clientsPaid').textContent = uniqueClients;
            document.getElementById('totalCash').textContent = `S/${cashTotal.toFixed(2)}`;
            document.getElementById('totalYape').textContent = `S/${yapeTotal.toFixed(2)}`;
        }

        // Actualizar lista de clientes
        function updateClientsList(date) {
            const clientsList = document.getElementById('clientsList');
            const dayPayments = payments.filter(p => p.date === date);
            
            // Filtrar clientes que deben pagar en la fecha seleccionada
            const clientsToPayToday = clients.filter(client => shouldPayOnDate(client, date));
            
            if (clientsToPayToday.length === 0) {
                clientsList.innerHTML = '<div class="empty-state">No hay clientes que deban pagar hoy</div>';
                return;
            }

            clientsList.innerHTML = clientsToPayToday.map(client => {
                const clientPayments = dayPayments.filter(p => p.clientId === client.id);
                const hasPaid = clientPayments.length > 0;
                const totalPaid = clientPayments.reduce((sum, p) => sum + p.amount, 0);

                const freqClass = {
                    'DIARIO': 'freq-diario',
                    'SEMANAL': 'freq-semanal',
                    'QUINCENAL': 'freq-quincenal',
                    'MENSUAL': 'freq-mensual'
                }[client.frequency];

                return `
                    <div class="client-item" onclick="showClientDetails('${client.id}')">
                        <div>
                            <div class="client-name">
                                ${client.name}
                                <span class="frequency-badge ${freqClass}">${client.frequency}</span>
                            </div>
                            ${hasPaid ? `<small>Pagó: S/${totalPaid.toFixed(2)}</small>` : ''}
                        </div>
                        <div>
                            <span class="client-status ${hasPaid ? 'status-paid' : 'status-pending'}">
                                ${hasPaid ? 'Pagó' : 'Pendiente'}
                            </span>
                            <button class="btn-danger" onclick="deleteClient('${client.id}', event)">×</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Actualizar lista de pagos
        function updatePaymentsList(date) {
            const paymentsList = document.getElementById('paymentsList');
            const dayPayments = payments.filter(p => p.date === date);
            
            if (dayPayments.length === 0) {
                paymentsList.innerHTML = '<div class="empty-state">No hay pagos registrados</div>';
                return;
            }

            paymentsList.innerHTML = dayPayments
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                .map(payment => {
                    const client = clients.find(c => c.id === payment.clientId);
                    const methodIcon = payment.method === 'yape' ? '📱' : '💵';
                    const methodClass = payment.method === 'yape' ? 'method-yape' : 'method-efectivo';
                    const methodText = payment.method === 'yape' ? 'Yape' : 'Efectivo';
                    
                    return `
                        <div class="payment-item">
                            <div class="payment-client">
                                ${client ? client.name : 'Cliente eliminado'}
                                <span class="payment-method ${methodClass}">${methodIcon} ${methodText}</span>
                            </div>
                            <div class="payment-details">
                                <span>${payment.note || 'Sin nota'}</span>
                                <span class="payment-amount">S/${payment.amount.toFixed(2)}</span>
                            </div>
                            <div class="payment-details">
                                <span>${new Date(payment.timestamp).toLocaleTimeString('es-PE', {timeZone: 'America/Lima'})}</span>
                                <button class="btn-danger" onclick="deletePayment('${payment.id}')">Eliminar</button>
                            </div>
                        </div>
                    `;
                }).join('');
        }

        // Mostrar dropdown de clientes
        function showClientDropdown() {
            const dropdown = document.getElementById('clientDropdown');
            dropdown.style.display = 'block';
            filterModalClients();
        }

        // Ocultar dropdown de clientes
        function hideClientDropdown() {
            const dropdown = document.getElementById('clientDropdown');
            dropdown.style.display = 'none';
        }

        // Filtrar clientes en el modal
        function filterModalClients() {
            const searchTerm = document.getElementById('clientSearchModal').value.toLowerCase();
            const dropdown = document.getElementById('clientDropdown');
            
            const filteredClients = clients.filter(client => 
                client.name.toLowerCase().includes(searchTerm) ||
                (client.phone && client.phone.includes(searchTerm))
            );

            if (filteredClients.length === 0) {
                dropdown.innerHTML = '<div class="no-results">No se encontraron clientes</div>';
            } else {
                dropdown.innerHTML = filteredClients.map(client => `
                    <div class="dropdown-item" onclick="selectClient('${client.id}', '${client.name}')">
                        <div class="dropdown-item-name">${client.name}</div>
                        ${client.phone ? `<div class="dropdown-item-phone">${client.phone}</div>` : ''}
                    </div>
                `).join('');
            }
        }

        // Seleccionar cliente del dropdown
        function selectClient(clientId, clientName) {
            document.getElementById('selectedClientId').value = clientId;
            document.getElementById('clientSearchModal').value = clientName;
            hideClientDropdown();
        }

        // Mostrar modal
        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
            // Prevent body scroll on Android
            document.body.style.overflow = 'hidden';
        }

        // Cerrar modal
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            document.body.style.overflow = '';
            // Limpiar campos del modal de pago
            if (modalId === 'addPaymentModal') {
                document.getElementById('clientSearchModal').value = '';
                document.getElementById('selectedClientId').value = '';
                hideClientDropdown();
            }
        }

        // Mostrar modal de agregar cliente
        function showAddClientModal() {
            document.getElementById('clientName').value = '';
            document.getElementById('clientPhone').value = '';
            document.getElementById('clientDisbursementDate').value = '';
            document.getElementById('clientFrequency').value = '';
            showModal('addClientModal');
        }

        // Mostrar modal de agregar pago
        function showAddPaymentModal() {
            if (clients.length === 0) {
                alert('Primero debes agregar al menos un cliente');
                return;
            }
            document.getElementById('clientSearchModal').value = '';
            document.getElementById('selectedClientId').value = '';
            document.getElementById('paymentAmount').value = '';
            document.getElementById('paymentMethod').value = '';
            document.getElementById('paymentNote').value = '';
            showModal('addPaymentModal');
        }

        // Agregar cliente
        function addClient(event) {
            event.preventDefault();
            
            const name = document.getElementById('clientName').value.trim();
            const phone = document.getElementById('clientPhone').value.trim();
            const disbursementDate = document.getElementById('clientDisbursementDate').value;
            const frequency = document.getElementById('clientFrequency').value;
            
            const newClient = {
                id: Date.now().toString(),
                name: name,
                phone: phone,
                disbursementDate: disbursementDate,
                frequency: frequency,
                createdAt: new Date().toISOString()
            };
            
            clients.push(newClient);
            saveData();
            updateDisplay();
            closeModal('addClientModal');
        }

        // Agregar pago
        function addPayment(event) {
            event.preventDefault();
            
            const clientId = document.getElementById('selectedClientId').value;
            const amount = parseFloat(document.getElementById('paymentAmount').value);
            const method = document.getElementById('paymentMethod').value;
            const note = document.getElementById('paymentNote').value.trim();
            const date = document.getElementById('dateFilter').value;
            
            if (!clientId) {
                alert('Por favor selecciona un cliente de la lista');
                return;
            }
            
            const newPayment = {
                id: Date.now().toString(),
                clientId: clientId,
                amount: amount,
                method: method,
                note: note,
                date: date,
                timestamp: new Date().toISOString()
            };
            
            payments.push(newPayment);
            saveData();
            updateDisplay();
            closeModal('addPaymentModal');
        }

        // Eliminar cliente
        function deleteClient(clientId, event) {
            event.stopPropagation();
            if (confirm('¿Estás seguro de eliminar este cliente? Se mantendrán los pagos históricos.')) {
                clients = clients.filter(c => c.id !== clientId);
                saveData();
                updateDisplay();
            }
        }

        // Eliminar pago
        function deletePayment(paymentId) {
            if (confirm('¿Estás seguro de eliminar este pago?')) {
                payments = payments.filter(p => p.id !== paymentId);
                saveData();
                updateDisplay();
            }
        }

        // Mostrar detalles del cliente
        function showClientDetails(clientId) {
            const client = clients.find(c => c.id === clientId);
            const clientPayments = payments.filter(p => p.clientId === clientId);
            const totalPaid = clientPayments.reduce((sum, p) => sum + p.amount, 0);
            
            let nextPaymentDate = 'N/A';
            if (client.disbursementDate) {
                const today = new Date();
                const tomorrow = new Date(today);
                tomorrow.setDate(tomorrow.getDate() + 1);
                
                // Buscar la próxima fecha de pago
                for (let i = 0; i < 60; i++) { // Buscar en los próximos 60 días
                    const checkDate = new Date(tomorrow);
                    checkDate.setDate(checkDate.getDate() + i);
                    
                    if (shouldPayOnDate(client, checkDate.toISOString().split('T')[0])) {
                        nextPaymentDate = checkDate.toLocaleDateString('es-PE');
                        break;
                    }
                }
            }
            
            alert(`Cliente: ${client.name}\nID: ${client.id}\nTeléfono: ${client.phone || 'No registrado'}\nFecha de desembolso: ${client.disbursementDate ? new Date(client.disbursementDate).toLocaleDateString('es-PE') : 'N/A'}\nFrecuencia: ${client.frequency || 'N/A'}\nPróximo pago: ${nextPaymentDate}\n\nTotal pagado (histórico): S/${totalPaid.toFixed(2)}\nNúmero de pagos: ${clientPayments.length}`);
        }

        // Event listener para cambio de fecha
        document.getElementById('dateFilter').addEventListener('change', updateDisplay);

        // Cerrar modales al hacer clic fuera
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                closeModal(event.target.id);
            }
        }

        // Android specific optimizations
        let resizeTimer;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(function() {
                // Adjust layout for virtual keyboard
                const vh = window.innerHeight * 0.01;
                document.documentElement.style.setProperty('--vh', `${vh}px`);
            }, 250);
        });

        // Inicializar la aplicación
        init();
    </script>
</body>
</html>
