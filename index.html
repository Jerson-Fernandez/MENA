<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Control de Pagos Diarios</title>
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#667eea">
<meta name="application-name" content="Control Pagos">
<meta name="format-detection" content="telephone=no">
<meta name="msapplication-tap-highlight" content="no">
<link rel="manifest" href="/manifest.json">
<link rel="apple-touch-icon" href="/icon-192.png">
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:'Roboto',-apple-system,BlinkMacSystemFont,'Segoe UI',Arial,sans-serif;background-color:#f5f5f5;color:#333;min-height:100vh;overflow-x:hidden;-webkit-overflow-scrolling:touch;overscroll-behavior:contain}
.header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:20px;text-align:center;box-shadow:0 4px 8px rgba(0,0,0,0.12);position:sticky;top:0;z-index:100}
.header h1{font-size:24px;font-weight:500;letter-spacing:0.5px}
.container{padding:16px;max-width:600px;margin:0 auto;padding-bottom:80px}
.stats-card{background:white;border-radius:12px;padding:20px;margin-bottom:16px;box-shadow:0 2px 8px rgba(0,0,0,0.08);elevation:2}
.payment-method{display:inline-block;padding:4px 8px;border-radius:8px;font-size:12px;font-weight:500;margin-left:8px}
.method-efectivo{background:#e8f5e9;color:#2e7d32}
.method-yape{background:#e3f2fd;color:#1565c0}
.method-mixto{background:#fff3cd;color:#856404}
.stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:12px}
.stat-item{text-align:center;padding:8px}
.stat-value{font-size:28px;font-weight:600;color:#667eea;line-height:1.2}
.stat-label{font-size:14px;color:#666;margin-top:6px;font-weight:400}
.section-title{font-size:18px;font-weight:500;margin-bottom:16px;color:#333}
.btn-primary{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;border:none;padding:16px 24px;border-radius:12px;font-size:16px;font-weight:500;width:100%;cursor:pointer;transition:all 0.2s ease;margin-bottom:12px;box-shadow:0 2px 4px rgba(102,126,234,0.3);position:relative;overflow:hidden;text-transform:none;letter-spacing:0.5px}
.btn-primary:active{transform:scale(0.98);box-shadow:0 1px 2px rgba(102,126,234,0.4)}
.btn-secondary{background:#f5f5f5;color:#333;border:1px solid #e0e0e0;padding:12px 20px;border-radius:8px;font-size:14px;cursor:pointer;transition:all 0.2s ease;font-weight:500}
.btn-secondary:active{background:#eeeeee;transform:scale(0.98)}
.client-list{background:white;border-radius:12px;padding:20px;margin-bottom:16px;box-shadow:0 2px 8px rgba(0,0,0,0.08);overflow:hidden}
.client-item{display:flex;justify-content:space-between;align-items:center;padding:16px 12px;border-bottom:1px solid #f0f0f0;cursor:pointer;transition:background 0.2s ease;border-radius:8px;margin-bottom:2px}
.client-item:active{background:#f8f9fa}
.client-item:last-child{border-bottom:none;margin-bottom:0}
.client-item.in-debt{background:#fff5f5;border-left:4px solid #dc3545}
.client-name{font-weight:500;color:#333;font-size:15px;line-height:1.3}
.client-status{font-size:12px;padding:6px 10px;border-radius:16px;font-weight:500;text-transform:uppercase;letter-spacing:0.5px}
.status-paid{background:#d4edda;color:#155724}
.status-pending{background:#fff3cd;color:#856404}
.status-overdue{background:#f8d7da;color:#721c24}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:1000;animation:fadeIn 0.3s ease}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.modal-content{background:white;padding:24px;width:92%;max-width:500px;border-radius:16px;max-height:85vh;overflow-y:auto;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);animation:slideIn 0.3s ease}
@keyframes slideIn{from{transform:translate(-50%,-50%) translateY(-30px);opacity:0}to{transform:translate(-50%,-50%) translateY(0);opacity:1}}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;padding-bottom:16px;border-bottom:1px solid #f0f0f0}
.modal-title{font-size:20px;font-weight:500;color:#333}
.close-btn{font-size:28px;cursor:pointer;color:#999;background:none;border:none;padding:4px;line-height:1;border-radius:50%;width:32px;height:32px;display:flex;align-items:center;justify-content:center}
.close-btn:active{background:#f0f0f0}
.form-group{margin-bottom:20px;position:relative}
.form-label{display:block;margin-bottom:8px;font-weight:500;color:#333;font-size:14px}
.form-input{width:100%;padding:14px 16px;border:2px solid #e0e0e0;border-radius:8px;font-size:16px;transition:border 0.2s ease;background:#fafafa;font-family:inherit}
.form-input:focus{outline:none;border-color:#667eea;background:white;box-shadow:0 0 0 3px rgba(102,126,234,0.1)}
.payment-history{background:white;border-radius:12px;padding:20px;margin-bottom:16px;box-shadow:0 2px 8px rgba(0,0,0,0.08)}
.payments-container{max-height:320px;overflow-y:auto;-webkit-overflow-scrolling:touch}
.payment-item{padding:14px 12px;border-bottom:1px solid #f0f0f0;border-radius:8px;margin-bottom:2px}
.payment-item:last-child{border-bottom:none;margin-bottom:0}
.payment-client{font-weight:500;color:#333;font-size:15px;line-height:1.3}
.payment-details{display:flex;justify-content:space-between;margin-top:6px;font-size:14px;color:#666}
.payment-amount{color:#28a745;font-weight:600}
.empty-state{text-align:center;padding:40px 20px;color:#999;font-style:italic}
.search-container{margin-bottom:16px}
.search-input{margin-bottom:0;background:#f8f9fa;border:1px solid #e0e0e0}
.search-input:focus{background:white;border-color:#667eea}
.client-dropdown{position:absolute;background:white;border:1px solid #e0e0e0;border-top:none;border-radius:0 0 8px 8px;max-height:200px;overflow-y:auto;z-index:1001;width:100%;box-shadow:0 4px 12px rgba(0,0,0,0.15)}
.dropdown-item{padding:14px 16px;cursor:pointer;border-bottom:1px solid #f0f0f0;transition:background 0.2s ease}
.dropdown-item:active{background:#f8f9fa}
.dropdown-item:last-child{border-bottom:none}
.dropdown-item-name{font-weight:500;color:#333;font-size:15px}
.dropdown-item-phone{font-size:13px;color:#666;margin-top:3px}
.clients-container{max-height:480px;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch}
.no-results{text-align:center;padding:24px;color:#999;font-style:italic}
.date-filter{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding:16px;background:white;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.08)}
.btn-danger{background:#dc3545;color:white;border:none;padding:8px 12px;border-radius:6px;font-size:12px;cursor:pointer;margin-left:8px;font-weight:500;transition:all 0.2s ease}
.btn-danger:active{background:#c82333;transform:scale(0.95)}
.frequency-badge{display:inline-block;padding:3px 6px;border-radius:6px;font-size:10px;font-weight:600;margin-left:6px;text-transform:uppercase;letter-spacing:0.5px}
.freq-diario{background:#e8f5e9;color:#2e7d32}
.freq-semanal{background:#e3f2fd;color:#1565c0}
.freq-quincenal{background:#fce4ec;color:#c2185b}
.freq-mensual{background:#f3e5f5;color:#7b1fa2}
.client-quota{background:#f0f4ff;color:#1a5490;padding:2px 8px;border-radius:6px;font-size:13px;font-weight:600;margin-left:8px}
.payment-id{font-size:14px;color:#666;margin-bottom:3px;font-weight:600}
.general-search-container{background:white;border-radius:12px;padding:20px;margin-bottom:16px;box-shadow:0 2px 8px rgba(0,0,0,0.08)}
.search-results{margin-top:15px;max-height:300px;overflow-y:auto;-webkit-overflow-scrolling:touch}
.search-result-item{padding:15px;border-bottom:1px solid #f0f0f0;cursor:pointer;transition:background 0.2s}
.search-result-item:active{background:#f9f9f9}
.search-result-item:last-child{border-bottom:none}
.client-detail-info{margin-top:15px;padding:15px;background:#f9f9f9;border-radius:8px}
.detail-row{display:flex;justify-content:space-between;margin-bottom:10px;font-size:14px}
.detail-label{font-weight:500;color:#666}
.detail-value{color:#333;font-weight:600}
.action-buttons{display:flex;gap:10px;margin-top:15px;flex-wrap:wrap}
.btn-action{flex:1;padding:10px;border:none;border-radius:8px;font-size:14px;font-weight:500;cursor:pointer;transition:all 0.2s;min-width:80px}
.btn-call{background:#007AFF;color:white}
.btn-whatsapp{background:#25D366;color:white}
.btn-close-detail{background:#f0f0f0;color:#333}
.btn-schedule{background:#6c757d;color:white}
.btn-edit-client{background:#FFA500;color:white}
.btn-delete-client{background:#FF3B30;color:white}
.btn-movements{background:#9b59b6;color:white}
.schedule-table{margin-top:20px;width:100%;border-collapse:collapse}
.schedule-table th,.schedule-table td{padding:10px;border:1px solid #e0e0e0;text-align:left}
.schedule-table th{background:#f8f9fa;font-weight:600;color:#333}
.schedule-table tr:nth-child(even){background:#f8f9fa}
.schedule-table .paid{background:#d4edda}
.schedule-table .pending{background:#fff3cd}
.schedule-table .future{background:white}
.schedule-table .partial{background:#ffeaa7}
#scheduleModal .modal-content{max-width:800px}
.movements-list{margin-top:15px;max-height:400px;overflow-y:auto;-webkit-overflow-scrolling:touch}
.movement-item{padding:15px;border-bottom:1px solid #f0f0f0;background:white;border-radius:8px;margin-bottom:10px}
.movement-item:last-child{border-bottom:none;margin-bottom:0}
.movement-date{font-weight:600;color:#333;font-size:16px;margin-bottom:5px}
.movement-details{display:flex;justify-content:space-between;align-items:center;margin-top:8px}
.movement-method{font-size:14px;color:#666}
.movement-amount{font-size:18px;font-weight:bold;color:#28a745}
.check-icon{color:#28a745;font-size:20px}
.partial-icon{color:#f39c12;font-size:16px}
.btn-circle{width:40px;height:40px;border-radius:50%;border:none;display:flex;align-items:center;justify-content:center;font-size:18px;cursor:pointer;transition:all 0.2s;flex-shrink:0}
.btn-circle:active{transform:scale(0.95)}
.btn-pay{background:#34C759;color:white}
.payment-type-selector{display:flex;gap:10px;margin-bottom:20px}
.payment-type-btn{flex:1;padding:15px;border:2px solid #e0e0e0;background:#f8f9fa;border-radius:10px;cursor:pointer;text-align:center;transition:all 0.2s;-webkit-appearance:none;appearance:none}
.payment-type-btn:hover{background:#f0f0f0}
.payment-type-btn.active{background:#667eea;color:white;border-color:#667eea}
.payment-type-btn .icon{font-size:24px;margin-bottom:5px}
.payment-type-btn .label{font-size:14px;font-weight:500}
.payment-inputs{transition:all 0.3s ease}
.debt-badge{background:#dc3545;color:white;padding:2px 8px;border-radius:6px;font-size:11px;font-weight:600;margin-left:8px}
.btn-morosidad{background:#dc3545;color:white;border:none;padding:15px 30px;border-radius:10px;font-size:16px;font-weight:600;width:100%;cursor:pointer;transition:transform 0.2s;margin-bottom:15px;-webkit-appearance:none;appearance:none}
.btn-morosidad:active{transform:scale(0.98);opacity:0.9}
.debt-clients-container{background:#fff5f5;border-radius:15px;padding:20px;margin-bottom:20px;box-shadow:0 2px 10px rgba(220,53,69,0.1);border:1px solid #f8d7da}
.debt-clients-container .client-item{margin-bottom:10px;}
.debt-indicator{display:inline-block;width:8px;height:8px;background:#dc3545;border-radius:50%;margin-right:5px;animation:pulse 2s infinite}
@keyframes pulse{0%{box-shadow:0 0 0 0 rgba(220,53,69,0.7)}70%{box-shadow:0 0 0 20px rgba(220,53,69,0)}100%{box-shadow:0 0 0 0 rgba(220,53,69,0)}}
#morosidadModal .modal-content{max-width:1000px;}
.morosidad-table{width:100%;border-collapse:collapse;margin-top:20px}
.morosidad-table th,.morosidad-table td{padding:12px;border:1px solid #e0e0e0;text-align:left}
.morosidad-table th{background:#dc3545;color:white;font-weight:600}
.morosidad-table tr:nth-child(even){background:#f8f9fa}
.morosidad-table tr:hover{background:#fff5f5}
.morosidad-stats{display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:20px}
.morosidad-stat{background:#f8f9fa;padding:15px;border-radius:8px;text-align:center}
.morosidad-stat-value{font-size:24px;font-weight:bold;color:#dc3545}
.morosidad-stat-label{font-size:14px;color:#666;margin-top:5px}
.morosidad-table .btn-circle{width:36px;height:36px;padding:0;margin:0 2px;}
.button-row{display:flex;gap:10px;margin-bottom:15px}
.button-row .btn-primary{flex:1;margin-bottom:0}
input[type="number"]{-moz-appearance:textfield}
input[type="number"]::-webkit-outer-spin-button,input[type="number"]::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}
select{-webkit-appearance:none;-moz-appearance:none;appearance:none;background-image:url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");background-repeat:no-repeat;background-position:right 12px center;background-size:16px;padding-right:40px}
.payments-container,.clients-container{scrollbar-width:thin;scrollbar-color:#ccc transparent}
.payments-container::-webkit-scrollbar,.clients-container::-webkit-scrollbar{width:4px}
.payments-container::-webkit-scrollbar-track,.clients-container::-webkit-scrollbar-track{background:transparent}
.payments-container::-webkit-scrollbar-thumb,.clients-container::-webkit-scrollbar-thumb{background:#ccc;border-radius:2px}
@media (max-width:360px){.container{padding:12px}.modal-content{margin:3% auto;width:95%;padding:20px}.stats-grid{gap:12px}.stat-value{font-size:24px}}
@media (prefers-contrast:high){.btn-primary{box-shadow:0 0 0 2px currentColor}.client-item{border:1px solid #ccc}}
body{background-color:#f5f5f5!important;color:#333!important}
.stats-card,.client-list,.payment-history,.date-filter,.modal-content,.general-search-container{background:white!important;color:#333!important}
.form-input{background:#fafafa!important;border-color:#e0e0e0!important;color:#333!important}
.form-input:focus{background:white!important;border-color:#667eea!important;color:#333!important}
.install-banner{display:none;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:16px;margin:16px;border-radius:12px;box-shadow:0 4px 12px rgba(102,126,234,0.3);align-items:center;gap:12px}
.install-banner.show{display:flex}
.install-banner-text{flex:1}
.install-banner-text h3{font-size:16px;margin-bottom:4px}
.install-banner-text p{font-size:14px;opacity:0.9}
.btn-install{background:white;color:#667eea;padding:10px 20px;border:none;border-radius:8px;font-weight:600;cursor:pointer;white-space:nowrap}
.btn-install:active{transform:scale(0.95)}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
<div class="header"><h1>Control de Pagos</h1></div>
<div class="container">
<div id="installBanner" class="install-banner">
<div class="install-banner-text">
<h3>Instalar Control de Pagos</h3>
<p>Accede r√°pido desde tu pantalla de inicio</p>
</div>
<button class="btn-install" onclick="installPWA()">Instalar</button>
</div>
<div class="date-filter">
<div><label for="dateFilter" class="form-label">Fecha:</label><input type="date" id="dateFilter" class="form-input" style="width:auto;"></div>
<div style="display:flex;gap:10px;">
<button class="btn-secondary" onclick="setToday()">Hoy</button>
<button class="btn-secondary" onclick="document.getElementById('excelUpload').click()">üìä Excel</button>
<input type="file" id="excelUpload" accept=".xlsx,.xls" style="display:none;" onchange="handleExcelUpload(event)">
</div>
</div>
<div class="stats-card">
<h2 class="section-title">Resumen del D√≠a</h2>
<div class="stats-grid">
<div class="stat-item"><div class="stat-value" id="totalPaid">S/0.00</div><div class="stat-label">Total Recibido</div></div>
<div class="stat-item"><div class="stat-value" id="clientsPaid">0</div><div class="stat-label">Clientes que Pagaron</div></div>
<div class="stat-item"><div class="stat-value" id="totalCash">S/0.00</div><div class="stat-label">üíµ Efectivo</div></div>
<div class="stat-item"><div class="stat-value" id="totalYape">S/0.00</div><div class="stat-label">üì± Yape</div></div>
</div>
</div>
<div class="general-search-container">
<h2 class="section-title">Buscar Cliente</h2>
<div class="search-container"><input type="text" class="form-input search-input" id="generalClientSearch" placeholder="üîç Buscar por nombre, ID o tel√©fono..." onkeyup="searchAllClients()"></div>
<div id="searchResults" class="search-results" style="display:none;"></div>
</div>
<div class="button-row">
<button class="btn-primary" onclick="showAddClientModal()">‚ûï Agregar Cliente</button>
<button class="btn-primary" onclick="showAddPaymentModal()">üí∞ Registrar Pago</button>
</div>
<div class="button-row">
<button class="btn-morosidad" onclick="showMorosidadModal()">‚ö†Ô∏è Ver Morosidad</button>
<button class="btn-morosidad" style="background:#dc3545;" onclick="deleteAllClients()">üóëÔ∏è Eliminar Todos los Clientes</button>
</div>
<div class="client-list debt-clients-container" id="debtClientsSection" style="display:none;">
<h2 class="section-title"><span class="debt-indicator"></span>Clientes en Mora</h2>
<div class="clients-container" id="debtClientsContainer"><div id="debtClientsList"><div class="empty-state">No hay clientes en mora</div></div></div>
</div>
<div class="client-list">
<h2 class="section-title">Clientes del D√≠a</h2>
<div class="clients-container" id="clientsContainer"><div id="clientsList"><div class="empty-state">No hay clientes registrados</div></div></div>
</div>
<div class="payment-history">
<h2 class="section-title">Pagos del D√≠a</h2>
<div class="payments-container" id="paymentsContainer"><div id="paymentsList"><div class="empty-state">No hay pagos registrados</div></div></div>
</div>
</div>
<div id="addClientModal" class="modal">
<div class="modal-content">
<div class="modal-header"><h3 class="modal-title">Agregar Cliente</h3><button class="close-btn" onclick="closeModal('addClientModal')">&times;</button></div>
<form onsubmit="addClient(event)">
<div class="form-group"><label class="form-label">ID del Cliente</label><input type="text" class="form-input" id="clientId" required></div>
<div class="form-group"><label class="form-label">Nombre del Cliente</label><input type="text" class="form-input" id="clientName" required></div>
<div class="form-group"><label class="form-label">Tel√©fono (opcional)</label><input type="tel" class="form-input" id="clientPhone"></div>
<div class="form-group"><label class="form-label">Fecha de Desembolso</label><input type="date" class="form-input" id="clientDisbursementDate" required></div>
<div class="form-group"><label class="form-label">Frecuencia de Pago</label><select class="form-input" id="clientFrequency" required><option value="">Seleccionar frecuencia...</option><option value="DIARIO">Diario</option><option value="SEMANAL">Semanal</option><option value="QUINCENAL">Quincenal</option><option value="MENSUAL">Mensual</option></select></div>
<div class="form-group"><label class="form-label">Monto de Cuota</label><input type="number" class="form-input" id="clientQuota" step="0.01" required></div>
<div class="form-group"><label class="form-label">Plazo (n√∫mero de cuotas)</label><input type="number" class="form-input" id="clientTerm" min="1" required></div>
<button type="submit" class="btn-primary">Agregar Cliente</button>
</form>
</div>
</div>
<div id="editClientModal" class="modal">
<div class="modal-content">
<div class="modal-header"><h3 class="modal-title">Modificar Cliente</h3><button class="close-btn" onclick="closeModal('editClientModal')">&times;</button></div>
<form onsubmit="updateClient(event)">
<input type="hidden" id="editClientId">
<div class="form-group"><label class="form-label">Nombre del Cliente</label><input type="text" class="form-input" id="editClientName" required></div>
<div class="form-group"><label class="form-label">Tel√©fono (opcional)</label><input type="tel" class="form-input" id="editClientPhone"></div>
<div class="form-group"><label class="form-label">Fecha de Desembolso</label><input type="date" class="form-input" id="editClientDisbursementDate" required></div>
<div class="form-group"><label class="form-label">Frecuencia de Pago</label><select class="form-input" id="editClientFrequency" required><option value="">Seleccionar frecuencia...</option><option value="DIARIO">Diario</option><option value="SEMANAL">Semanal</option><option value="QUINCENAL">Quincenal</option><option value="MENSUAL">Mensual</option></select></div>
<div class="form-group"><label class="form-label">Monto de Cuota</label><input type="number" class="form-input" id="editClientQuota" step="0.01" required></div>
<div class="form-group"><label class="form-label">Plazo (n√∫mero de cuotas)</label><input type="number" class="form-input" id="editClientTerm" min="1" required></div>
<button type="submit" class="btn-primary">Guardar Cambios</button>
</form>
</div>
</div>
<div id="addPaymentModal" class="modal">
<div class="modal-content">
<div class="modal-header"><h3 class="modal-title">Registrar Pago</h3><button class="close-btn" onclick="closeModal('addPaymentModal')">&times;</button></div>
<form onsubmit="addPayment(event)">
<div class="form-group"><label class="form-label">Cliente</label><input type="text" class="form-input" id="clientSearchModal" placeholder="üîç Buscar y seleccionar cliente..." autocomplete="off" onkeyup="filterModalClients()" onfocus="showClientDropdown()" required><input type="hidden" id="selectedClientId" required><div id="clientDropdown" class="client-dropdown" style="display:none;"></div></div>
<div class="form-group"><label class="form-label">Tipo de Pago</label><div class="payment-type-selector"><div class="payment-type-btn" onclick="selectPaymentType('efectivo')"><div class="icon">üíµ</div><div class="label">Efectivo</div></div><div class="payment-type-btn" onclick="selectPaymentType('yape')"><div class="icon">üì±</div><div class="label">Yape</div></div><div class="payment-type-btn" onclick="selectPaymentType('parcial')"><div class="icon">üí∞</div><div class="label">Pago Parcial</div></div></div></div>
<div id="paymentInputsContainer" style="display:none;"><div class="payment-inputs" id="singlePaymentInputs" style="display:none;"><div class="form-group"><label class="form-label" id="singlePaymentLabel">Monto</label><input type="number" class="form-input" id="paymentAmountSingle" step="0.01" min="0"></div></div><div class="payment-inputs" id="partialPaymentInputs" style="display:none;"><div style="background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:20px;"><div class="form-group" style="margin-bottom:15px;"><label class="form-label">üíµ Monto en Efectivo</label><input type="number" class="form-input" id="paymentAmountCash" step="0.01" value="0" min="0" onkeyup="updatePaymentTotal()" onchange="updatePaymentTotal()"></div><div class="form-group" style="margin-bottom:15px;"><label class="form-label">üì± Monto en Yape</label><input type="number" class="form-input" id="paymentAmountYape" step="0.01" value="0" min="0" onkeyup="updatePaymentTotal()" onchange="updatePaymentTotal()"></div><div style="border-top:2px solid #dee2e6;padding-top:10px;margin-top:10px;"><div style="display:flex;justify-content:space-between;align-items:center;"><span style="font-weight:600;font-size:16px;">Total:</span><span id="paymentTotal" style="font-size:20px;font-weight:bold;color:#667eea;">S/0.00</span></div></div></div></div></div>
<div class="form-group"><label class="form-label">Nota (opcional)</label><input type="text" class="form-input" id="paymentNote"></div>
<button type="submit" class="btn-primary">Registrar Pago</button>
</form>
</div>
</div>
<div id="clientDetailsModal" class="modal">
<div class="modal-content">
<div class="modal-header"><h3 class="modal-title">Detalles del Cliente</h3><button class="close-btn" onclick="closeModal('clientDetailsModal')">&times;</button></div>
<div id="clientDetailsContent"></div>
</div>
</div>
<div id="scheduleModal" class="modal">
<div class="modal-content" style="max-width:800px;">
<div class="modal-header"><h3 class="modal-title">Cronograma de Pagos</h3><button class="close-btn" onclick="closeModal('scheduleModal')">&times;</button></div>
<div id="scheduleModalContent"></div>
</div>
</div>
<div id="movementsModal" class="modal">
<div class="modal-content">
<div class="modal-header"><h3 class="modal-title">Movimientos del Cliente</h3><button class="close-btn" onclick="closeModal('movementsModal')">&times;</button></div>
<div id="movementsModalContent"></div>
</div>
</div>
<div id="morosidadModal" class="modal morosidad-modal">
<div class="modal-content">
<div class="modal-header"><h3 class="modal-title">Reporte de Morosidad</h3><button class="close-btn" onclick="closeModal('morosidadModal')">&times;</button></div>
<div id="morosidadModalContent"></div>
</div>
</div>
<script>
let clients=[];let payments=[];let deferredPrompt;let selectedPaymentType='';
function getPeruvianDate(date=new Date()){const peruTime=new Date(date.toLocaleString("en-US",{timeZone:"America/Lima"}));return peruTime;}
function getPeruvianDateString(date=new Date()){const options={timeZone:'America/Lima',year:'numeric',month:'2-digit',day:'2-digit'};const peruDateStr=date.toLocaleDateString('en-CA',options);return peruDateStr;}
function getPeruvianISOString(date=new Date()){return new Date(date.toLocaleString("en-US",{timeZone:"America/Lima"})).toISOString();}
function formatPeruvianTime(dateString){const date=new Date(dateString);return date.toLocaleTimeString('es-PE',{timeZone:'America/Lima',hour:'2-digit',minute:'2-digit',second:'2-digit'});}
function formatPeruvianDate(dateString){if(!dateString)return'N/A';const[year,month,day]=dateString.split('-');return`${day}/${month}/${year}`;}
function formatNumber(num){if(typeof num!=='number'||isNaN(num))return'0.00';return num.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,',');}
function formatInteger(num){if(typeof num!=='number'||isNaN(num))return'0';return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g,',');}
function openWhatsApp(phone){if(!phone||phone.trim()===''){alert('Este cliente no tiene n√∫mero de tel√©fono registrado');return;}let cleanPhone=phone.replace(/\s+/g,'').replace(/[-()]/g,'');if(!cleanPhone.startsWith('+51')&&!cleanPhone.startsWith('51')){cleanPhone='+51'+cleanPhone;}else if(cleanPhone.startsWith('51')&&!cleanPhone.startsWith('+51')){cleanPhone='+'+cleanPhone;}const whatsappUrl=`https://wa.me/${cleanPhone.replace('+','')}`;window.open(whatsappUrl,'_blank');}
function makeCall(phone){if(!phone||phone.trim()===''){alert('Este cliente no tiene n√∫mero de tel√©fono registrado');return;}let cleanPhone=phone.replace(/\s+/g,'').replace(/[-()]/g,'');if(!cleanPhone.startsWith('+51')&&!cleanPhone.startsWith('51')){cleanPhone='+51'+cleanPhone;}else if(cleanPhone.startsWith('51')&&!cleanPhone.startsWith('+51')){cleanPhone='+'+cleanPhone;}const callUrl=`tel:${cleanPhone}`;window.location.href=callUrl;}
function formatExcelDate(excelDate){if(!excelDate)return'';if(excelDate instanceof Date){const year=excelDate.getFullYear();const month=(excelDate.getMonth()+1).toString().padStart(2,'0');const day=excelDate.getDate().toString().padStart(2,'0');return`${year}-${month}-${day}`;}if(typeof excelDate==='string'&&/^\d{4}-\d{2}-\d{2}$/.test(excelDate)){return excelDate;}if(typeof excelDate==='string'){excelDate=excelDate.trim();if(excelDate.includes('/')||excelDate.includes('-')){const parts=excelDate.split(/[/-]/);if(parts.length===3){let day,month,year;if(parts[0].length===4){year=parts[0];month=parts[1].padStart(2,'0');day=parts[2].padStart(2,'0');}else{day=parts[0].padStart(2,'0');month=parts[1].padStart(2,'0');if(parts[2].length===2){const currentYear=new Date().getFullYear();const century=Math.floor(currentYear/100)*100;const yearNum=parseInt(parts[2]);if(yearNum<=currentYear%100){year=century+yearNum;}else{year=(century-100)+yearNum;}}else{year=parts[2];}}const dateObj=new Date(parseInt(year),parseInt(month)-1,parseInt(day));if(!isNaN(dateObj.getTime())){return`${year}-${month}-${day}`;}}}}else if(typeof excelDate==='number'){const utcDays=Math.floor(excelDate-25569);const utcValue=utcDays*86400;const dateInfo=new Date(utcValue*1000);const year=dateInfo.getUTCFullYear();if(year<2020||year>2030){console.warn('Fecha fuera de rango:',year);return'';}const month=(dateInfo.getUTCMonth()+1).toString().padStart(2,'0');const day=dateInfo.getUTCDate().toString().padStart(2,'0');return`${year}-${month}-${day}`;}return'';}
function parseExcelNumber(value){if(typeof value==='number')return value;if(typeof value==='string'){value=value.trim();value=value.replace(/,/g,'');value=value.replace(/\s/g,'');value=value.replace('S/.','');value=value.replace('S/','');const num=parseFloat(value);return isNaN(num)?0:num;}return 0;}
function cleanText(text){if(!text)return text;return text.replace(/ÔøΩ/g,'√±').replace(/√ë/g,'√ë').replace(/√±/g,'√±').replace(/√É¬±/g,'√±').replace(/√É'/g,'√ë').replace(/√É¬°/g,'√°').replace(/√É¬©/g,'√©').replace(/√É¬≠/g,'√≠').replace(/√É¬≥/g,'√≥').replace(/√É¬∫/g,'√∫').replace(/√É/g,'√Å').replace(/√É‚Ä∞/g,'√â').replace(/√É/g,'√ç').replace(/√É"/g,'√ì').replace(/√É≈°/g,'√ö').replace(/√°/g,'√°').replace(/√©/g,'√©').replace(/√≠/g,'√≠').replace(/√≥/g,'√≥').replace(/√∫/g,'√∫').replace(/√É¬º/g,'√º').replace(/√É¬§/g,'√§').replace(/√É¬∂/g,'√∂').replace(/√Ç¬ø/g,'¬ø').replace(/√Ç¬°/g,'¬°').replace(/√¢‚Ç¨≈ì/g,'"').replace(/√¢‚Ç¨/g,'"').replace(/√¢‚Ç¨‚Ñ¢/g,"'").replace(/√¢‚Ç¨Àú/g,"'").replace(/√¢‚Ç¨"/g,'‚Äì').replace(/√¢‚Ç¨"/g,'‚Äî').replace(/\u00f1/g,'√±').replace(/\u00d1/g,'√ë').replace(/\u00e1/g,'√°').replace(/\u00e9/g,'√©').replace(/\u00ed/g,'√≠').replace(/\u00f3/g,'√≥').replace(/\u00fa/g,'√∫').replace(/\u00c1/g,'√Å').replace(/\u00c9/g,'√â').replace(/\u00cd/g,'√ç').replace(/\u00d3/g,'√ì').replace(/\u00da/g,'√ö');}
function mapFrequency(freq){if(!freq)return'';const upperFreq=freq.toString().toUpperCase().trim();const mappings={'DIAR':'DIARIO','SEMA':'SEMANAL','QUIN':'QUINCENAL','MENS':'MENSUAL','DIARIO':'DIARIO','DIARIA':'DIARIO','SEMANAL':'SEMANAL','QUINCENAL':'QUINCENAL','MENSUAL':'MENSUAL','D':'DIARIO','S':'SEMANAL','Q':'QUINCENAL','M':'MENSUAL'};if(mappings[upperFreq]){return mappings[upperFreq];}if(upperFreq.includes('DIAR'))return'DIARIO';if(upperFreq.includes('SEMA'))return'SEMANAL';if(upperFreq.includes('QUIN'))return'QUINCENAL';if(upperFreq.includes('MENS'))return'MENSUAL';console.warn('Frecuencia no reconocida:',freq);return'';}
function handleExcelUpload(event){const file=event.target.files[0];if(!file)return;const reader=new FileReader();reader.onload=function(e){try{let fileContent=e.target.result;let data=[];let columnMap={};let isHtmlContent=false;if(file.name.toLowerCase().endsWith('.xls')){try{const decoder=new TextDecoder('windows-1252');fileContent=decoder.decode(new Uint8Array(fileContent));isHtmlContent=fileContent.includes('<table')||fileContent.includes('<TABLE')||fileContent.includes('<tr')||fileContent.includes('<TR');}catch(err){console.error('Error decodificando:',err);}}else{isHtmlContent=typeof fileContent==='string'&&(fileContent.includes('<table')||fileContent.includes('<TABLE')||fileContent.includes('<tr')||fileContent.includes('<TR'));}if(isHtmlContent){const htmlContent=fileContent;const rowMatches=htmlContent.match(/<tr[^>]*>[\s\S]*?<\/tr>/gi)||[];function extractCellContent(rowHtml){const cellMatches=rowHtml.match(/<t[hd][^>]*>([^<]*)<\/t[hd]>/gi)||[];return cellMatches.map(cell=>{const content=cell.replace(/<[^>]+>/g,'').trim();return cleanText(content);});}let headerRowIndex=-1;let headers=[];for(let i=0;i<rowMatches.length;i++){const cells=extractCellContent(rowMatches[i]);if(cells.some(cell=>cell==='Id'||cell==='Nombre')){headerRowIndex=i;headers=cells;break;}}if(headerRowIndex===-1){alert('No se encontraron las columnas esperadas en el archivo');return;}columnMap={id:headers.indexOf('Id'),nombre:headers.indexOf('Nombre'),telefono:headers.findIndex(h=>h.includes('Tel')),fechaDesem:headers.findIndex(h=>h.includes('Fecha Desem')),monto:headers.indexOf('Monto'),plz:headers.indexOf('Plz'),frecPago:headers.findIndex(h=>h.includes('Frec Pago')),montoCuota:headers.findIndex(h=>h.includes('Monto Cuota')),mora:headers.indexOf('Mora'),totalAtraso:headers.findIndex(h=>h.includes('Total Atraso')),diaAtr:headers.findIndex(h=>h.includes('Dia Atr')),totalDeuda:headers.findIndex(h=>h.includes('Total Deuda'))};console.log('Mapeo de columnas:',columnMap);console.log('Headers encontrados:',headers);for(let i=headerRowIndex+1;i<rowMatches.length;i++){const cells=extractCellContent(rowMatches[i]);if(cells.length>columnMap.id&&cells[columnMap.id]){data.push(cells);}}}else{const workbook=XLSX.read(new Uint8Array(fileContent),{type:'array',cellDates:false,raw:true});const firstSheet=workbook.Sheets[workbook.SheetNames[0]];const jsonData=XLSX.utils.sheet_to_json(firstSheet,{header:1,raw:true});if(jsonData.length<2){alert('El archivo Excel est√° vac√≠o o no tiene el formato correcto');return;}const headers=jsonData[0];console.log('Headers encontrados:',headers);columnMap={id:headers.indexOf('Id'),nombre:headers.indexOf('Nombre'),telefono:headers.findIndex(h=>h&&h.toString().includes('Tel')),fechaDesem:headers.findIndex(h=>h&&h.toString().includes('Fecha Desem')),monto:headers.indexOf('Monto'),plz:headers.indexOf('Plz'),frecPago:headers.findIndex(h=>h&&h.toString().includes('Frec Pago')),montoCuota:headers.findIndex(h=>h&&h.toString().includes('Monto Cuota')),mora:headers.indexOf('Mora'),totalAtraso:headers.findIndex(h=>h&&h.toString().includes('Total Atraso')),diaAtr:headers.findIndex(h=>h&&h.toString().includes('Dia Atr')),totalDeuda:headers.findIndex(h=>h&&h.toString().includes('Total Deuda'))};data=jsonData.slice(1);}let updatedCount=0;let addedCount=0;let errorCount=0;const errors=[];for(let i=0;i<data.length;i++){const row=data[i];if(!row[columnMap.id]||!row[columnMap.nombre])continue;try{const id=row[columnMap.id].toString().trim();const name=cleanText(row[columnMap.nombre].toString().trim());const phone=columnMap.telefono>=0&&row[columnMap.telefono]?row[columnMap.telefono].toString().trim():'';const disbursementDate=columnMap.fechaDesem>=0&&row[columnMap.fechaDesem]?formatExcelDate(row[columnMap.fechaDesem]):'';const monto=columnMap.monto>=0&&row[columnMap.monto]?parseExcelNumber(row[columnMap.monto]):0;const term=columnMap.plz>=0&&row[columnMap.plz]?parseInt(row[columnMap.plz]):0;const frequency=columnMap.frecPago>=0&&row[columnMap.frecPago]?mapFrequency(row[columnMap.frecPago].toString().trim()):'';const quota=columnMap.montoCuota>=0&&row[columnMap.montoCuota]?parseExcelNumber(row[columnMap.montoCuota]):0;const mora=columnMap.mora>=0&&row[columnMap.mora]?parseExcelNumber(row[columnMap.mora]):0;const totalAtraso=columnMap.totalAtraso>=0&&row[columnMap.totalAtraso]?parseExcelNumber(row[columnMap.totalAtraso]):0;const diasAtraso=columnMap.diaAtr>=0&&row[columnMap.diaAtr]?parseInt(row[columnMap.diaAtr]):0;const totalDeuda=columnMap.totalDeuda>=0&&row[columnMap.totalDeuda]?parseExcelNumber(row[columnMap.totalDeuda]):0;if(!disbursementDate){errors.push(`Fila ${i+1}: Fecha de desembolso inv√°lida para ${name}`);errorCount++;continue;}if(!term||term<=0){errors.push(`Fila ${i+1}: Plazo inv√°lido para ${name}`);errorCount++;continue;}if(!frequency){errors.push(`Fila ${i+1}: Frecuencia inv√°lida para ${name} (valor original: "${columnMap.frecPago>=0&&row[columnMap.frecPago]?row[columnMap.frecPago]:'vac√≠o'}")`);errorCount++;continue;}if(!quota||quota<=0){errors.push(`Fila ${i+1}: Monto de cuota inv√°lido para ${name}`);errorCount++;continue;}const existingClient=clients.find(c=>c.id===id);if(existingClient){existingClient.name=name;existingClient.phone=phone;existingClient.disbursementDate=disbursementDate;existingClient.term=term;existingClient.frequency=frequency;existingClient.quota=quota;existingClient.monto=monto;existingClient.mora=mora;existingClient.totalAtraso=totalAtraso;existingClient.diasAtraso=diasAtraso;existingClient.totalDeuda=totalDeuda;updatedCount++;console.log('Cliente actualizado:',existingClient);}else{const newClient={id:id,name:name,phone:phone,disbursementDate:disbursementDate,frequency:frequency,quota:quota,term:term,monto:monto,mora:mora,totalAtraso:totalAtraso,diasAtraso:diasAtraso,totalDeuda:totalDeuda,createdAt:getPeruvianISOString()};clients.push(newClient);addedCount++;console.log('Cliente agregado:',newClient);}}catch(err){errors.push(`Fila ${i+1}: Error al procesar - ${err.message}`);errorCount++;}}saveData();updateDisplay();let message=`Archivo procesado:\n- Clientes nuevos: ${addedCount}\n- Clientes actualizados: ${updatedCount}`;const morosidadCount=clients.filter(c=>c.diasAtraso>0).length;message+=`\n- Clientes en mora: ${morosidadCount}`;if(errorCount>0){message+=`\n- Errores: ${errorCount}\n\nDetalles de errores:\n${errors.slice(0,5).join('\n')}`;if(errors.length>5){message+=`\n... y ${errors.length-5} errores m√°s`;}}alert(message);event.target.value='';}catch(error){alert('Error al procesar el archivo. Aseg√∫rate de que sea un archivo Excel v√°lido.\n\nError: '+error.message);console.error('Error completo:',error);event.target.value='';}};if(file.name.toLowerCase().endsWith('.xls')){reader.readAsArrayBuffer(file);}else{reader.readAsArrayBuffer(file);}}
const excelClients=[{"id":"25398","name":"TUCTO ESPINOZA, CARMEN OLIVIA","phone":"938752424","disbursementDate":"2025-06-25","frequency":"DIARIO","quota":42.6,"term":25},{"id":"25303","name":"CAMASCCA ALIAGA, ELENA","phone":"900233985","disbursementDate":"2025-06-20","frequency":"DIARIO","quota":51.2,"term":25},{"id":"25107","name":"CAMPOS OLORTEGUI, JOSUE JOEL","phone":"930582986","disbursementDate":"2025-06-18","frequency":"SEMANAL","quota":270,"term":4},{"id":"25058","name":"CHAVEZ BALDOCEDA, EMILIA RUFINA","phone":"993530298","disbursementDate":"2025-07-01","frequency":"SEMANAL","quota":675,"term":4},{"id":"25035","name":"VASQUEZ FLORES DE ALVARADO, LUCIOLA","phone":"937451188","disbursementDate":"2025-06-30","frequency":"SEMANAL","quota":270,"term":4},{"id":"25029","name":"JUSTINIANO ACASIO, CELIA JUDITH","phone":"974418205","disbursementDate":"2025-06-26","frequency":"SEMANAL","quota":675,"term":4},{"id":"25026","name":"TAFUR ROBLES, MARITZA MARTHA","phone":"931079187","disbursementDate":"2025-06-11","frequency":"MENSUAL","quota":525,"term":1},{"id":"24761","name":"CHOCSE ROBLES, EMPERATRIZ ISABEL","phone":"964584852","disbursementDate":"2025-06-12","frequency":"SEMANAL","quota":2120,"term":8},{"id":"24736","name":"BAUTISTA CARDOZA, ELMER","phone":"967113190","disbursementDate":"2025-06-30","frequency":"DIARIO","quota":29.1,"term":20},{"id":"24717","name":"ESPINOZA RODRIGUEZ, RONALD JAIRO","phone":"918942359","disbursementDate":"2025-06-12","frequency":"DIARIO","quota":85.2,"term":25},{"id":"24682","name":"LESCANO EGUSQUIZA, FERNANDO SEGUNDO","phone":"962996866","disbursementDate":"2025-06-30","frequency":"SEMANAL","quota":220,"term":4},{"id":"24273","name":"MEJIA DELGADILLO, MOISES CHRISTIAM","phone":"952934566","disbursementDate":"2025-05-30","frequency":"SEMANAL","quota":926.7,"term":6},{"id":"24241","name":"CORPORACION TABERNA E.I.R.L.","phone":"944240156","disbursementDate":"2025-06-19","frequency":"SEMANAL","quota":3252,"term":6},{"id":"23988","name":"OYOLA RIVERA, CESAR AUGUSTO","phone":"997917602","disbursementDate":"2025-06-30","frequency":"DIARIO","quota":43.2,"term":30},{"id":"23202","name":"ATACHAGUA FRETEL, ANNY DALIS","phone":"940772732","disbursementDate":"2025-06-30","frequency":"SEMANAL","quota":237.6,"term":4},{"id":"22295","name":"LIVIAPOMA COLLACHAGUA, JACQUELINE JESSICA","phone":"989200585","disbursementDate":"2025-06-19","frequency":"SEMANAL","quota":1080,"term":4},{"id":"20633","name":"GARCIA TOSCANO, NORMA","phone":"929023145","disbursementDate":"2025-06-23","frequency":"SEMANAL","quota":540,"term":4},{"id":"19899","name":"ILLATOPA GALLARDO, MARIA","phone":"907226424","disbursementDate":"2024-10-31","frequency":"MENSUAL","quota":30035.51,"term":1},{"id":"18861","name":"ORIZANO SIMON, MARIA ELENA","phone":"966200489","disbursementDate":"2025-06-17","frequency":"DIARIO","quota":426,"term":25},{"id":"15570","name":"COPYMAX PLUS E.I.R.L","phone":"952847664","disbursementDate":"2025-05-21","frequency":"DIARIO","quota":565,"term":60},{"id":"15570b","name":"COPYMAX PLUS E.I.R.L","phone":"952847664","disbursementDate":"2025-06-13","frequency":"DIARIO","quota":565,"term":60},{"id":"15027","name":"PONCE AYRA, DINA","phone":"925460243","disbursementDate":"2024-11-29","frequency":"MENSUAL","quota":18611.61,"term":1},{"id":"8582","name":"ILLATOPA REYES, CINTHIA KARINA","phone":"918266071","disbursementDate":"2025-06-27","frequency":"DIARIO","quota":213,"term":25},{"id":"8235","name":"SERVICIOS GENERALES MOTOKAR Y BAJAJ E.I.R.L","phone":"976193292","disbursementDate":"2025-06-30","frequency":"DIARIO","quota":765.3,"term":60},{"id":"8166","name":"DAVILA DAVIRAN, YOSBET","phone":"929024811","disbursementDate":"2025-06-27","frequency":"DIARIO","quota":63.9,"term":25},{"id":"7350","name":"QUESHYAC TAMARA, FABIAN ALFONSIN","phone":"983360447","disbursementDate":"2025-06-30","frequency":"DIARIO","quota":89.9,"term":25},{"id":"3599","name":"RUIZ RODRIGUEZ, OLGA","phone":"954981005","disbursementDate":"2025-06-12","frequency":"SEMANAL","quota":405,"term":4}];
function init(){loadData();importExcelClients();setToday();updateDisplay();document.addEventListener('click',function(e){if(!e.target.closest('.form-group')){hideClientDropdown();}});document.addEventListener('touchstart',function(){},{passive:true});document.addEventListener('touchmove',function(){},{passive:true});}
function importExcelClients(){localStorage.removeItem('excelClientsImported_MENA');localStorage.removeItem('excelClientsImported_MENA_v1');localStorage.removeItem('excelClientsImported_MENA_v2');localStorage.removeItem('excelClientsImported_MENA_v3');localStorage.removeItem('excelClientsImported_MENA_v4');localStorage.removeItem('excelClientsImported_MENA_v5');localStorage.removeItem('excelClientsImported_MENA_v6');localStorage.removeItem('excelClientsImported_MENA_v7');localStorage.removeItem('excelClientsImported_MENA_v8');localStorage.removeItem('excelClientsImported_MENA_v9');localStorage.removeItem('excelClientsImported_MENA_v10');const savedImport=localStorage.getItem('excelClientsImported_MENA_v11');if(!savedImport){excelClients.forEach(excelClient=>{const existingClient=clients.find(c=>c.id===excelClient.id);if(existingClient){existingClient.quota=excelClient.quota;existingClient.term=excelClient.term;existingClient.disbursementDate=excelClient.disbursementDate;existingClient.frequency=excelClient.frequency;existingClient.phone=excelClient.phone;existingClient.name=excelClient.name;}else{clients.push({id:excelClient.id,name:excelClient.name,phone:excelClient.phone,disbursementDate:excelClient.disbursementDate,frequency:excelClient.frequency,quota:excelClient.quota,term:excelClient.term,createdAt:getPeruvianISOString()});}});localStorage.setItem('excelClientsImported_MENA_v11','true');saveData();}}
function searchAllClients(){const searchTerm=document.getElementById('generalClientSearch').value.toLowerCase();const resultsContainer=document.getElementById('searchResults');if(searchTerm===''){resultsContainer.style.display='none';return;}const filteredClients=clients.filter(client=>client.name.toLowerCase().includes(searchTerm)||client.id.includes(searchTerm)||(client.phone&&client.phone.includes(searchTerm)));resultsContainer.style.display='block';if(filteredClients.length===0){resultsContainer.innerHTML='<div class="no-results">No se encontraron clientes</div>';}else{resultsContainer.innerHTML=filteredClients.map(client=>`<div class="search-result-item" onclick="showClientDetailsModal('${client.id}')"><div style="font-size:11px;color:#999;">ID: ${client.id}</div><div style="font-weight:600;">${client.name}</div>${client.phone?`<div style="font-size:13px;color:#666;">${client.phone}</div>`:''}</div>`).join('');}}
function showClientDetailsModal(clientId){const client=clients.find(c=>c.id===clientId);if(!client)return;const today=getPeruvianDate();const nextPaymentInfo=getNextPaymentDate(client);const clientPayments=payments.filter(p=>p.clientId===clientId);const totalPaid=clientPayments.reduce((sum,p)=>sum+p.amount,0);const totalDeuda=client.totalDeuda||(client.quota?(client.quota*client.term)-totalPaid:0);const content=document.getElementById('clientDetailsContent');content.innerHTML=`<div class="client-detail-info"><div class="detail-row"><span class="detail-label">ID:</span><span class="detail-value">${client.id}</span></div><div class="detail-row"><span class="detail-label">Nombre:</span><span class="detail-value">${client.name}</span></div><div class="detail-row"><span class="detail-label">Tel√©fono:</span><span class="detail-value">${client.phone||'No registrado'}</span></div><div class="detail-row"><span class="detail-label">Fecha de desembolso:</span><span class="detail-value">${client.disbursementDate?formatPeruvianDate(client.disbursementDate):'N/A'}</span></div><div class="detail-row"><span class="detail-label">Frecuencia:</span><span class="detail-value">${client.frequency||'N/A'}</span></div><div class="detail-row"><span class="detail-label">Cuota:</span><span class="detail-value" style="color:#1a5490;">S/${client.quota?formatNumber(client.quota):'0.00'}</span></div><div class="detail-row"><span class="detail-label">Plazo:</span><span class="detail-value">${client.term?formatInteger(client.term):'N/A'} cuotas</span></div>${client.diasAtraso>0?`<div class="detail-row"><span class="detail-label">D√≠as de atraso:</span><span class="detail-value" style="color:#dc3545;">${client.diasAtraso} d√≠as</span></div><div class="detail-row"><span class="detail-label">Mora:</span><span class="detail-value" style="color:#dc3545;">S/${formatNumber(client.mora||0)}</span></div><div class="detail-row"><span class="detail-label">Total atraso:</span><span class="detail-value" style="color:#dc3545;">S/${formatNumber(client.totalAtraso||0)}</span></div>`:''}<div class="detail-row"><span class="detail-label">Pr√≥ximo pago:</span><span class="detail-value">${nextPaymentInfo}</span></div><div class="detail-row"><span class="detail-label">Total pagado:</span><span class="detail-value" style="color:#28a745;">S/${formatNumber(totalPaid)}</span></div><div class="detail-row"><span class="detail-label">Total deuda:</span><span class="detail-value" style="color:#dc3545;">S/${formatNumber(totalDeuda)}</span></div><div class="detail-row"><span class="detail-label">N√∫mero de pagos:</span><span class="detail-value">${formatInteger(clientPayments.length)}</span></div></div><div class="action-buttons"><button class="btn-action btn-schedule" onclick="showPaymentSchedule('${client.id}')">üìÖ Crono</button><button class="btn-action btn-movements" onclick="showClientMovements('${client.id}')">üìä Mov.</button>${client.phone?`<button class="btn-action btn-call" onclick="makeCall('${client.phone}')">üìû Llamar</button><button class="btn-action btn-whatsapp" onclick="openWhatsApp('${client.phone}')">üì± WhatsApp</button>`:''}<button class="btn-action btn-edit-client" onclick="showEditClientModal('${client.id}');closeModal('clientDetailsModal');">‚úèÔ∏è Modificar</button><button class="btn-action btn-delete-client" onclick="deleteClientFromDetails('${client.id}')">üóëÔ∏è Eliminar</button></div>`;showModal('clientDetailsModal');}
function showClientMovements(clientId){const client=clients.find(c=>c.id===clientId);if(!client)return;const clientPayments=payments.filter(p=>p.clientId===clientId).sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp));let movementsHTML=`<div style="margin-bottom:20px;"><h4 style="margin:0;">${client.name}</h4><p style="margin:5px 0;color:#666;">ID: ${client.id}</p></div>`;if(clientPayments.length===0){movementsHTML+=`<div class="empty-state">No hay movimientos registrados para este cliente</div>`;}else{movementsHTML+=`<div class="movements-list">`;clientPayments.forEach(payment=>{const methodIcon=payment.method==='yape'?'üì±':'üíµ';const methodText=payment.method==='yape'?'Yape':'Efectivo';movementsHTML+=`<div class="movement-item"><div class="movement-date">${formatPeruvianDate(payment.date)}</div><div class="movement-details"><div><span class="movement-method">${methodIcon} ${methodText}</span>${payment.note?`<div style="font-size:12px;color:#999;margin-top:3px;">${payment.note}</div>`:''}</div><div class="movement-amount">S/${formatNumber(payment.amount)}</div></div><div style="font-size:11px;color:#999;margin-top:5px;">${formatPeruvianTime(payment.timestamp)}</div></div>`;});movementsHTML+=`</div>`;const totalPaid=clientPayments.reduce((sum,p)=>sum+p.amount,0);movementsHTML+=`<div style="margin-top:20px;padding:15px;background:#f8f9fa;border-radius:8px;"><div style="display:flex;justify-content:space-between;"><strong>Total de movimientos:</strong><span style="color:#28a745;font-weight:bold;">S/${formatNumber(totalPaid)}</span></div></div>`;}document.getElementById('movementsModalContent').innerHTML=movementsHTML;showModal('movementsModal');}
function deleteClientFromDetails(clientId){if(confirm('¬øEst√°s seguro de eliminar este cliente? Se mantendr√°n los pagos hist√≥ricos.')){clients=clients.filter(c=>c.id!==clientId);saveData();updateDisplay();closeModal('clientDetailsModal');}}
function getNextPaymentDate(client){if(!client.disbursementDate){return'N/A';}const today=getPeruvianDateString();const todayParts=today.split('-');const todayDate=new Date(parseInt(todayParts[0]),parseInt(todayParts[1])-1,parseInt(todayParts[2]));for(let i=1;i<=60;i++){const checkDate=new Date(todayDate);checkDate.setDate(checkDate.getDate()+i);const checkDateStr=`${checkDate.getFullYear()}-${String(checkDate.getMonth()+1).padStart(2,'0')}-${String(checkDate.getDate()).padStart(2,'0')}`;if(shouldPayOnDate(client,checkDateStr)){return`${String(checkDate.getDate()).padStart(2,'0')}/${String(checkDate.getMonth()+1).padStart(2,'0')}/${checkDate.getFullYear()}`;}}return'N/A';}
function shouldPayOnDate(client,checkDate){if(!client.disbursementDate||!client.frequency){return false;}const[disbYear,disbMonth,disbDay]=client.disbursementDate.split('-').map(n=>parseInt(n));const[checkYear,checkMonth,checkDay]=checkDate.split('-').map(n=>parseInt(n));if(isNaN(disbYear)||isNaN(disbMonth)||isNaN(disbDay)||isNaN(checkYear)||isNaN(checkMonth)||isNaN(checkDay)){console.warn('Fecha inv√°lida en shouldPayOnDate:',client.disbursementDate,checkDate);return false;}const disbursementDate=new Date(disbYear,disbMonth-1,disbDay);const targetDate=new Date(checkYear,checkMonth-1,checkDay);if(targetDate<=disbursementDate){return false;}const daysDiff=Math.floor((targetDate-disbursementDate)/(1000*60*60*24));const dayOfWeek=targetDate.getDay();switch(client.frequency){case'DIARIO':return dayOfWeek>=1&&dayOfWeek<=5&&daysDiff>=1;case'SEMANAL':return daysDiff>0&&daysDiff%7===0;case'QUINCENAL':return daysDiff>0&&daysDiff%15===0;case'MENSUAL':if(daysDiff<28)return false;const monthsDiff=(checkYear-disbYear)*12+(checkMonth-disbMonth);if(monthsDiff<1)return false;if(checkDay===disbDay){return true;}const lastDayOfTargetMonth=new Date(checkYear,checkMonth,0).getDate();if(checkDay===lastDayOfTargetMonth&&disbDay>lastDayOfTargetMonth){return true;}if(disbDay>28&&checkDay===lastDayOfTargetMonth){return true;}return false;default:console.warn('Frecuencia no reconocida:',client.frequency);return false;}}
function loadData(){const savedClients=localStorage.getItem('clients_MENA');const savedPayments=localStorage.getItem('payments_MENA');if(savedClients)clients=JSON.parse(savedClients);if(savedPayments)payments=JSON.parse(savedPayments);}
function saveData(){localStorage.setItem('clients_MENA',JSON.stringify(clients));localStorage.setItem('payments_MENA',JSON.stringify(payments));}
function setToday(){const today=getPeruvianDateString();document.getElementById('dateFilter').value=today;updateDisplay();}
function updateDisplay(){const selectedDate=document.getElementById('dateFilter').value;updateStats(selectedDate);updateDebtClients();updateClientsList(selectedDate);updatePaymentsList(selectedDate);}
function updateDebtClients(){const debtClients=clients.filter(c=>c.diasAtraso>0);const debtSection=document.getElementById('debtClientsSection');const debtList=document.getElementById('debtClientsList');if(debtClients.length===0){debtSection.style.display='none';return;}debtSection.style.display='block';debtList.innerHTML=debtClients.sort((a,b)=>b.diasAtraso-a.diasAtraso).map(client=>{return`<div class="client-item in-debt" onclick="showClientDetailsModal('${client.id}')"><div style="flex:1;"><div style="font-weight:600;font-size:16px;color:#333;margin-bottom:8px;">${client.name}</div><div style="display:flex;align-items:center;gap:12px;margin-bottom:5px;flex-wrap:wrap;"><span class="client-status status-overdue">${client.diasAtraso} d√≠as atraso</span><span class="debt-badge">Mora: S/${formatNumber(client.mora||0)}</span><span style="background:#dc3545;color:white;padding:2px 8px;border-radius:6px;font-size:12px;font-weight:600;">Total: S/${formatNumber(client.totalAtraso||0)}</span></div></div><button class="btn-circle btn-pay" onclick="event.stopPropagation();quickPaymentDebt('${client.id}');" title="Pago r√°pido">üí∞</button></div>`;}).join('');}
function updateStats(date){const dayPayments=payments.filter(p=>p.date===date);const total=dayPayments.reduce((sum,p)=>sum+p.amount,0);const uniqueClients=new Set(dayPayments.map(p=>p.clientId)).size;const cashTotal=dayPayments.filter(p=>p.method==='efectivo').reduce((sum,p)=>sum+p.amount,0);const yapeTotal=dayPayments.filter(p=>p.method==='yape').reduce((sum,p)=>sum+p.amount,0);document.getElementById('totalPaid').textContent=`S/${formatNumber(total)}`;document.getElementById('clientsPaid').textContent=formatInteger(uniqueClients);document.getElementById('totalCash').textContent=`S/${formatNumber(cashTotal)}`;document.getElementById('totalYape').textContent=`S/${formatNumber(yapeTotal)}`;}
function updateClientsList(date){const clientsList=document.getElementById('clientsList');const dayPayments=payments.filter(p=>p.date===date);const clientsToPayToday=clients.filter(client=>shouldPayOnDate(client,date));if(clientsToPayToday.length===0){clientsList.innerHTML='<div class="empty-state">No hay clientes que deban pagar hoy</div>';return;}clientsList.innerHTML=clientsToPayToday.map(client=>{const clientPayments=dayPayments.filter(p=>p.clientId===client.id);const hasPaid=clientPayments.length>0;const totalPaid=clientPayments.reduce((sum,p)=>sum+p.amount,0);const freqClass={'DIARIO':'freq-diario','SEMANAL':'freq-semanal','QUINCENAL':'freq-quincenal','MENSUAL':'freq-mensual'}[client.frequency];const displayQuota=client.diasAtraso>0?client.totalAtraso:client.quota;return`<div class="client-item" onclick="showClientDetailsModal('${client.id}')"><div style="flex:1;min-width:0;margin-right:10px;"><div style="font-weight:600;font-size:16px;color:#333;margin-bottom:8px;line-height:1.3;word-wrap:break-word;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;">${client.name}</div><div style="display:flex;align-items:center;gap:8px;margin-bottom:5px;flex-wrap:wrap;"><span class="client-status ${hasPaid?'status-paid':'status-pending'}">${hasPaid?'Pag√≥':'Pendiente'}</span><span class="frequency-badge ${freqClass}" style="text-transform:uppercase;font-size:11px;">${client.frequency}</span>${displayQuota?`<span class="client-quota" style="font-size:14px;">S/${formatNumber(displayQuota)}</span>`:''}</div>${hasPaid?`<div style="font-size:12px;color:#666;">Pag√≥: S/${formatNumber(totalPaid)}</div>`:''}</div><button class="btn-circle btn-pay" onclick="event.stopPropagation();quickPayment('${client.id}');" title="Pago r√°pido">üí∞</button></div>`;}).join('');}
function selectPaymentType(type){selectedPaymentType=type;const buttons=document.querySelectorAll('.payment-type-btn');buttons.forEach(btn=>btn.classList.remove('active'));event.target.closest('.payment-type-btn').classList.add('active');document.getElementById('paymentInputsContainer').style.display='block';const clientId=document.getElementById('selectedClientId').value;if(clientId){const client=clients.find(c=>c.id===clientId);if(client){const montoSugerido=client.diasAtraso>0?client.totalAtraso:client.quota;if(type==='parcial'){document.getElementById('singlePaymentInputs').style.display='none';document.getElementById('partialPaymentInputs').style.display='block';document.getElementById('paymentAmountCash').value=montoSugerido||'0';document.getElementById('paymentAmountYape').value='0';updatePaymentTotal();}else{document.getElementById('partialPaymentInputs').style.display='none';document.getElementById('singlePaymentInputs').style.display='block';const label=type==='efectivo'?'üíµ Monto en Efectivo':'üì± Monto en Yape';document.getElementById('singlePaymentLabel').textContent=label;document.getElementById('paymentAmountSingle').value=montoSugerido||'';}}}else{if(type==='parcial'){document.getElementById('singlePaymentInputs').style.display='none';document.getElementById('partialPaymentInputs').style.display='block';document.getElementById('paymentAmountCash').value='0';document.getElementById('paymentAmountYape').value='0';updatePaymentTotal();}else{document.getElementById('partialPaymentInputs').style.display='none';document.getElementById('singlePaymentInputs').style.display='block';const label=type==='efectivo'?'üíµ Monto en Efectivo':'üì± Monto en Yape';document.getElementById('singlePaymentLabel').textContent=label;document.getElementById('paymentAmountSingle').value='';}}}
function updatePaymentTotal(){const cashAmount=parseFloat(document.getElementById('paymentAmountCash').value)||0;const yapeAmount=parseFloat(document.getElementById('paymentAmountYape').value)||0;const total=cashAmount+yapeAmount;document.getElementById('paymentTotal').textContent=`S/${formatNumber(total)}`;}
function updatePaymentsList(date){const paymentsList=document.getElementById('paymentsList');const dayPayments=payments.filter(p=>p.date===date);if(dayPayments.length===0){paymentsList.innerHTML='<div class="empty-state">No hay pagos registrados</div>';return;}const groupedPayments={};dayPayments.forEach(payment=>{if(!groupedPayments[payment.timestamp]){groupedPayments[payment.timestamp]=[];}groupedPayments[payment.timestamp].push(payment);});const sortedGroups=Object.entries(groupedPayments).sort((a,b)=>new Date(b[0])-new Date(a[0]));paymentsList.innerHTML=sortedGroups.map(([timestamp,paymentGroup])=>{const client=clients.find(c=>c.id===paymentGroup[0].clientId);const totalAmount=paymentGroup.reduce((sum,p)=>sum+p.amount,0);const hasCash=paymentGroup.some(p=>p.method==='efectivo');const hasYape=paymentGroup.some(p=>p.method==='yape');const isMixed=hasCash&&hasYape;let methodDisplay='';if(isMixed){const cashAmount=paymentGroup.filter(p=>p.method==='efectivo').reduce((sum,p)=>sum+p.amount,0);const yapeAmount=paymentGroup.filter(p=>p.method==='yape').reduce((sum,p)=>sum+p.amount,0);methodDisplay=`<span class="payment-method method-mixto">üí∞ Mixto</span><div style="font-size:11px;color:#666;margin-top:3px;">üíµ S/${formatNumber(cashAmount)} | üì± S/${formatNumber(yapeAmount)}</div>`;}else{const payment=paymentGroup[0];const methodIcon=payment.method==='yape'?'üì±':'üíµ';const methodClass=payment.method==='yape'?'method-yape':'method-efectivo';const methodText=payment.method==='yape'?'Yape':'Efectivo';methodDisplay=`<span class="payment-method ${methodClass}">${methodIcon} ${methodText}</span>`;}return`<div class="payment-item"><div class="payment-id">ID: ${client?client.id:'N/A'}</div><div class="payment-client">${client?client.name:'Cliente eliminado'}${methodDisplay}</div><div class="payment-details"><span>${paymentGroup[0].note||'Sin nota'}</span><span class="payment-amount">S/${formatNumber(totalAmount)}</span></div><div class="payment-details"><span>${formatPeruvianTime(paymentGroup[0].timestamp)}</span><button class="btn-danger" onclick="deletePaymentGroup('${timestamp}')">Eliminar</button></div></div>`;}).join('');}
function showClientDropdown(){const dropdown=document.getElementById('clientDropdown');dropdown.style.display='block';filterModalClients();}
function hideClientDropdown(){const dropdown=document.getElementById('clientDropdown');dropdown.style.display='none';}
function filterModalClients(){const searchTerm=document.getElementById('clientSearchModal').value.toLowerCase();const dropdown=document.getElementById('clientDropdown');const filteredClients=clients.filter(client=>client.name.toLowerCase().includes(searchTerm)||(client.phone&&client.phone.includes(searchTerm)));if(filteredClients.length===0){dropdown.innerHTML='<div class="no-results">No se encontraron clientes</div>';}else{dropdown.innerHTML=filteredClients.map(client=>{const displayQuota=client.diasAtraso>0?client.totalAtraso:client.quota;return`<div class="dropdown-item" onclick="selectClient('${client.id}','${client.name}',${displayQuota||0})"><div class="dropdown-item-name">${client.name}${client.diasAtraso>0?'<span class="debt-badge" style="margin-left:8px;font-size:10px;">En mora</span>':''}</div>${client.phone?`<div class="dropdown-item-phone">${client.phone}</div>`:''}<div style="font-size:12px;color:#1a5490;margin-top:3px;">Sugerido: S/${formatNumber(displayQuota||0)}</div></div>`;}).join('');}}
function selectClient(clientId,clientName,quota){document.getElementById('selectedClientId').value=clientId;document.getElementById('clientSearchModal').value=clientName;hideClientDropdown();const client=clients.find(c=>c.id===clientId);if(!client)return;let montoSugerido=0;if(client.diasAtraso>0){montoSugerido=client.totalAtraso||0;}else{montoSugerido=client.quota||0;}if(selectedPaymentType){if(selectedPaymentType==='parcial'&&montoSugerido>0){document.getElementById('paymentAmountCash').value=montoSugerido;document.getElementById('paymentAmountYape').value=0;updatePaymentTotal();}else if(selectedPaymentType!=='parcial'&&montoSugerido>0){document.getElementById('paymentAmountSingle').value=montoSugerido;}}}
function showModal(modalId){const modal=document.getElementById(modalId);modal.style.display='block';document.body.style.overflow='hidden';requestAnimationFrame(()=>{modal.classList.add('show');});}
function closeModal(modalId){const modal=document.getElementById(modalId);const modalContent=modal.querySelector('.modal-content');modalContent.classList.add('closing');modal.classList.remove('show');setTimeout(()=>{modal.style.display='none';modalContent.classList.remove('closing');},300);document.body.style.overflow='';if(modalId==='addPaymentModal'){document.getElementById('clientSearchModal').value='';document.getElementById('selectedClientId').value='';document.getElementById('paymentAmountSingle').value='';document.getElementById('paymentAmountCash').value='0';document.getElementById('paymentAmountYape').value='0';updatePaymentTotal();hideClientDropdown();selectedPaymentType='';document.querySelectorAll('.payment-type-btn').forEach(btn=>btn.classList.remove('active'));document.getElementById('paymentInputsContainer').style.display='none';}}
function showAddClientModal(){document.getElementById('clientId').value='';document.getElementById('clientName').value='';document.getElementById('clientPhone').value='';document.getElementById('clientDisbursementDate').value='';document.getElementById('clientFrequency').value='';document.getElementById('clientQuota').value='';document.getElementById('clientTerm').value='';showModal('addClientModal');}
function showAddPaymentModal(){if(clients.length===0){alert('Primero debes agregar al menos un cliente');return;}document.getElementById('clientSearchModal').value='';document.getElementById('selectedClientId').value='';document.getElementById('paymentAmountSingle').value='';document.getElementById('paymentAmountCash').value='0';document.getElementById('paymentAmountYape').value='0';document.getElementById('paymentNote').value='';updatePaymentTotal();selectedPaymentType='';document.querySelectorAll('.payment-type-btn').forEach(btn=>btn.classList.remove('active'));document.getElementById('paymentInputsContainer').style.display='none';showModal('addPaymentModal');}
function addClient(event){event.preventDefault();const id=document.getElementById('clientId').value.trim();const name=document.getElementById('clientName').value.trim();const phone=document.getElementById('clientPhone').value.trim();const disbursementDate=document.getElementById('clientDisbursementDate').value;const frequency=document.getElementById('clientFrequency').value;const quota=parseFloat(document.getElementById('clientQuota').value);const term=parseInt(document.getElementById('clientTerm').value);if(clients.find(c=>c.id===id)){alert('Ya existe un cliente con ese ID');return;}const newClient={id:id,name:name,phone:phone,disbursementDate:disbursementDate,frequency:frequency,quota:quota,term:term,createdAt:getPeruvianISOString()};clients.push(newClient);saveData();updateDisplay();closeModal('addClientModal');}
function addPayment(event){event.preventDefault();const clientId=document.getElementById('selectedClientId').value;const note=document.getElementById('paymentNote').value.trim();const date=document.getElementById('dateFilter').value;if(!clientId){alert('Por favor selecciona un cliente de la lista');return;}if(!selectedPaymentType){alert('Por favor selecciona un tipo de pago');return;}let cashAmount=0;let yapeAmount=0;if(selectedPaymentType==='efectivo'){const amount=parseFloat(document.getElementById('paymentAmountSingle').value)||0;if(amount<=0){alert('Por favor ingresa un monto v√°lido');return;}cashAmount=amount;}else if(selectedPaymentType==='yape'){const amount=parseFloat(document.getElementById('paymentAmountSingle').value)||0;if(amount<=0){alert('Por favor ingresa un monto v√°lido');return;}yapeAmount=amount;}else if(selectedPaymentType==='parcial'){cashAmount=parseFloat(document.getElementById('paymentAmountCash').value)||0;yapeAmount=parseFloat(document.getElementById('paymentAmountYape').value)||0;if(cashAmount===0&&yapeAmount===0){alert('Por favor ingresa al menos un monto');return;}}const timestamp=getPeruvianISOString();if(cashAmount>0){const cashPayment={id:Date.now().toString()+'_cash',clientId:clientId,amount:cashAmount,method:'efectivo',note:note+(yapeAmount>0?' (Pago parcial - Efectivo)':''),date:date,timestamp:timestamp};payments.push(cashPayment);}if(yapeAmount>0){const yapePayment={id:Date.now().toString()+'_yape',clientId:clientId,amount:yapeAmount,method:'yape',note:note+(cashAmount>0?' (Pago parcial - Yape)':''),date:date,timestamp:timestamp};payments.push(yapePayment);}saveData();updateDisplay();closeModal('addPaymentModal');}
function deleteClient(clientId,event){if(event)event.stopPropagation();if(confirm('¬øEst√°s seguro de eliminar este cliente? Se mantendr√°n los pagos hist√≥ricos.')){clients=clients.filter(c=>c.id!==clientId);saveData();updateDisplay();}}
function deletePayment(paymentId){if(confirm('¬øEst√°s seguro de eliminar este pago?')){payments=payments.filter(p=>p.id!==paymentId);saveData();updateDisplay();}}
function deletePaymentGroup(timestamp){if(confirm('¬øEst√°s seguro de eliminar este pago?')){payments=payments.filter(p=>p.timestamp!==timestamp);saveData();updateDisplay();}}
document.getElementById('dateFilter').addEventListener('change',updateDisplay);
window.onclick=function(event){if(event.target.classList.contains('modal')){const modalId=event.target.id;closeModal(modalId);}}
let resizeTimer;window.addEventListener('resize',function(){clearTimeout(resizeTimer);resizeTimer=setTimeout(function(){const vh=window.innerHeight*0.01;document.documentElement.style.setProperty('--vh',`${vh}px`);},250);});
function showPaymentSchedule(clientId){const client=clients.find(c=>c.id===clientId);if(!client){alert('Cliente no encontrado');return;}if(!client.disbursementDate){alert('Este cliente no tiene fecha de desembolso registrada. Por favor, edita el cliente y agrega esta informaci√≥n.');return;}if(!client.term||client.term<=0){alert('Este cliente no tiene un plazo v√°lido registrado. Por favor, edita el cliente y agrega esta informaci√≥n.');return;}if(!client.frequency){alert('Este cliente no tiene frecuencia de pago registrada. Por favor, edita el cliente y agrega esta informaci√≥n.');return;}if(!client.quota||client.quota<=0){alert('Este cliente no tiene monto de cuota v√°lido. Por favor, edita el cliente y agrega esta informaci√≥n.');return;}console.log('Generando cronograma para:',client);const clientPayments=payments.filter(p=>p.clientId===clientId);const paymentDates=[];const[year,month,day]=client.disbursementDate.split('-').map(n=>parseInt(n));const startDate=new Date(year,month-1,day);if(isNaN(startDate.getTime())){alert('La fecha de desembolso del cliente no es v√°lida. Por favor, verifica los datos.');return;}let currentDate=new Date(startDate);let paymentCount=0;const maxDays=client.frequency==='MENSUAL'?client.term*31:365;while(paymentCount<client.term&&currentDate<=new Date(startDate.getTime()+(maxDays*24*60*60*1000))){const dateStr=`${currentDate.getFullYear()}-${String(currentDate.getMonth()+1).padStart(2,'0')}-${String(currentDate.getDate()).padStart(2,'0')}`;if(shouldPayOnDate(client,dateStr)){paymentDates.push(new Date(currentDate));paymentCount++;}currentDate.setDate(currentDate.getDate()+1);}if(paymentDates.length===0){alert('No se pudo generar el cronograma. Verifica que la frecuencia y fecha de desembolso sean correctas.');return;}let scheduleHTML=`<div style="margin-bottom:20px;"><h4 style="margin:0;">Cliente: ${client.name}</h4><p style="margin:5px 0;color:#666;">ID: ${client.id}</p><p style="margin:5px 0;color:#666;">Frecuencia: ${client.frequency} | Plazo: ${formatInteger(client.term)} cuotas | Cuota: S/${formatNumber(client.quota)}</p></div><table class="schedule-table"><thead><tr><th>N¬∞</th><th>F. Pago</th><th>Monto</th><th>Estado</th></tr></thead><tbody>`;const today=getPeruvianDateString();const totalPagadoReal=clientPayments.reduce((sum,p)=>sum+p.amount,0);let saldoDisponible=totalPagadoReal;paymentDates.forEach((date,index)=>{const dateStr=date.toISOString().split('T')[0];const formattedDate=formatPeruvianDate(dateStr);let statusIcon='';let statusClass='';if(saldoDisponible>=client.quota){statusIcon='<span class="check-icon">‚úì</span>';statusClass='paid';saldoDisponible-=client.quota;}else if(saldoDisponible>0){const porcentaje=Math.round((saldoDisponible/client.quota)*100);statusIcon=`<span class="partial-icon">${porcentaje}%</span>`;statusClass='partial';saldoDisponible=0;}else if(dateStr<today){statusIcon='<span style="color:#dc3545;">‚úó</span>';statusClass='pending';}else if(dateStr===today){statusIcon='<span style="color:#f39c12;">‚è∞</span>';statusClass='pending';}else{statusIcon='<span style="color:#999;">‚óã</span>';statusClass='future';}scheduleHTML+=`<tr class="${statusClass}"><td>${index+1}</td><td>${formattedDate}</td><td>S/${formatNumber(client.quota)}</td><td style="text-align:center;">${statusIcon}</td></tr>`;});const totalEsperado=client.quota*client.term;const saldoPendiente=totalEsperado-totalPagadoReal;scheduleHTML+=`</tbody></table><div style="margin-top:20px;padding:15px;background:#f8f9fa;border-radius:8px;"><div style="display:flex;justify-content:space-between;margin-bottom:8px;"><strong>Total esperado:</strong><span>S/${formatNumber(totalEsperado)}</span></div><div style="display:flex;justify-content:space-between;margin-bottom:8px;"><strong>Total pagado:</strong><span style="color:#28a745;">S/${formatNumber(totalPagadoReal)}</span></div><div style="display:flex;justify-content:space-between;"><strong>Saldo pendiente:</strong><span style="color:#dc3545;">S/${formatNumber(saldoPendiente)}</span></div></div>`;document.getElementById('scheduleModalContent').innerHTML=scheduleHTML;showModal('scheduleModal');}
function showEditClientModal(clientId){const client=clients.find(c=>c.id===clientId);if(!client)return;document.getElementById('editClientId').value=client.id;document.getElementById('editClientName').value=client.name;document.getElementById('editClientPhone').value=client.phone||'';document.getElementById('editClientDisbursementDate').value=client.disbursementDate||'';document.getElementById('editClientFrequency').value=client.frequency||'';document.getElementById('editClientQuota').value=client.quota||'';document.getElementById('editClientTerm').value=client.term||'';showModal('editClientModal');}
function updateClient(event){event.preventDefault();const clientId=document.getElementById('editClientId').value;const client=clients.find(c=>c.id===clientId);if(!client)return;client.name=document.getElementById('editClientName').value.trim();client.phone=document.getElementById('editClientPhone').value.trim();client.disbursementDate=document.getElementById('editClientDisbursementDate').value;client.frequency=document.getElementById('editClientFrequency').value;client.quota=parseFloat(document.getElementById('editClientQuota').value);client.term=parseInt(document.getElementById('editClientTerm').value);saveData();updateDisplay();closeModal('editClientModal');alert('Cliente actualizado exitosamente');}
function quickPayment(clientId){const client=clients.find(c=>c.id===clientId);if(!client)return;const displayQuota=client.diasAtraso>0?client.totalAtraso:client.quota;showAddPaymentModal();setTimeout(()=>{document.getElementById('clientSearchModal').value=client.name;document.getElementById('selectedClientId').value=client.id;document.getElementById('paymentNote').value='Pago r√°pido';},100);}
function quickPaymentDebt(clientId){const client=clients.find(c=>c.id===clientId);if(!client)return;showAddPaymentModal();setTimeout(()=>{document.getElementById('clientSearchModal').value=client.name;document.getElementById('selectedClientId').value=client.id;document.getElementById('paymentNote').value='Pago de mora';},100);}
function showMorosidadModal(){const debtClients=clients.filter(c=>c.diasAtraso>0);if(debtClients.length===0){alert('No hay clientes en mora actualmente');return;}const totalMora=debtClients.reduce((sum,c)=>sum+(c.mora||0),0);const totalAtraso=debtClients.reduce((sum,c)=>sum+(c.totalAtraso||0),0);let modalHTML=`<div class="morosidad-stats"><div class="morosidad-stat"><div class="morosidad-stat-value">${formatInteger(debtClients.length)}</div><div class="morosidad-stat-label">Clientes en Mora</div></div><div class="morosidad-stat"><div class="morosidad-stat-value">S/${formatNumber(totalAtraso)}</div><div class="morosidad-stat-label">Total Atraso</div></div></div><table class="morosidad-table"><thead><tr><th>ID</th><th>Nombre</th><th>Monto</th><th>Plazo</th><th>Frec. Pago</th><th>Mora</th><th>Total Atraso</th><th>Total Deuda</th><th>Acciones</th></tr></thead><tbody>`;debtClients.sort((a,b)=>b.diasAtraso-a.diasAtraso).forEach(client=>{const clientPayments=payments.filter(p=>p.clientId===client.id);const totalPaid=clientPayments.reduce((sum,p)=>sum+p.amount,0);const totalDeuda=client.totalDeuda||(client.quota||0)*(client.term||0)-totalPaid;modalHTML+=`<tr style="cursor:pointer;"><td>${client.id}</td><td>${client.name}</td><td>S/${formatNumber(client.monto||0)}</td><td>${client.term||0}</td><td>${client.frequency||'N/A'}</td><td style="color:#dc3545;">S/${formatNumber(client.mora||0)}</td><td style="color:#dc3545;font-weight:bold;">S/${formatNumber(client.totalAtraso||0)}</td><td style="color:#dc3545;">S/${formatNumber(totalDeuda)}</td><td style="text-align:center;">${client.phone?`<button class="btn-circle btn-call" onclick="event.stopPropagation();makeCall('${client.phone}');" title="Llamar" style="margin-right:5px;">üìû</button><button class="btn-circle btn-whatsapp" onclick="event.stopPropagation();openWhatsApp('${client.phone}');" title="WhatsApp">üì±</button>`:'Sin tel√©fono'}</td></tr>`;});modalHTML+=`</tbody></table>`;document.getElementById('morosidadModalContent').innerHTML=modalHTML;showModal('morosidadModal');}
function deleteAllClients(){
    if(clients.length === 0){
        alert('No hay clientes para eliminar');
        return;
    }
    
    const clientCount = clients.length;
    const paymentCount = payments.length;
    
    // Primera confirmaci√≥n
    if(!confirm(`‚ö†Ô∏è ADVERTENCIA: Esta acci√≥n eliminar√° ${clientCount} clientes.\n\nSe mantendr√°n ${paymentCount} pagos en el historial.\n\n¬øEst√°s seguro de continuar?`)){
        return;
    }
    
    // Segunda confirmaci√≥n para mayor seguridad
    if(!confirm('‚ö†Ô∏è √öLTIMA CONFIRMACI√ìN:\n\n¬øRealmente deseas eliminar TODOS los clientes?\n\nEsta acci√≥n no se puede deshacer.')){
        return;
    }
    
    // Eliminar todos los clientes
    clients = [];
    
    // Guardar datos
    saveData();
    
    // Actualizar visualizaci√≥n
    updateDisplay();
    
    // Mensaje de confirmaci√≥n
    alert(`‚úÖ Se eliminaron ${clientCount} clientes exitosamente.\n\nSe mantuvieron ${paymentCount} pagos en el historial.`);
}
function installPWA(){if(deferredPrompt){deferredPrompt.prompt();deferredPrompt.userChoice.then((choiceResult)=>{if(choiceResult.outcome==='accepted'){console.log('PWA instalada');}deferredPrompt=null;document.getElementById('installBanner').classList.remove('show');});}}
if('serviceWorker' in navigator){window.addEventListener('load',function(){navigator.serviceWorker.register('/service-worker.js').then(function(registration){console.log('ServiceWorker registrado con √©xito:',registration.scope);},function(err){console.log('ServiceWorker fall√≥ al registrar:',err);});});}
const urlParams=new URLSearchParams(window.location.search);const action=urlParams.get('action');if(action==='add-client'){setTimeout(()=>showAddClientModal(),500);}else if(action==='add-payment'){setTimeout(()=>showAddPaymentModal(),500);}
window.addEventListener('beforeinstallprompt',(e)=>{e.preventDefault();deferredPrompt=e;setTimeout(()=>{if(!localStorage.getItem('pwaInstallPromptShown')){document.getElementById('installBanner').classList.add('show');localStorage.setItem('pwaInstallPromptShown','true');}},2000);});
init();
</script>
</body>
</html>
